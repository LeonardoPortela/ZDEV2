FUNCTION ZBAPI_BILLINGDOC_CANCEL1.
*"----------------------------------------------------------------------
*"*"Interface local:
*"  IMPORTING
*"     VALUE(BILLINGDOCUMENT) LIKE  BAPIVBRKSUCCESS-BILL_DOC
*"     VALUE(TESTRUN) LIKE  BAPIVBRKTESTRUN-TESTRUN OPTIONAL
*"     VALUE(NO_COMMIT) TYPE  BAPI_NCOMT OPTIONAL
*"     VALUE(BILLINGDATE) TYPE  BF_DATM1EB OPTIONAL
*"  TABLES
*"      RETURN STRUCTURE  BAPIRETURN1
*"      SUCCESS STRUCTURE  BAPIVBRKSUCCESS
*"----------------------------------------------------------------------

  DATA: WL_VBRK_I TYPE VBRK,
        WL_VBRK_E	LIKE VBRK,
        WL_VBUK_E	LIKE VBUK.

  DATA: GT_XKOMV  TYPE TABLE OF KOMV,
        GT_XVBPA  TYPE TABLE OF VBPAVB,
        GT_XVBRK  TYPE TABLE OF VBRKVB,
        GT_XVBRP  TYPE TABLE OF VBRPVB,
        GT_XKOMFK TYPE TABLE OF KOMFK,
        GT_XVBFS  TYPE TABLE OF VBFS,
        GT_XTHEAD TYPE TABLE OF THEADVB,
        GT_XVBSS  TYPE TABLE OF VBSS.

  DATA: LVA_ACTION_VF TYPE SY-TCODE.

  DATA:  E_STATUS(1),
         E_MESSA(64).


  REFRESH: GT_XKOMV, GT_XVBPA, GT_XVBRK, GT_XVBRP, GT_XKOMFK, GT_XVBFS, GT_XTHEAD, GT_XVBSS.

  CLEAR: WL_VBRK_I, WL_VBRK_E, WL_VBUK_E.

  SELECT SINGLE *
    FROM VBRK INTO WL_VBRK_I
   WHERE VBELN = BILLINGDOCUMENT.

  CHECK SY-SUBRC = 0.


  CALL FUNCTION 'Z_CONTROLE_FECHAMES'
    EXPORTING
      I_BUKRS  = WL_VBRK_I-BUKRS
      I_DATA   = WL_VBRK_I-FKDAT
    IMPORTING
      E_STATUS = E_STATUS
      E_MESSA  = E_MESSA
    EXCEPTIONS
      ERROR    = 1
      OTHERS   = 2.

  IF SY-SUBRC <> 0.
*     MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO
*             WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
  ENDIF.
  IF  E_STATUS = 'E'.
    MESSAGE E000(Z01) WITH E_MESSA.
  ENDIF.


  CALL FUNCTION 'RV_INVOICE_DOCUMENT_READ'
    EXPORTING
      VBRK_I = WL_VBRK_I
    IMPORTING
      VBRK_E = WL_VBRK_E
      VBUK_E = WL_VBUK_E
    TABLES
      XKOMFK = GT_XKOMFK
      XKOMV  = GT_XKOMV
      XTHEAD = GT_XTHEAD
      XVBFS  = GT_XVBFS
      XVBPA  = GT_XVBPA
      XVBRK  = GT_XVBRK
      XVBRP  = GT_XVBRP
      XVBSS  = GT_XVBSS.

  CALL FUNCTION 'RV_INVOICE_REFRESH'
    EXPORTING
      WITH_POSTING = 'B'
    TABLES
      XKOMFK       = GT_XKOMFK
      XKOMV        = GT_XKOMV
      XTHEAD       = GT_XTHEAD
      XVBFS        = GT_XVBFS
      XVBPA        = GT_XVBPA
      XVBRK        = GT_XVBRK
      XVBRP        = GT_XVBRP
      XVBSS        = GT_XVBSS
    EXCEPTIONS
      OTHERS       = 0.

  LVA_ACTION_VF = 'CANCEL'.
  EXPORT LVA_ACTION_VF TO MEMORY ID 'ZACTION_VF'.

  CALL FUNCTION 'BAPI_BILLINGDOC_CANCEL1'
    EXPORTING
      BILLINGDOCUMENT = BILLINGDOCUMENT
      TESTRUN         = TESTRUN
      NO_COMMIT       = NO_COMMIT
      BILLINGDATE     = BILLINGDATE
    TABLES
      RETURN          = RETURN
      SUCCESS         = SUCCESS.

ENDFUNCTION.
