*&---------------------------------------------------------------------*
*& Report ZFIR0115
*&---------------------------------------------------------------------*
*&
*&---------------------------------------------------------------------*
REPORT ZFIR0115.

TABLES: ZFIT0216,T001W.

DATA: LR_WERKS         TYPE RANGE OF WERKS.

SELECTION-SCREEN BEGIN OF BLOCK PART1 WITH FRAME TITLE TEXT-001 .
  SELECT-OPTIONS:
                  P_WERKS   FOR T001W-WERKS OBLIGATORY,
                  P_GJAHR FOR ZFIT0216-GJAHR NO-EXTENSION NO INTERVALS MATCHCODE OBJECT ZYEAR OBLIGATORY,
                  P_MONAT FOR ZFIT0216-MONAT NO-EXTENSION NO INTERVALS MATCHCODE OBJECT Z_HELP_MESES OBLIGATORY.
SELECTION-SCREEN END OF BLOCK PART1.

SELECTION-SCREEN BEGIN OF BLOCK PART2 WITH FRAME TITLE TEXT-002 .
  PARAMETERS: R1 RADIOBUTTON GROUP RAD1 DEFAULT 'X', "Lançamentos
              R2 RADIOBUTTON GROUP RAD1. "Saldo
SELECTION-SCREEN END OF BLOCK PART2.

START-OF-SELECTION.

  FREE: LR_WERKS.

  DATA: LR_UNIDADES TYPE RANGE OF BUKRS INITIAL SIZE 0.

  SELECT DISTINCT
      'I'   AS SIGN,
      'EQ'  AS OPTION,
      WERKS AS LOW,
      WERKS AS HIGH
    FROM T001W
  WHERE WERKS IN @P_WERKS
    INTO TABLE @LR_WERKS.

  MOVE-CORRESPONDING LR_WERKS TO LR_UNIDADES.

  SORT LR_UNIDADES.

  DELETE ADJACENT DUPLICATES FROM LR_UNIDADES.

  IF LR_UNIDADES IS NOT INITIAL.

    TYPES: BEGIN OF TY_UNIDADES_CAD,
             UNIDADE TYPE BUKRS,
           END OF TY_UNIDADES_CAD.

    DATA: IT_PARAMTERS    TYPE  USTYP_T_PARAMETERS,
          IT_UNIDADES_CAD TYPE STANDARD TABLE OF TY_UNIDADES_CAD INITIAL SIZE 0,
          WA_UNIDADES_CAD TYPE TY_UNIDADES_CAD,
          P_AUTORIZACAO   TYPE BOOLEAN.

    CALL FUNCTION 'SUSR_USER_PARAMETERS_GET'
      EXPORTING
        USER_NAME       = SY-UNAME
      TABLES
        USER_PARAMETERS = IT_PARAMTERS.

    IF SY-SUBRC = 0.
      READ TABLE IT_PARAMTERS ASSIGNING FIELD-SYMBOL(<_GET_PARAM>) WITH KEY PARID = 'Z_GESTAO_FFIXO' .
      IF SY-SUBRC = 0 AND <_GET_PARAM>-PARVA IS NOT INITIAL.
        SEARCH <_GET_PARAM>-PARVA FOR ','.
        IF SY-SUBRC = 0.
          SPLIT <_GET_PARAM>-PARVA AT ',' INTO TABLE IT_UNIDADES_CAD.
        ELSE.
          IF <_GET_PARAM>-PARVA = '*'.
            SELECT DISTINCT WERKS FROM T001W INTO TABLE @IT_UNIDADES_CAD.
          ELSE.
            WA_UNIDADES_CAD = <_GET_PARAM>-PARVA.
            APPEND WA_UNIDADES_CAD TO IT_UNIDADES_CAD.
          ENDIF.
        ENDIF.

      ENDIF.

      IF IT_UNIDADES_CAD IS NOT INITIAL.

        LOOP AT IT_UNIDADES_CAD INTO WA_UNIDADES_CAD WHERE UNIDADE IN LR_UNIDADES.
          P_AUTORIZACAO = ABAP_TRUE.
          EXIT.
        ENDLOOP.
      ENDIF.

      IF P_AUTORIZACAO IS NOT INITIAL.

        IF R1 IS NOT INITIAL.

          SUBMIT ZFIR0121
            WITH P_WERKS IN P_WERKS
            WITH P_GJAHR IN P_GJAHR
            WITH P_MONAT IN P_MONAT
          AND RETURN.

        ELSEIF R2 IS NOT INITIAL.

          SUBMIT ZFIR0120
            WITH P_WERKS IN P_WERKS
            WITH P_GJAHR IN P_GJAHR
            WITH P_MONAT IN P_MONAT
          AND RETURN.

        ENDIF.
      ELSE.
        MESSAGE 'Usuário não tem autorização para essa transação!' TYPE 'I'.
      ENDIF.

    ENDIF.

  ENDIF.
