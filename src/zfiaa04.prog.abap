REPORT ZFIAA04.

DATA: IT_0046     TYPE TABLE OF ZFIT0046,
      IT_0045     TYPE TABLE OF ZFIT0045,
      IT_ANLA     TYPE TABLE OF ANLA,
      WA_0046     TYPE ZFIT0046,
      WA_0045     TYPE ZFIT0045,
      WA_ANLA     TYPE ANLA,
      TL_RETURN   TYPE TABLE OF BAPIRET2 WITH HEADER LINE,
      WA_TDD      TYPE BAPI1022_FEGLG003,
      WA_TDDX     TYPE BAPI1022_FEGLG003X,
      COMPANYCODE LIKE BAPI1022_1-COMP_CODE,
      ASSET       LIKE BAPI1022_1-ASSETMAINO,
      SUBNUMBER   LIKE BAPI1022_1-ASSETSUBNO.

SELECT * FROM ZFIT0046
    INTO TABLE IT_0046
      WHERE ANLN1 NE ABAP_FALSE
  AND INCORP_IMOB NE ABAP_TRUE.

CHECK NOT IT_0046 IS INITIAL.

SELECT * FROM ZFIT0045
    INTO TABLE IT_0045
      FOR ALL ENTRIES IN IT_0046
        WHERE NRO_SOL EQ IT_0046-NRO_SOL
            AND EBELN EQ IT_0046-EBELN.

CHECK NOT IT_0045 IS INITIAL.

SELECT * FROM ANLA
  INTO TABLE IT_ANLA
  FOR ALL ENTRIES IN IT_0046
    WHERE ANLN1 EQ IT_0046-ANLN1
      AND ANLN2 EQ IT_0046-ANLN2.

LOOP AT IT_0045 INTO WA_0045.
  READ TABLE IT_ANLA TRANSPORTING NO FIELDS WITH KEY BUKRS = WA_0045-BUKRS.
  IF NOT SY-SUBRC IS INITIAL.
    DELETE IT_ANLA WHERE BUKRS NE WA_0045-BUKRS.
  ENDIF.
ENDLOOP.

SORT IT_0046 BY ANLN1 ANLN2.
SORT IT_ANLA BY BUKRS ANLN1 ANLN2.

LOOP AT IT_0046 INTO WA_0046.

  READ TABLE IT_ANLA INTO WA_ANLA WITH KEY ANLN1 = WA_0046-ANLN1
                                           ANLN2 = WA_0046-ANLN2 BINARY SEARCH.

  COMPANYCODE    = WA_ANLA-BUKRS.
  ASSET          = WA_0046-ANLN1.
  SUBNUMBER      = WA_0046-ANLN2.

  IF WA_0046-PARAL_IMOB EQ ABAP_FALSE.

    WA_TDD-SHUTDOWN  = ABAP_TRUE.
    WA_TDDX-SHUTDOWN = ABAP_TRUE.

    CALL FUNCTION 'BAPI_FIXEDASSET_CHANGE'
      EXPORTING
        COMPANYCODE        = COMPANYCODE
        ASSET              = ASSET
        SUBNUMBER          = SUBNUMBER
        TIMEDEPENDENTDATA  = WA_TDD
        TIMEDEPENDENTDATAX = WA_TDDX
      IMPORTING
        RETURN             = TL_RETURN.

    READ TABLE TL_RETURN WITH KEY TYPE = 'E'.
    IF SY-SUBRC NE 0.
      CALL FUNCTION 'BAPI_TRANSACTION_COMMIT'
        EXPORTING
          WAIT = ABAP_TRUE.

      UPDATE ZFIT0046 SET PARAL_IMOB = ABAP_TRUE
                      WHERE NRO_SOL EQ WA_0046-NRO_SOL
                        AND EBELN   EQ WA_0046-EBELN
                        AND EBELP   EQ WA_0046-EBELP.
    ENDIF.

  ELSEIF WA_0046-INCORP_IMOB EQ ABAP_FALSE.

    IF NOT WA_ANLA-AKTIV IS INITIAL.

      WA_TDD-SHUTDOWN  = ABAP_FALSE.
      WA_TDDX-SHUTDOWN = ABAP_TRUE.

      CALL FUNCTION 'BAPI_FIXEDASSET_CHANGE'
        EXPORTING
          COMPANYCODE        = COMPANYCODE
          ASSET              = ASSET
          SUBNUMBER          = SUBNUMBER
          TIMEDEPENDENTDATA  = WA_TDD
          TIMEDEPENDENTDATAX = WA_TDDX
        IMPORTING
          RETURN             = TL_RETURN.

      READ TABLE TL_RETURN WITH KEY TYPE = 'E'.
      IF SY-SUBRC NE 0.
        CALL FUNCTION 'BAPI_TRANSACTION_COMMIT'
          EXPORTING
            WAIT = ABAP_TRUE.

        UPDATE ZFIT0046 SET INCORP_IMOB = ABAP_TRUE
                        WHERE NRO_SOL EQ WA_0046-NRO_SOL
                          AND EBELN   EQ WA_0046-EBELN
                          AND EBELP   EQ WA_0046-EBELP.

      ENDIF.

    ENDIF.
  ENDIF.

ENDLOOP.
