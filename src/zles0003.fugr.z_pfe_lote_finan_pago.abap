FUNCTION Z_PFE_LOTE_FINAN_PAGO.
*"----------------------------------------------------------------------
*"*"Interface local:
*"  IMPORTING
*"     REFERENCE(P_NM_LOTE) TYPE  ZPFE_NUMERO_LOTE
*"     REFERENCE(PESQUISAR) TYPE  C DEFAULT SPACE
*"  EXPORTING
*"     VALUE(WA_ZPFE_LOTE) TYPE  ZPFE_LOTE
*"     VALUE(WA_ZPFE_LOTE_ALV) TYPE  ZPFE_LOTE_ALV
*"  CHANGING
*"     REFERENCE(NR_DOC_COMPENSACAO) TYPE  AUGBL OPTIONAL
*"     REFERENCE(DT_DOC_COMPENSACAO) TYPE  AUGDT OPTIONAL
*"  EXCEPTIONS
*"      SEM_LOTE
*"      SEM_FINANCEIRO
*"      SEM_BKPF
*"      BKPF_ESTORNADA
*"      FINANCEIRO_NAO_PAGO
*"----------------------------------------------------------------------

  DATA: IT_LOTES     TYPE TABLE OF ZPFE_LOTE,
        IT_LOTES_ALV TYPE TABLE OF ZPFE_LOTE_ALV,
        WA_BKPF      TYPE BKPF,
        IT_BSIK      TYPE TABLE OF BSIK,
        IT_BSAK      TYPE TABLE OF BSAK,
        WA_BSAK      TYPE BSAK,
        PNRLOTE      TYPE LXHME_RANGE_C10_T WITH HEADER LINE.

  SELECT SINGLE * INTO WA_ZPFE_LOTE
    FROM ZPFE_LOTE
   WHERE NM_LOTE EQ P_NM_LOTE.

  IF NOT SY-SUBRC IS INITIAL.
    MESSAGE E013 WITH P_NM_LOTE RAISING SEM_LOTE.
  ENDIF.

  IF WA_ZPFE_LOTE-BELNR IS INITIAL.
    MESSAGE E021 WITH P_NM_LOTE RAISING SEM_FINANCEIRO.
  ENDIF.

  SELECT SINGLE * INTO WA_BKPF
    FROM BKPF
   WHERE GJAHR EQ WA_ZPFE_LOTE-GJAHR
     AND BUKRS EQ WA_ZPFE_LOTE-BUKRS
     AND BELNR EQ WA_ZPFE_LOTE-BELNR.

  IF NOT SY-SUBRC IS INITIAL.
    MESSAGE E022 WITH WA_ZPFE_LOTE-BELNR P_NM_LOTE RAISING SEM_BKPF.
  ENDIF.

  IF NOT WA_BKPF-STBLG IS INITIAL.
    MESSAGE E022 WITH WA_ZPFE_LOTE-BELNR P_NM_LOTE WA_BKPF-STBLG RAISING BKPF_ESTORNADA.
  ENDIF.

  SELECT * INTO TABLE IT_BSAK
    FROM BSAK
   WHERE GJAHR EQ WA_ZPFE_LOTE-GJAHR
     AND BUKRS EQ WA_ZPFE_LOTE-BUKRS
     AND BELNR EQ WA_ZPFE_LOTE-BELNR
     AND SHKZG EQ 'H'.

  IF NOT SY-SUBRC IS INITIAL.
    MESSAGE E024 WITH WA_ZPFE_LOTE-BELNR P_NM_LOTE RAISING FINANCEIRO_NAO_PAGO.
  ENDIF.

*  READ TABLE it_bsak INTO wa_bsak INDEX 1.
*  nr_doc_compensacao    = wa_bsak-augbl.
*  DT_DOC_COMPENSACAO    = wa_bsak-augdt.
*  wa_zpfe_lote-augbl    = wa_bsak-augbl.
*  wa_zpfe_lote-augdt    = wa_bsak-augdt.
*  MODIFY zpfe_lote FROM wa_zpfe_lote.

  IF PESQUISAR EQ 'X'.
    PNRLOTE-SIGN    = 'I'.
    PNRLOTE-OPTION  = 'EQ'.
    PNRLOTE-LOW     = WA_ZPFE_LOTE-NM_LOTE.
    PNRLOTE-HIGH    = WA_ZPFE_LOTE-NM_LOTE.
    APPEND PNRLOTE.

    CALL FUNCTION 'Z_PFE_PSQ_LOTE'
      EXPORTING
        PNRLOTE      = PNRLOTE[]
      TABLES
        IT_LOTES     = IT_LOTES
        IT_LOTES_ALV = IT_LOTES_ALV.

    READ TABLE IT_LOTES     INTO WA_ZPFE_LOTE INDEX 1.
    READ TABLE IT_LOTES_ALV INTO WA_ZPFE_LOTE_ALV INDEX 1.
  ENDIF.
  READ TABLE IT_BSAK INTO WA_BSAK INDEX 1.
  WA_ZPFE_LOTE-AUGBL = WA_ZPFE_LOTE_ALV-AUGBL = NR_DOC_COMPENSACAO  = WA_BSAK-AUGBL.
  WA_ZPFE_LOTE-AUGDT = WA_ZPFE_LOTE_ALV-AUGDT = DT_DOC_COMPENSACAO  = WA_BSAK-AUGDT.


ENDFUNCTION.
