*----------------------------------------------------------------------*
*   INCLUDE HBRCVT03            " Main program
*----------------------------------------------------------------------*
*Last changes: macro call RP-SET-NAME-FORMAT replaced by function call
*RP_SET_NAME_FORMAT.
*Last modified: 01.11.1999
*Last modified by: Mario Sancho Graca

*{ Selection Screen
*SELECTION-SCREEN BEGIN OF BLOCK FRM1 WITH FRAME TITLE TEXT-001.
*SELECTION-SCREEN BEGIN OF LINE.
*SELECTION-SCREEN COMMENT 1(31) TEXT-003 for field list.
*PARAMETERS: LIST RADIOBUTTON GROUP MOD.
*SELECTION-SCREEN END OF LINE.
*SELECTION-SCREEN BEGIN OF LINE.
*SELECTION-SCREEN COMMENT 1(31) TEXT-002 for field tree.
*PARAMETERS: TREE RADIOBUTTON GROUP MOD.
*SELECTION-SCREEN END OF LINE.
*SELECTION-SCREEN END   OF BLOCK FRM1.


* Asmitidos no mês
SELECTION-SCREEN BEGIN OF BLOCK FRM4 WITH FRAME TITLE TEXT-040.
SELECTION-SCREEN BEGIN OF LINE.
SELECTION-SCREEN COMMENT 1(31) TEXT-041 for field mes.
PARAMETERS: MES RADIOBUTTON GROUP MO1.
SELECTION-SCREEN END OF LINE.
SELECTION-SCREEN BEGIN OF LINE.
SELECTION-SCREEN COMMENT 1(31) TEXT-042 for field adm.
PARAMETERS: ADM RADIOBUTTON GROUP MO1.
SELECTION-SCREEN END OF LINE.
SELECTION-SCREEN END   OF BLOCK FRM4.


"selection-screen begin of block frm2 with frame title text-035.
"*select-options: absences for p2001-subty.
"select-options: absences for hbrxxxx0-subty.
"selection-screen end   of block frm2.


SELECTION-SCREEN BEGIN OF BLOCK FRM3 WITH FRAME TITLE TEXT-008.
SELECTION-SCREEN BEGIN OF LINE.
SELECTION-SCREEN COMMENT 1(45) TEXT-009 for field bti_15.
*PARAMETERS: BTI_15 LIKE RPCALCX0-TST_ON VALUE CHECK DEFAULT ' '.
PARAMETERS: BTI_15 LIKE hbrxxxx0-updat VALUE CHECK DEFAULT ' '.
SELECTION-SCREEN END OF LINE.
PARAMETERS: BATNAME TYPE HBRXXXX0-MAPN DEFAULT SY-UNAME.
SELECTION-SCREEN END   OF BLOCK FRM3.
*}

SELECTION-SCREEN BEGIN OF BLOCK FRM5 WITH FRAME TITLE text-FM5.

PARAMETERS  pa_path   TYPE localfile.

SELECTION-SCREEN END OF BLOCK FRM5.

AT SELECTION-SCREEN ON VALUE-REQUEST FOR pa_path.
  PERFORM zf_get_path CHANGING pa_path.


*AT SELECTION-SCREEN OUTPUT.
*LOOP AT SCREEN.
*  IF SCREEN-NAME = 'PNPBUKRS-LOW'.
*    PNPBUKRS-LOW = '0048'.
*    MODIFY SCREEN.
*  ENDIF.
*
*ENDLOOP.

AT SELECTION-SCREEN OUTPUT.

  DATA L_BUKRS TYPE BUKRS.
  DATA L_BEGDA TYPE BEGDA.
  DATA L_ENDDA TYPE ENDDA.

  PERFORM GET_TVARVC CHANGING L_BUKRS.

  PNPBUKRS-LOW = L_BUKRS.
  PNPBUKRS-SIGN = 'I'.
  PNPBUKRS-OPTION = 'EQ'.
  COLLECT PNPBUKRS.

  L_BEGDA = |{ SY-DATUM(6) }01|.

  CALL FUNCTION 'HR_HCP_GET_LAST_DAY_OF_MONTH'
    EXPORTING
      IM_DATE                =  L_BEGDA
    IMPORTING
      EX_LAST_DAY_OF_MONTH   = L_BEGDA.

  L_BEGDA = L_BEGDA + 1.

  CALL FUNCTION 'HR_HCP_GET_LAST_DAY_OF_MONTH'
    EXPORTING
      IM_DATE                =  L_BEGDA
    IMPORTING
      EX_LAST_DAY_OF_MONTH   = L_ENDDA.

  PNPBEGDA = L_BEGDA.

  PNPENDDA = L_ENDDA.




*{ Main Program
START-OF-SELECTION.
* Array fetch
  PERFORM PROGRESS_INDICATOR USING 'Inicialização'(004).
  PERFORM INIT.

  DATA CHK_DTINI TYPE DATUM.
  DATA CHK_DTFIM TYPE DATUM.


  IF MES EQ 'X'.
    if pn-begda+6(02) ne '01'.
      MESSAGE 'O periodo deve ser mensal!' TYPE 'I' DISPLAY LIKE 'E'.
      EXIT.
    elseif pn-begda+4(02) ne pn-endda+4(02).
      MESSAGE 'O periodo deve ser mensal!' TYPE 'I' DISPLAY LIKE 'E'.
      EXIT.
    else.
      pn-endda = pn-endda + 1.
      if pn-begda+4(02) eq pn-endda+4(02).
        MESSAGE 'O periodo deve ser mensal!' TYPE 'I' DISPLAY LIKE 'E'.
        EXIT.
      else.
        pn-endda = pn-endda - 1.
      endif.

    endif.

  ENDIF.



PROGRAMME_NAME = SY-REPID.
CALL FUNCTION 'RP_SET_NAME_FORMAT'
EXPORTING REPID = PROGRAMME_NAME
IMPORTING FORMAT = EMPLOYEE_NAME_FORMAT.

*  vt_program = sy-repid.          "for 'REUSE_ALV_LIST_DISPLAY
  CLEAR TOTAL. REFRESH TOTAL.

  PERFORM GET_TVARVC CHANGING G_BUKRS.






GET PERNR.

  CLEAR l_hire_date.
  CLEAR l_fire_date.

  LOOP AT P0001 WHERE BEGDA LE PN-ENDDA AND ENDDA GE PN-BEGDA.
  ENDLOOP.

  LOOP AT P0002 WHERE BEGDA LE PN-ENDDA AND ENDDA GE PN-BEGDA..
  ENDLOOP.

  LOOP AT P0000 WHERE BEGDA LE PN-ENDDA AND ENDDA GE PN-BEGDA..
  ENDLOOP.



  PERFORM verify_hire_fire USING pernr-pernr
                                 pn-begda
                                 pn-endda
                      CHANGING l_hire_date
                               l_fire_date.

  IF ADM EQ 'X'.

    IF l_hire_date LT pn-begda or l_hire_date GT pn-endda.
      REJECT.
    ENDIF.

    IF P0001-BUKRS NE G_BUKRS.
      REJECT.
    ENDIF.

    IF P0000-MASSN NE '02' AND P0000-MASSN NE '20' AND P0000-MASSN NE 'ZL'.
      REJECT.
    ENDIF.

  ELSE.
    IF l_hire_date GE pn-begda AND l_hire_date LE pn-endda.
      REJECT.
    ENDIF.
  ENDIF.


  IF ( NOT l_fire_date IS INITIAL AND l_fire_date LT pn-begda ).
    REJECT.
  ENDIF.



  ADD 1 TO TOTAL-SELE.
  PERFORM PROGRESS_INDICATOR USING 'Seleção de dados'(005).
  PERFORM COLLECT_STEP_1.
  IF NOT W_P0410_VALID IS INITIAL.
    PERFORM COLLECT_STEP_2.
  ENDIF.

  ADD 1 TO TOTAL-PROC.

END-OF-SELECTION.
  PERFORM UPDATE_INFOTYPE15.

 IF NOT bti_15 IS INITIAL.
*** Preparação dos layouts
  PERFORM ZF_FILL_FILE_CITY.
  PERFORM ZF_FILL_FILE_BR.
  PERFORM ZF_FILL_FILE_PIR.
 ENDIF.
*** Download
  PERFORM ZF_DOWNLOAD_FILE_CITY USING pa_path.
  PERFORM ZF_DOWNLOAD_FILE_BR   USING pa_path.
  PERFORM ZF_DOWNLOAD_FILE_PIR  USING pa_path.

"  CASE P_MODE.
"    WHEN '1'.
"      PERFORM REICON USING 'ICON_DATE'.
"      PERFORM FILL_TREE_WA USING 1 'Vale Transporte'(006) 30 1
"                                   W_ICON    4
"                                   PN-BEGDA  10
"                                   '-'       1
"                                   PN-ENDDA  10.
"      PERFORM FILL_TREE_PERSON.
"    WHEN '2'.
      PERFORM CREATE_FIELDCAT.
      PERFORM MODIFY_FIELDCAT.
      PERFORM FILL_ALV_TAB.
"  ENDCASE.

  PERFORM PROGRESS_INDICATOR USING 'Preparação da lista de saída'(007).
"  CASE P_MODE.
"    WHEN '1'.
"      PERFORM DISPLAY_TREE.
"    WHEN '2'.
      PERFORM DISPLAY_LIST.
"  ENDCASE.

NEW-PAGE.
  PERFORM PRINT_ERROR_LIST.

  REJECTED = TOTAL-SELE - TOTAL-PROC.
  PERFORM CATT_MESSAGE(HBRCATT0) USING TOTAL-SELE REJECTED.

*} End of Main Program
