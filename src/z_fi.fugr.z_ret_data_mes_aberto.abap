FUNCTION Z_RET_DATA_MES_ABERTO.
*"----------------------------------------------------------------------
*"*"Interface local:
*"  IMPORTING
*"     REFERENCE(P_DATA_ENT) TYPE  DATUM
*"     REFERENCE(P_BUKRS) TYPE  BUKRS
*"     REFERENCE(P_PERIODO) TYPE  MONAT OPTIONAL
*"  EXPORTING
*"     REFERENCE(P_DATA_VAL) TYPE  DATUM
*"  EXCEPTIONS
*"      SEM_PERIODO
*"----------------------------------------------------------------------

  DATA: E_T001B   TYPE T001B,
        P_DATA_MP TYPE DATUM,
        P_ANO     TYPE C LENGTH 4,
        P_MES     TYPE C LENGTH 2,
        P_MESF    TYPE C LENGTH 2,
        PERIODI   TYPE   DATUM,
        PERIODF   TYPE   DATUM.

  CLEAR: P_DATA_VAL.

  CALL FUNCTION '/IBS/RB_FI_DATA_GET'
    EXPORTING
      I_BUKRS         = P_BUKRS
    IMPORTING
      E_T001B         = E_T001B
    EXCEPTIONS
      PARAMETER_ERROR = 1
      DATA_ERROR      = 2
      OTHERS          = 3.

  IF NOT SY-SUBRC IS INITIAL.
    MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
  ENDIF.

  IF P_PERIODO BETWEEN 13 AND 16.
    IF P_DATA_ENT+4(2) NE 12.
      MESSAGE E032 RAISING SEM_PERIODO WITH P_DATA_ENT.
    ENDIF.
    " Inicial
    P_ANO  = E_T001B-FRYE2.
    P_MES  = E_T001B-FRPE2+1(2).
    P_MESF = E_T001B-TOPE2+1(2).
    IF P_DATA_ENT+0(4) NE P_ANO OR
       ( P_PERIODO LT P_MES OR P_PERIODO GT P_MESF ).
      MESSAGE E033  RAISING SEM_PERIODO WITH P_PERIODO.
    ENDIF.
    P_DATA_VAL = P_DATA_ENT.

  ELSE.
    " Inicial
    P_ANO = E_T001B-FRYE1.
    P_MES = E_T001B-FRPE1+1(2).
    CONCATENATE P_ANO P_MES '01' INTO PERIODI.

    " Final
    P_ANO = E_T001B-TOYE1.
    P_MES = E_T001B-TOPE1+1(2).
    CONCATENATE P_ANO P_MES '01' INTO PERIODF.


    CALL FUNCTION 'FKK_LAST_DAY_OF_MONTH'
      EXPORTING
        DAY_IN            = PERIODF
      IMPORTING
        LAST_DAY_OF_MONTH = PERIODF.


    IF P_DATA_ENT GE PERIODI AND P_DATA_ENT LE PERIODF.
      P_DATA_VAL = P_DATA_ENT.
    ELSE.
      IF P_DATA_ENT LT PERIODI.
        P_DATA_VAL = PERIODI.
      ELSE.
        MESSAGE E010 RAISING SEM_PERIODO WITH P_DATA_ENT.
      ENDIF.
    ENDIF.
  ENDIF.

ENDFUNCTION.
