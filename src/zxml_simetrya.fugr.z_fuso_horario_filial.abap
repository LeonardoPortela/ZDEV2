FUNCTION Z_FUSO_HORARIO_FILIAL.
*"----------------------------------------------------------------------
*"*"Interface local:
*"  IMPORTING
*"     REFERENCE(I_BUKRS) TYPE  BUKRS
*"     REFERENCE(I_BRANCH) TYPE  J_1BBRANC_
*"  EXPORTING
*"     REFERENCE(E_TIME) TYPE  ERZET
*"     REFERENCE(E_TZNZONE) TYPE  TZNZONE
*"     REFERENCE(E_DATA) TYPE  DATUM
*"     REFERENCE(E_TIMESTAMPL) TYPE  TIMESTAMPL
*"     REFERENCE(E_TIMESTAMP) TYPE  TIMESTAMP
*"----------------------------------------------------------------------

  DATA: V_TIME_STAMP TYPE TIMESTAMP,
        V_TIME_STAML TYPE TIMESTAMPL,
        V_DATA       TYPE ERDAT,
        V_TIME       TYPE ERZET,
        V_CHAR       TYPE C LENGTH 22.

  CLEAR: E_TIME, V_TIME_STAMP, V_DATA, V_TIME, E_TZNZONE.

  CHECK ( I_BUKRS   IS NOT INITIAL ) AND
        ( I_BRANCH  IS NOT INITIAL ).

  SELECT SINGLE *
    FROM J_1BBRANCH INTO @DATA(_WL_BRANCH)
   WHERE BUKRS  = @I_BUKRS
     AND BRANCH = @I_BRANCH.

  CHECK SY-SUBRC = 0.

  "Endereco Filial
  SELECT SINGLE *
    FROM ADRC INTO @DATA(_WL_ADRC)
   WHERE ADDRNUMBER EQ @_WL_BRANCH-ADRNR.

  CHECK ( SY-SUBRC = 0 ) AND ( _WL_BRANCH-ADRNR IS NOT INITIAL ) AND ( _WL_ADRC-REGION IS NOT INITIAL ).

  "Check parametro para a Filial
  SELECT SINGLE *
    FROM ZSDT0149 INTO @DATA(_WL_0149)
   WHERE BRANCH = @I_BRANCH.

  IF SY-SUBRC NE 0.
    SELECT SINGLE *
      FROM ZSDT0149 INTO _WL_0149
     WHERE REGION = _WL_ADRC-REGION.
  ENDIF.

  CHECK ( SY-SUBRC = 0 ) AND ( _WL_0149-TZONE IS NOT INITIAL ).

  GET TIME STAMP FIELD V_TIME_STAMP.
  GET TIME STAMP FIELD V_TIME_STAML.

  E_TZNZONE = _WL_0149-TZONE.

  CONVERT TIME STAMP V_TIME_STAMP TIME ZONE _WL_0149-TZONE INTO
          DATE V_DATA TIME V_TIME.

  E_DATA = V_DATA.

  E_TIMESTAMPL = V_TIME_STAML.
  E_TIMESTAMP  = V_TIME_STAMP.

  WRITE E_TIMESTAMPL TO V_CHAR.
  V_CHAR = V_DATA && V_TIME && ',' && V_CHAR+15(7).
  V_CHAR = CONV #( ZCL_STRING=>REPLACE( EXPORTING I_STR = CONV #( V_CHAR ) I_CHAR_OLD   = ',' I_CHAR_NEW   = '.' ) ).
  E_TIMESTAMPL = V_CHAR.
  E_TIMESTAMP  = V_CHAR.

  IF ( V_DATA = SY-DATUM ) AND ( V_TIME IS NOT INITIAL ). "Verificar se fuso da filial, n√£o mudou de dia.
    E_TIME = V_TIME.
  ENDIF.

ENDFUNCTION.
