FUNCTION Z_MEMO_PROX_FORMULARIO.
*"----------------------------------------------------------------------
*"*"Interface local:
*"  IMPORTING
*"     REFERENCE(REPRESENTANTE) TYPE  KUNNR
*"  EXPORTING
*"     VALUE(FORMULARIO) TYPE  Z_MEMO_NUMERO
*"  EXCEPTIONS
*"      LOCAL_NEGOCIO
*"      FORM_MEMO
*"      FORM_INTERVALO
*"      FORM_INTER_INUT
*"----------------------------------------------------------------------

  DATA: VG_BRANCH           TYPE J_1BBRANC_,
        WA_J_1BBRANCH       TYPE J_1BBRANCH,
        IT_ZDOC_MEMO_FORM   TYPE TABLE OF ZDOC_MEMO_FORM WITH HEADER LINE,
        WA_ZDOC_MEMO_FORM   TYPE ZDOC_MEMO_FORM,
        VG_FORMULARIO       TYPE Z_MEMO_NUMERO,
        VG_FORM_PROX        TYPE Z_MEMO_NUMERO,
        VG_REPRESENTA       TYPE KUNNR,
        VG_FORM_VALIDO      TYPE C LENGTH 1,
        WA_ZDOC_MEMO_FORM_U TYPE ZDOC_MEMO_FORM_U,
        IT_ZDOC_MEMORANDO   TYPE TABLE OF ZDOC_MEMORANDO WITH HEADER LINE,
        WA_ZDOC_MEMORANDO   TYPE ZDOC_MEMORANDO.

  CALL FUNCTION 'CONVERSION_EXIT_ALPHA_INPUT'
    EXPORTING
      INPUT  = REPRESENTANTE
    IMPORTING
      OUTPUT = VG_REPRESENTA.

  VG_BRANCH = VG_REPRESENTA+6(4).

  SELECT SINGLE * INTO WA_J_1BBRANCH
    FROM J_1BBRANCH
   WHERE BRANCH EQ VG_BRANCH.

  IF NOT SY-SUBRC IS INITIAL.
    MESSAGE E059 RAISING LOCAL_NEGOCIO WITH VG_BRANCH.
  ENDIF.

*  SELECT * INTO TABLE it_zdoc_memo_form
*    FROM zdoc_memo_form
*   WHERE bukrs  EQ wa_j_1bbranch-bukrs
*     AND branch  EQ wa_j_1bbranch-branch.

*"----------------------------------------------------------------------
*" Assunto: Ajuste de Código
*" Buscar Informações do intervalo da empresa e filial
*" Autor: Victor Hugo
*" Data: 21.11.2012

  CLEAR: WA_ZDOC_MEMO_FORM.

  SELECT SINGLE *
    FROM ZDOC_MEMO_FORM
    INTO WA_ZDOC_MEMO_FORM
  WHERE BUKRS  EQ WA_J_1BBRANCH-BUKRS
    AND BRANCH EQ WA_J_1BBRANCH-BRANCH.
*"----------------------------------------------------------------------

  IF NOT SY-SUBRC IS INITIAL.
    MESSAGE E074 RAISING FORM_MEMO WITH WA_J_1BBRANCH-BUKRS WA_J_1BBRANCH-BRANCH.
  ELSE.

*    "Pega ultimo número utilizado
*    SELECT MAX( FORMULARIO ) INTO VG_FORMULARIO
*      FROM ZDOC_MEMORANDO
*     WHERE REPRESENTANTE EQ VG_REPRESENTA
*       AND DIRECAO       EQ 1.

*"----------------------------------------------------------------------
*" Assunto: Ajuste de Código
*" Recuperar qual é o último intervalo para o formulario utilizado
*" Autor: Victor Hugo
*" Data: 21.11.2012

    DATA: WA_ZDOC_MEMORANDO_AUX TYPE ZDOC_MEMORANDO.

    CLEAR: VG_FORMULARIO, WA_ZDOC_MEMORANDO_AUX.

    SELECT * INTO TABLE IT_ZDOC_MEMORANDO
      FROM ZDOC_MEMORANDO
    WHERE FORMULARIO BETWEEN WA_ZDOC_MEMO_FORM-FORM_INICIAL AND WA_ZDOC_MEMO_FORM-FORM_FINAL
      AND REPRESENTANTE EQ VG_REPRESENTA.

    IF ( SY-SUBRC EQ 0 ).
      SORT: IT_ZDOC_MEMORANDO  BY FORMULARIO DESCENDING.

      READ TABLE IT_ZDOC_MEMORANDO INTO WA_ZDOC_MEMORANDO INDEX 1.
      VG_FORMULARIO = WA_ZDOC_MEMORANDO-FORMULARIO + 1.

    ELSE.

      SELECT SINGLE * FROM ZDOC_MEMORANDO
        INTO WA_ZDOC_MEMORANDO_AUX
       WHERE FORMULARIO    EQ WA_ZDOC_MEMO_FORM-FORM_INICIAL
         AND REPRESENTANTE EQ VG_REPRESENTA.

      IF ( SY-SUBRC EQ 0 ).
        VG_FORMULARIO = WA_ZDOC_MEMORANDO_AUX-FORMULARIO + 1.
      ELSE.
        VG_FORMULARIO = WA_ZDOC_MEMO_FORM-FORM_INICIAL.
      ENDIF.
    ENDIF.

*"----------------------------------------------------------------------


*    CLEAR: VG_FORM_PROX.
*
*    IF VG_FORMULARIO IS INITIAL.
*      READ TABLE IT_ZDOC_MEMO_FORM INTO WA_ZDOC_MEMO_FORM INDEX 1.
*      IF SY-SUBRC IS INITIAL.
*        VG_FORM_PROX = WA_ZDOC_MEMO_FORM-FORM_INICIAL.
*      ENDIF.
*    ELSE.
*      LOOP AT IT_ZDOC_MEMO_FORM INTO WA_ZDOC_MEMO_FORM.
*        IF ( VG_FORMULARIO GE WA_ZDOC_MEMO_FORM-FORM_INICIAL ) AND
*           ( VG_FORMULARIO LT WA_ZDOC_MEMO_FORM-FORM_FINAL   ).
*          VG_FORM_PROX   = VG_FORMULARIO + 1.
*        ENDIF.
*      ENDLOOP.
*    ENDIF.
*
*    IF VG_FORM_PROX IS INITIAL.
*      MESSAGE E075 RAISING FORM_INTERVALO.
*    ELSE.
*
*      CLEAR: VG_FORM_VALIDO.
*
*      WHILE ( VG_FORM_PROX LE WA_ZDOC_MEMO_FORM-FORM_FINAL ) AND ( VG_FORM_VALIDO IS INITIAL ).
*
*        SELECT SINGLE * INTO WA_ZDOC_MEMO_FORM_U
*          FROM ZDOC_MEMO_FORM_U
*         WHERE BUKRS      EQ WA_J_1BBRANCH-BUKRS
*           AND BRANCH     EQ WA_J_1BBRANCH-BRANCH
*           AND FORMULARIO EQ VG_FORM_PROX.
*
*        IF NOT SY-SUBRC IS INITIAL.
*          VG_FORM_VALIDO = 'X'.
*        ELSE.
*          VG_FORM_PROX = VG_FORM_PROX + 1.
*        ENDIF.
*      ENDWHILE.
*
*      IF VG_FORM_VALIDO IS INITIAL.
*        MESSAGE E076 RAISING FORM_INTER_INUT.
*      ENDIF.
*
*    ENDIF.
*
*  ENDIF.

    IF ( VG_FORMULARIO > WA_ZDOC_MEMO_FORM-FORM_FINAL ).
      MESSAGE E086 WITH WA_ZDOC_MEMO_FORM-FORM_FINAL.
    ELSE.
      FORMULARIO = VG_FORMULARIO.
    ENDIF.



  ENDIF.

ENDFUNCTION.
