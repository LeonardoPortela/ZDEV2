DATA: WL_0051  TYPE ZSDT0051,
      WL_0052  TYPE ZSDT0052,
      WL_KUNNR TYPE KNA1-KUNNR,
      WL_T012  TYPE T012,
      WL_TABIX TYPE SY-TABIX,
      WL_MATNR TYPE THEAD-TDNAME,
      TL_0053  TYPE TABLE OF ZSDT0053 WITH HEADER LINE,
      TL_0055  TYPE TABLE OF ZSDT0055 WITH HEADER LINE.

CLEAR: WL_0051, WL_0052, WG_HEADER, WG_CLIENTE,
       WL_KUNNR, WL_T012, WL_MATNR, WL_TABIX.

REFRESH: TL_0053, TL_0055, TG_ITENS,
         TG_MARA, TG_MAKT, TG_LINES, TG_LOGISTICA1,
         TG_LOGISTICA2, TG_LOGISTICA3, TG_LOGISTICA.

SELECT SINGLE *
  FROM ZSDT0051
  INTO WL_0051
   WHERE NRO_SOL_OV EQ I_NRO_SOL_OV
     AND STATUS     EQ 'L'.

IF SY-SUBRC IS INITIAL.
  SELECT SINGLE VTEXT
      FROM TVKOT
      INTO WG_HEADER-ORG_VENDAS
       WHERE VKORG EQ WL_0051-VKORG
         AND SPRAS EQ SY-LANGU.

  SELECT SINGLE *
    FROM ZSDT0052
    INTO WL_0052
     WHERE NRO_SOL_OV EQ I_NRO_SOL_OV.

  IF SY-SUBRC IS INITIAL.
    SELECT SINGLE TEXT1
      FROM T042Z
      INTO WG_COND_PGTO-FORMA_PGTO
       WHERE LAND1 EQ 'BR'
         AND ZLSCH EQ WL_0052-ZLSCH.

    SELECT SINGLE VTEXT
      FROM TVZBT
      INTO WG_COND_PGTO-CONDICAO
       WHERE SPRAS EQ SY-LANGU
         AND ZTERM EQ WL_0052-ZTERM.

    SELECT SINGLE ORT01
      FROM T001W
      INTO WG_HEADER-CIDADE
       WHERE WERKS EQ WL_0051-VKBUR.

    SELECT SINGLE TEXT1
      FROM T012T
      INTO WG_COND_PGTO-BANCO
       WHERE SPRAS EQ SY-LANGU
         AND BUKRS EQ WL_0051-VKORG
         AND HBKID EQ WL_0052-HBKID.

    IF SY-SUBRC IS INITIAL.
      SELECT SINGLE *
        FROM T012
        INTO WL_T012
         WHERE BUKRS EQ WL_0051-VKORG
           AND HBKID EQ WL_0052-HBKID
           AND BANKS EQ 'BR'.

      IF SY-SUBRC IS INITIAL.
        SELECT SINGLE BNKLZ
          FROM BNKA
          INTO WG_COND_PGTO-AG
           WHERE BANKS EQ 'BR'
             AND BANKL EQ WL_T012-BANKL.
        CONDENSE WG_COND_PGTO-AG NO-GAPS.
        CLEAR: WG_COND_PGTO-AG(4).
        CONDENSE WG_COND_PGTO-AG NO-GAPS.

      ENDIF.
      SELECT SINGLE BANKN BKONT
        FROM T012K
        INTO (WG_COND_PGTO-CONTA, WG_COND_PGTO-DIG)
         WHERE BUKRS EQ WL_0051-VKORG
          AND HBKID EQ WL_0052-HBKID.

      CONCATENATE WG_COND_PGTO-AG WG_COND_PGTO-DIG
      INTO WG_COND_PGTO-AG SEPARATED BY '-'.
    ENDIF.

    WG_COND_PGTO-MOEDA = WL_0051-WAERK.
    WG_COND_PGTO-FRETE = WL_0051-INCO1.
    WG_HEADER-LOGISTICA = WL_0051-COMENT_LOGISTICA.
    IF WL_0052-VALDT IS NOT INITIAL.
      WRITE WL_0052-VALDT TO WG_COND_PGTO-VENCIMENTO.
    ENDIF.
  ENDIF.

  SELECT *
    FROM ZSDT0053
    INTO TABLE TL_0053
     WHERE NRO_SOL_OV EQ I_NRO_SOL_OV.

  IF SY-SUBRC IS INITIAL.
    READ TABLE TL_0053 INDEX 1.
    WL_MATNR = TL_0053-MATNR.
    CALL FUNCTION 'READ_TEXT'
      EXPORTING
        OBJECT          = 'MATERIAL'
        NAME            = WL_MATNR
        ID              = 'PRUE'
        LANGUAGE        = SY-LANGU
      TABLES
        LINES           = TG_LINES
      EXCEPTIONS
        OBJECT          = 1
        ID              = 2
        LANGUAGE        = 3
        NAME            = 4
        NOT_FOUND       = 5
        REFERENCE_CHECK = 6.

    CALL FUNCTION 'CONVERSION_EXIT_ALPHA_INPUT'
      EXPORTING
        INPUT  = TL_0053-WERKS
      IMPORTING
        OUTPUT = WL_KUNNR.

    SELECT SINGLE STRAS PSTLZ STCD1 STCD2 STCD3 ORT01 REGIO
      FROM  KNA1
      INTO (WG_HEADER-ENDERECO, WG_HEADER-CEP, WG_HEADER-CNPJ, WG_HEADER-CPF,
      WG_HEADER-IE, WG_HEADER-MUNICIPIO, WG_HEADER-UF)
       WHERE KUNNR EQ WL_KUNNR.

    WG_HEADER-VKAUS = WL_0051-VKAUS.
    WG_HEADER-NRO_SOL_OV = WL_0051-NRO_SOL_OV.
    WG_HEADER-DATA = WL_0051-DATA_ATUAL.

    SELECT SINGLE NAME1 STRAS PSTLZ STCD1 STCD2 STCD3 ORT01 REGIO
        FROM  KNA1
        INTO (WG_CLIENTE-EMISSOR, WG_CLIENTE-ENDERECO, WG_CLIENTE-CEP, WG_CLIENTE-CNPJ, WG_CLIENTE-CPF,
        WG_CLIENTE-IE, WG_CLIENTE-MUNICIPIO, WG_CLIENTE-UF)
         WHERE KUNNR EQ WL_0051-KUNNR.

    SELECT *
      FROM MARA
      INTO TABLE TG_MARA
       FOR ALL ENTRIES IN TL_0053
       WHERE MATNR EQ TL_0053-MATNR.

    SELECT *
      FROM MAKT
      INTO TABLE TG_MAKT
       FOR ALL ENTRIES IN TL_0053
       WHERE MATNR EQ TL_0053-MATNR
         AND SPRAS EQ SY-LANGU.

    SORT: TG_MARA BY MATNR,
          TG_MAKT BY MATNR.

    TG_ITENS[] = TL_0053[].
  ENDIF.

  SELECT *
    FROM ZSDT0055
    INTO TABLE TL_0055
     WHERE NRO_SOL_OV EQ I_NRO_SOL_OV.

  IF SY-SUBRC IS INITIAL.
    LOOP AT TL_0055.
      IF SY-TABIX LE 1.
        APPEND TL_0055 TO TG_LOGISTICA.
      ENDIF.
      ADD 1  TO WL_TABIX.
      IF WL_TABIX EQ 1.

        APPEND TL_0055 TO TG_LOGISTICA1.
      ELSEIF WL_TABIX EQ 2.

        APPEND TL_0055 TO TG_LOGISTICA2.
      ELSEIF WL_TABIX EQ 3.

        APPEND TL_0055 TO TG_LOGISTICA3.
        CLEAR: WL_TABIX.
      ENDIF.

    ENDLOOP.
  ENDIF.


ENDIF.
