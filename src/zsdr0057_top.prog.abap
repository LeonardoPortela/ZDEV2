*&---------------------------------------------------------------------*
*&  Include           ZSDR0057_TOP
*&---------------------------------------------------------------------*

REPORT ZSDR0057.

TABLES: ZSDT0125.

TYPES: BEGIN OF TY_ESTRUTURA.
        INCLUDE TYPE SLIS_FIELDCAT_MAIN.
        INCLUDE TYPE SLIS_FIELDCAT_ALV_SPEC.
TYPES: END OF TY_ESTRUTURA.

TYPES: BEGIN OF TY_SAIDA_0100,
         TP_MOV         TYPE C,
         IC_MOV         TYPE CHAR04,
         DS_FORN        TYPE LFA1-NAME1,
         DS_BRANCH      TYPE J_1BBRANCH-NAME,
         DS_MATERIAL    TYPE MAKT-MAKTX,
         DS_CERTIFICADO TYPE ZSDT0124-DS_CERTIFICADO.
         INCLUDE STRUCTURE ZSDT0125.
TYPES: END OF TY_SAIDA_0100.

TYPES: BEGIN OF TY_SAIDA_0101,
         OBJ_KEY            TYPE ZSDT0125-OBJ_KEY,
         CD_CERTIFICACAO    TYPE ZSDT0125-CD_CERTIFICACAO,
         EBELN              TYPE ZSDT0125-EBELN,
         EBELP              TYPE ZSDT0125-EBELP,
         DT_MOVIMENTO       TYPE ZSDT0125-DT_MOVIMENTO,
         WERKS              TYPE ZSDT0126-WERKS,
         LIFNR              TYPE ZSDT0125-LIFNR,
         MATNR              TYPE ZSDT0125-MATNR,
         QTDE_MOV           TYPE ZSDT0125-QTDE_MOV,
         QTDE_CERT          TYPE ZSDT0125-QTDE_CERT,
         KVGR3              TYPE ZSDT0125-KVGR3,
         CENTRO_VIRTUAL     TYPE ZSDT0125-CENTRO_VIRTUAL,
         LGORT              TYPE ZSDT0125-LGORT,
         REF_DOC_NO         TYPE ZSDT0125-REF_DOC_NO,
         MM_MBLNR           TYPE ZSDT0125-MM_MBLNR,
         MM_MJAHR           TYPE ZSDT0125-MM_MJAHR,
         FT_BELNR           TYPE ZSDT0125-FT_BELNR,
         FT_GJAHR           TYPE ZSDT0125-FT_GJAHR,
         DOCNUM             TYPE ZSDT0125-DOCNUM,
         NFENUM             TYPE ZSDT0125-NFENUM,
         SERIE              TYPE ZSDT0125-SERIE,
         AV_VBELN           TYPE ZSDT0125-AV_VBELN,
         CHARG              TYPE ZSDT0125-CHARG,
         UNIDADE            TYPE ZSDT0125-UNIDADE,
         LOEKZ              TYPE ZSDT0125-LOEKZ,
         DEVOLVIDA          TYPE ZSDT0125-DEVOLVIDA,
         DOCNUM_DEV         TYPE ZSDT0125-DOCNUM_DEV,
         DOC_REM            TYPE ZSDT0126-DOC_REM,
         DT_ATUAL           TYPE ZSDT0125-DT_ATUAL,
         HR_ATUAL           TYPE ZSDT0125-HR_ATUAL.
TYPES: END OF TY_SAIDA_0101.

TYPES: BEGIN OF TY_SAIDA_0100_RES,
         SLD_INICIAL    TYPE ZSDT0125-QTDE_CERT,
         QTDE_ENT       TYPE ZSDT0125-QTDE_CERT,
         QTDE_SAI       TYPE ZSDT0125-QTDE_CERT,
         SLD_FINAL      TYPE ZSDT0125-QTDE_CERT,
         DS_BRANCH      TYPE J_1BBRANCH-NAME,
         DS_MATERIAL    TYPE MAKT-MAKTX,
         DS_CERTIFICADO TYPE ZSDT0124-DS_CERTIFICADO.
         INCLUDE STRUCTURE ZSDT0125.
TYPES: END OF TY_SAIDA_0100_RES.


TYPES: BEGIN OF TY_0125_AGRP_MOV,
         DT_MOVIMENTO       TYPE ZSDT0125-DT_MOVIMENTO,
         WERKS              TYPE ZSDT0125-WERKS,
         LIFNR              TYPE ZSDT0125-LIFNR,
         MATNR              TYPE ZSDT0125-MATNR,
         CD_CERTIFICACAO    TYPE ZSDT0125-CD_CERTIFICACAO,
         QTDE_CERT          TYPE ZSDT0125-QTDE_CERT,
       END OF TY_0125_AGRP_MOV.

TYPES: BEGIN OF TY_0126_AGRP_MOV,
         DT_MOVIMENTO       TYPE ZSDT0126-DT_MOVIMENTO,
         WERKS              TYPE ZSDT0126-WERKS,
         MATNR              TYPE ZSDT0126-MATNR,
         CD_CERTIFICACAO    TYPE ZSDT0126-CD_CERTIFICACAO,
         QTDE_CERT          TYPE ZSDT0126-QTDE_CERT,
       END OF TY_0126_AGRP_MOV.

TYPES: BEGIN OF TY_RESUMO,
         WERKS              TYPE ZSDT0125-WERKS,
         MATNR              TYPE ZSDT0125-MATNR,
         CD_CERTIFICACAO    TYPE ZSDT0125-CD_CERTIFICACAO,
         QTDE_CERT          TYPE ZSDT0125-QTDE_CERT,
       END OF TY_RESUMO.

DATA: BEGIN OF TG_0125 OCCURS 0.
        INCLUDE STRUCTURE ZSDT0125.
DATA: END OF TG_0125.

DATA: BEGIN OF TG_0126 OCCURS 0.
        INCLUDE STRUCTURE ZSDT0126.
DATA: END OF TG_0126.

DATA: BEGIN OF TG_LFA1 OCCURS 0,
        LIFNR TYPE LFA1-LIFNR,
        NAME1 TYPE LFA1-NAME1,
      END OF TG_LFA1,

      BEGIN OF TG_J_1BBRANCH OCCURS 0,
        BRANCH TYPE J_1BBRANCH-BRANCH,
        NAME   TYPE J_1BBRANCH-NAME,
      END OF TG_J_1BBRANCH,

      BEGIN OF TG_MAKT OCCURS 0,
        MATNR  TYPE MAKT-MATNR,
        MAKTX  TYPE MAKT-MAKTX,
      END OF TG_MAKT,

      BEGIN OF TG_0124 OCCURS 0.
        INCLUDE STRUCTURE ZSDT0124.
 DATA END OF TG_0124.

*---------------------------------------------------------------------*
*  Inicio Definition Classes
*---------------------------------------------------------------------*

CLASS LCL_ALV_TOOLBAR_0100 DEFINITION.
  PUBLIC SECTION.
*Constructor
    METHODS: CONSTRUCTOR
                IMPORTING IO_ALV_GRID TYPE REF TO CL_GUI_ALV_GRID,
*Event for toolbar
    ON_TOOLBAR FOR EVENT TOOLBAR OF CL_GUI_ALV_GRID
               IMPORTING  E_OBJECT,

    HANDLE_USER_COMMAND FOR EVENT USER_COMMAND OF CL_GUI_ALV_GRID
               IMPORTING E_UCOMM.

ENDCLASS.                    "LCL_ALV_TOOLBAR DEFINITION

CLASS LCL_ALV_TOOLBAR_0100_RES DEFINITION.
  PUBLIC SECTION.
*Constructor
    METHODS: CONSTRUCTOR
                IMPORTING IO_ALV_GRID TYPE REF TO CL_GUI_ALV_GRID,
*Event for toolbar
    ON_TOOLBAR FOR EVENT TOOLBAR OF CL_GUI_ALV_GRID
               IMPORTING  E_OBJECT,

    HANDLE_USER_COMMAND FOR EVENT USER_COMMAND OF CL_GUI_ALV_GRID
               IMPORTING E_UCOMM.

ENDCLASS.                    "LCL_ALV_TOOLBAR DEFINITION

CLASS LCL_EVENT_HANDLER_0100 DEFINITION.
  PUBLIC SECTION.
    CLASS-METHODS: HANDLE_HOTSPOT_CLICK FOR EVENT HOTSPOT_CLICK OF CL_GUI_ALV_GRID IMPORTING E_ROW_ID E_COLUMN_ID ES_ROW_NO.
ENDCLASS.

CLASS LCL_EVENT_HANDLER_0100_RES DEFINITION.
  PUBLIC SECTION.
    CLASS-METHODS: HANDLE_HOTSPOT_CLICK FOR EVENT HOTSPOT_CLICK OF CL_GUI_ALV_GRID IMPORTING E_ROW_ID E_COLUMN_ID ES_ROW_NO.
ENDCLASS.

CLASS LCL_EVENT_HANDLER_0101 DEFINITION.
  PUBLIC SECTION.
    CLASS-METHODS: HANDLE_HOTSPOT_CLICK FOR EVENT HOTSPOT_CLICK OF CL_GUI_ALV_GRID IMPORTING E_ROW_ID E_COLUMN_ID ES_ROW_NO.
ENDCLASS.

*----------------------------------------------------------------------*
* Estruturas ALV
*----------------------------------------------------------------------*

DATA: OBJ_ALV_0100            TYPE REF TO CL_GUI_ALV_GRID,
      OBJ_CONTAINER_0100      TYPE REF TO CL_GUI_CUSTOM_CONTAINER,
      OBJ_ALV_0100_RES        TYPE REF TO CL_GUI_ALV_GRID,
      OBJ_CONTAINER_0100_RES  TYPE REF TO CL_GUI_CUSTOM_CONTAINER,
      OBJ_ALV_0101            TYPE REF TO CL_GUI_ALV_GRID,
      OBJ_CONTAINER_0101      TYPE REF TO CL_GUI_CUSTOM_CONTAINER.

DATA: LCL_EVENT_HANDLER_0100     TYPE REF TO LCL_EVENT_HANDLER_0100,
      LCL_EVENT_HANDLER_0100_RES TYPE REF TO LCL_EVENT_HANDLER_0100_RES,
      LCL_EVENT_HANDLER_0101     TYPE REF TO LCL_EVENT_HANDLER_0101.

* ALV field catalogs
DATA: IT_FCAT    TYPE LVC_T_FCAT,
      WA_FCAT    TYPE LVC_S_FCAT.

* ALV excluded functions
DATA: IT_EXCLUDE_FCODE TYPE UI_FUNCTIONS,
      WA_EXCLUDE_FCODE LIKE LINE OF IT_EXCLUDE_FCODE.

* Alv Styles
DATA: LS_EDIT         TYPE LVC_S_STYL,
      LT_EDIT         TYPE LVC_T_STYL.

* ALV layout variant
DATA: GS_VARIANT   TYPE DISVARIANT,
      VARIANTE     LIKE DISVARIANT,
      GS_VARIANT_C TYPE DISVARIANT.

* ALV layout
DATA: GS_LAYOUT        TYPE LVC_S_LAYO.

* ALV Stable
DATA: WA_STABLE        TYPE LVC_S_STBL.

DATA: IT_SEL_ROWS         TYPE LVC_T_ROW,
      WA_SEL_ROWS         TYPE LVC_S_ROW.

DATA: OBJ_TOOLBAR_0100      TYPE REF TO LCL_ALV_TOOLBAR_0100,
      OBJ_TOOLBAR_0100_RES  TYPE REF TO LCL_ALV_TOOLBAR_0100_RES.

DATA: GT_ESTILO   TYPE LVC_T_STYL WITH HEADER LINE,
      WL_ESTILO   TYPE LVC_S_STYL.

DATA: GT_F4  TYPE LVC_T_F4 WITH HEADER LINE.

DATA: IT_ESTRUTURA TYPE TABLE OF TY_ESTRUTURA,
      WA_ESTRUTURA TYPE TY_ESTRUTURA.

DATA: XS_EVENTS    TYPE SLIS_ALV_EVENT,
      EVENTS       TYPE SLIS_T_EVENT,
      T_PRINT      TYPE SLIS_PRINT_ALV,
      V_REPORT     LIKE SY-REPID,
      T_TOP        TYPE SLIS_T_LISTHEADER.

* Objetos
DATA: C_ALV_TOOLBARMANAGER TYPE REF TO CL_ALV_GRID_TOOLBAR_MANAGER,
      TY_TOOLBAR TYPE STB_BUTTON.

* Variaveis
DATA: WL_CENTRO(50)   TYPE C,
* ---> S4 Migration - 19/06/2023 - MA
*      WL_MATERIAL(50) TYPE C,
      WL_MATERIAL(40) TYPE C,
* <--- S4 Migration - 19/06/2023 - MA
      WL_DT_MOV(50)   TYPE C,
      VG_LAYOUT_0101  TYPE C.

*-------------------------------------------------------------------
* Tabelas Internas and Work Areas.
*-------------------------------------------------------------------
DATA: IT_SAIDA_0100     TYPE TABLE OF TY_SAIDA_0100,
      WA_SAIDA_0100     TYPE TY_SAIDA_0100,
      IT_SAIDA_0100_RES TYPE TABLE OF TY_SAIDA_0100_RES,
      WA_SAIDA_0100_RES TYPE TY_SAIDA_0100_RES,
      IT_SAIDA_0101     TYPE TABLE OF TY_SAIDA_0101,
      WA_SAIDA_0101     TYPE TY_SAIDA_0101,
      TG_0125_AGRP_MOV  TYPE TABLE OF TY_0125_AGRP_MOV WITH HEADER LINE,
      TG_0126_AGRP_MOV  TYPE TABLE OF TY_0126_AGRP_MOV WITH HEADER LINE,
      TG_0125_RES       TYPE TABLE OF TY_RESUMO WITH HEADER LINE,
      TG_0126_RES       TYPE TABLE OF TY_RESUMO WITH HEADER LINE,
      TG_0125_RES_INI   TYPE TABLE OF TY_RESUMO WITH HEADER LINE,
      TG_0126_RES_INI   TYPE TABLE OF TY_RESUMO WITH HEADER LINE,
      TG_RES_AUX        TYPE TABLE OF TY_RESUMO WITH HEADER LINE.

*----------------------------------------------------------------------*
* tela de Seleção
*----------------------------------------------------------------------*
SELECTION-SCREEN: BEGIN OF BLOCK B1 WITH FRAME TITLE TEXT-001.
SELECT-OPTIONS: P_WERKS  FOR ZSDT0125-WERKS OBLIGATORY,
                P_LIFNR  FOR ZSDT0125-LIFNR,
                P_MATNR  FOR ZSDT0125-MATNR OBLIGATORY NO INTERVALS NO-EXTENSION,
                P_DT_MOV FOR ZSDT0125-DT_MOVIMENTO OBLIGATORY.
SELECTION-SCREEN: END OF BLOCK B1.

SELECTION-SCREEN: BEGIN OF BLOCK B5 WITH FRAME TITLE TEXT-002.
PARAMETER: P_VARIA TYPE DISVARIANT-VARIANT.
SELECTION-SCREEN: END OF BLOCK B5.

INITIALIZATION.

  GS_VARIANT_C-REPORT      = SY-REPID.

*---------------------------------------------------------------------*
* Event selection-screen on value-request for p_var
*---------------------------------------------------------------------*

DATA: VG_REPID          LIKE SY-REPID,
      VG_VARIANT        TYPE DISVARIANT.

AT SELECTION-SCREEN ON VALUE-REQUEST FOR P_VARIA.

  VG_REPID        = SY-REPID.
  VARIANTE-REPORT = VG_REPID.

  IF ( P_VARIA IS NOT INITIAL ).
    VG_VARIANT-VARIANT = P_VARIA.

  ENDIF.
  CALL FUNCTION 'REUSE_ALV_VARIANT_F4'
    EXPORTING
      IS_VARIANT    = VARIANTE
      I_SAVE        = 'A'
    IMPORTING
      ES_VARIANT    = VARIANTE
    EXCEPTIONS
      NOT_FOUND     = 1
      PROGRAM_ERROR = 2
      OTHERS        = 3.

  IF ( SY-SUBRC NE 0 ).
    MESSAGE S000(Z01) WITH 'Não existe variante'.
    STOP.
  ELSE.
    MOVE VARIANTE-VARIANT TO P_VARIA.
    MOVE VARIANTE-VARIANT TO GS_VARIANT_C-VARIANT.
  ENDIF.



START-OF-SELECTION.

  IF P_MATNR-LOW EQ '*'.
    MESSAGE 'Informe um material!' TYPE 'S'.
    EXIT.
  ENDIF.

  PERFORM F_INICIAR_VARIAVEIS.
  PERFORM F_SELECIONAR_DADOS.
  PERFORM F_PROCESSAR_DADOS.
  PERFORM F_IMPRIMIR_DADOS.
