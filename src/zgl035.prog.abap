*&---------------------------------------------------------------------*
*& Report  ZGL035
*&
*&---------------------------------------------------------------------*
*&
*&
*&---------------------------------------------------------------------*
REPORT ZGL035.


***********************
* Internal Table
***********************

TYPES: BEGIN OF TY_ZGLT035,
         DOC_LCTO   TYPE ZGLT035-DOC_LCTO,
         BUDAT      TYPE ZGLT035-BUDAT,
         BUKRS      TYPE ZGLT035-BUKRS,
         TP_LCTO    TYPE ZGLT035-TP_LCTO,
         LOTE       TYPE ZGLT035-LOTE,
         HR_ENTRADA TYPE ZGLT035-HR_ENTRADA,
         OBJ_KEY    TYPE ZIB_CONTABIL-OBJ_KEY,
         DEL(1),
       END OF TY_ZGLT035,

       BEGIN OF TY_MAIL,
         BNAME     TYPE USR21-BNAME,
         SMTP_ADDR TYPE ADR6-SMTP_ADDR,
       END OF TY_MAIL.


DATA: IT_ZGLT035          TYPE TABLE OF TY_ZGLT035,
      GT_ZGLT035          TYPE TABLE OF ZGLT035,
      IT_ZGLT038          TYPE TABLE OF ZGLT038,
      IT_ZIB_CONTABIL_ERR TYPE TABLE OF ZIB_CONTABIL_ERR,
      IT_MAIL             TYPE TABLE OF TY_MAIL,
      WA_MAIL             TYPE TY_MAIL,
      WA_ZGLT035          TYPE TY_ZGLT035,
      WG_ZGLT035          TYPE ZGLT035,
      WA_ZGLT038          TYPE ZGLT038,
      WA_ZIB_CONTABIL_ERR TYPE ZIB_CONTABIL_ERR.

***********************
* Work Area
***********************


***********************
* Estrutura para o e-mail.
***********************
DATA: GT_DESTINATARIO TYPE STANDARD TABLE OF SOMLREC90 WITH HEADER LINE,
      GT_ASSUNTO      TYPE SODOCCHGI1,
      GT_TEXTO        TYPE STANDARD TABLE OF SOLI WITH HEADER LINE,
      TABIX           TYPE SY-TABIX,
      V_HORA          TYPE ZGLT038-HORA_ATUAL VALUE '073000',
      VTEMPO          TYPE ZGLT036-VLR_MOEDA_DOC,
      VTEMPOI         TYPE I,
      PDATA           TYPE SY-DATUM.
***********************
* Objetos
***********************
DATA: OBJ_ZCL_UTIL TYPE REF TO ZCL_UTIL.

**********************************************************************
* Fluxo Principal do Programa.
**********************************************************************
DATA: VG_JOB      TYPE I.

PDATA = SY-DATUM - 10.

SELECT SINGLE COUNT( * ) INTO VG_JOB
  FROM TBTCO
 WHERE JOBNAME EQ 'ZGL035_JOB'
   AND STATUS EQ 'R'.

IF ( VG_JOB NE 1 ).
  EXIT.
ENDIF.


SELECT  DOC_LCTO BUDAT BUKRS TP_LCTO LOTE HR_ENTRADA
 FROM  ZGLT035
 INTO TABLE IT_ZGLT035
 WHERE BUDAT GE PDATA
 AND   LOEKZ EQ ''.


IF IT_ZGLT035[] IS NOT INITIAL.
  SELECT *
    FROM ZGLT038
    INTO TABLE IT_ZGLT038
    FOR ALL ENTRIES IN IT_ZGLT035
    WHERE  BUKRS EQ IT_ZGLT035-BUKRS
    AND    LOTE  EQ IT_ZGLT035-LOTE.
ENDIF.

SORT IT_ZGLT038 BY  BUKRS LOTE ASCENDING NIVEL DESCENDING.

LOOP AT IT_ZGLT035 INTO WA_ZGLT035.
  TABIX = SY-TABIX.
  CONCATENATE 'ZGL17' WA_ZGLT035-DOC_LCTO WA_ZGLT035-BUDAT+0(4) INTO WA_ZGLT035-OBJ_KEY.
*  WA_ZGLT035-DEL = ''.
*  READ TABLE IT_ZGLT038 INTO WA_ZGLT038 WITH KEY BUKRS = WA_ZGLT035-BUKRS
*                                                 LOTE  = WA_ZGLT035-LOTE BINARY SEARCH.
*  IF SY-SUBRC NE 0.
*    WA_ZGLT038-HORA_ATUAL = WA_ZGLT035-HR_ENTRADA. "se não estiver aprovado ainda, pega a hora de criação
*  ENDIF.
*  VTEMPO = 0.
*  VTEMPOI = 0.
*  IF SY-UZEIT GT WA_ZGLT038-HORA_ATUAL.
*    VTEMPO =  ( ( SY-UZEIT - WA_ZGLT038-HORA_ATUAL ) / 3600 ) .
*    VTEMPOI = ( ( SY-UZEIT - WA_ZGLT038-HORA_ATUAL ) DIV 3600 ) .
*    VTEMPO  = ( VTEMPO - VTEMPOI ) * 100.
*  ELSEIF SY-UZEIT GT V_HORA.
*    VTEMPO =  ( ( SY-UZEIT - V_HORA ) / 3600 ) .
*    VTEMPOI = ( ( SY-UZEIT - V_HORA ) DIV 3600 ) .
*    VTEMPO  = ( VTEMPO - VTEMPOI ) * 100.
*  ENDIF.
*
*  IF NOT  VTEMPO BETWEEN 3 AND 4. "+- 2 minutos
*    WA_ZGLT035-DEL = 'X'.
*  ENDIF.

  MODIFY IT_ZGLT035 FROM WA_ZGLT035 INDEX TABIX TRANSPORTING OBJ_KEY. "DEL.
ENDLOOP.
"DELETE IT_ZGLT035 WHERE DEL = 'X'.

IF IT_ZGLT035[] IS NOT INITIAL.
  SELECT *
    FROM ZIB_CONTABIL_ERR
    INTO TABLE IT_ZIB_CONTABIL_ERR
    FOR ALL ENTRIES IN IT_ZGLT035
    WHERE OBJ_KEY EQ IT_ZGLT035-OBJ_KEY.

  SELECT *
    FROM ZGLT035
    INTO TABLE GT_ZGLT035
    FOR ALL ENTRIES IN IT_ZGLT035
    WHERE DOC_LCTO EQ IT_ZGLT035-DOC_LCTO
    AND   BUKRS    EQ IT_ZGLT035-BUKRS.

  SELECT USR21~BNAME ADR6~SMTP_ADDR
     FROM USR21
     INNER JOIN ADR6
        ON  USR21~ADDRNUMBER = ADR6~ADDRNUMBER
       AND USR21~PERSNUMBER = ADR6~PERSNUMBER
          INTO TABLE IT_MAIL
    FOR ALL ENTRIES IN GT_ZGLT035
    WHERE USR21~BNAME = GT_ZGLT035-USNAM.

ENDIF.

SORT: IT_MAIL BY BNAME,
      IT_ZIB_CONTABIL_ERR BY OBJ_KEY.

LOOP AT GT_ZGLT035 INTO WG_ZGLT035.
  CONCATENATE 'ZGL17' WG_ZGLT035-DOC_LCTO WG_ZGLT035-BUDAT+0(4) INTO WA_ZGLT035-OBJ_KEY.
  READ TABLE IT_ZIB_CONTABIL_ERR INTO WA_ZIB_CONTABIL_ERR WITH KEY OBJ_KEY = WA_ZGLT035-OBJ_KEY BINARY SEARCH.
  IF SY-SUBRC NE 0.
    CONTINUE.
  ENDIF.
  CONCATENATE 'Lote.' WG_ZGLT035-LOTE INTO GT_ASSUNTO-OBJ_NAME.
  CONCATENATE TEXT-001 WG_ZGLT035-LOTE 'Doc:' WG_ZGLT035-DOC_LCTO INTO GT_ASSUNTO-OBJ_DESCR SEPARATED BY SPACE.
  GT_ASSUNTO-OBJ_LANGU = SY-LANGU.

  "READ TABLE IT_MAIL INTO WA_MAIL WITH KEY BNAME = WG_ZGLT035-USNAM BINARY SEARCH.
  LOOP AT IT_MAIL INTO WA_MAIL WHERE BNAME EQ WG_ZGLT035-USNAM.
    GT_DESTINATARIO-REC_TYPE = 'U'.
    GT_DESTINATARIO-RECEIVER = WA_MAIL-SMTP_ADDR.
    APPEND GT_DESTINATARIO.
  ENDLOOP.

  GT_TEXTO = '<!DOCTYPE html>'.
  APPEND GT_TEXTO.
  GT_TEXTO = '<html>'.
  APPEND GT_TEXTO.
  GT_TEXTO = '<head>'.
  APPEND GT_TEXTO.
  GT_TEXTO = '<style type="text/css">'.
  APPEND GT_TEXTO.

  GT_TEXTO = ' #tdEstilo {  background-color: #BAEEAD; }'.
  APPEND GT_TEXTO.
  GT_TEXTO = 'table { border: 1px solid black; font-size: 16px;  padding: 0px;  border-collapse: collapse; }'.
  APPEND GT_TEXTO.
  GT_TEXTO = '#tdDados { font-weight: bold; }'.
  APPEND GT_TEXTO.

  GT_TEXTO = '</style>'.
  APPEND GT_TEXTO.
  GT_TEXTO = '</head>'.

  APPEND GT_TEXTO.
  GT_TEXTO = '<body lang="pt-br">'.
  APPEND GT_TEXTO.

  GT_TEXTO = '<table>'.
  APPEND GT_TEXTO.

  LOOP AT IT_ZIB_CONTABIL_ERR INTO WA_ZIB_CONTABIL_ERR WHERE OBJ_KEY = WA_ZGLT035-OBJ_KEY.
    CONCATENATE '<tr><td id ="tdEstilo">Erro:</td><td id="tdDados">' WA_ZIB_CONTABIL_ERR-MESSAGE '</td></tr>' INTO GT_TEXTO.
    APPEND GT_TEXTO.
  ENDLOOP.

  GT_TEXTO = '</table>'.
  APPEND GT_TEXTO.

  GT_TEXTO = '</body>'.
  APPEND GT_TEXTO.
  GT_TEXTO = '</html>'.
  APPEND GT_TEXTO.

  "Enviar E-mail
  CALL FUNCTION 'SO_NEW_DOCUMENT_SEND_API1'
    EXPORTING
      DOCUMENT_DATA              = GT_ASSUNTO
      DOCUMENT_TYPE              = 'HTM'
    TABLES
      OBJECT_CONTENT             = GT_TEXTO
      RECEIVERS                  = GT_DESTINATARIO
    EXCEPTIONS
      TOO_MANY_RECEIVERS         = 1
      DOCUMENT_NOT_SENT          = 2
      DOCUMENT_TYPE_NOT_EXIST    = 3
      OPERATION_NO_AUTHORIZATION = 4
      PARAMETER_ERROR            = 5
      X_ERROR                    = 6
      ENQUEUE_ERROR              = 7
      OTHERS                     = 8.

  IF ( SY-SUBRC EQ 0 ).
    COMMIT WORK.
  ENDIF.

  CLEAR: GT_ASSUNTO, GT_TEXTO, GT_DESTINATARIO.
  REFRESH:  GT_TEXTO, GT_DESTINATARIO.

ENDLOOP.
