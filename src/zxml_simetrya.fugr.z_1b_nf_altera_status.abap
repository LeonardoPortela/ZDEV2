FUNCTION Z_1B_NF_ALTERA_STATUS.
*"----------------------------------------------------------------------
*"*"Interface local:
*"  IMPORTING
*"     VALUE(IT_NOTAS) TYPE  ZIB_NOTA_FISCAL_SAP
*"     VALUE(LS_ACTTAB_NEW) TYPE  J_1BNFE_ACTIVE
*"     VALUE(LS_DOC_NEW) TYPE  J_1BNFDOC
*"----------------------------------------------------------------------


  DATA: LS_HISTTAB_NEW     TYPE J_1BNFE_HISTORY,
        LS_ZCARTA_CORRECAO TYPE ZCARTA_CORRECAO,
        WA_ZSDT0102        TYPE ZSDT0102,
        WA_ZSDT0107        TYPE ZSDT0107,
        WA_ZSDT0127        TYPE ZSDT0127,
        VL_NU_CHAVE_DV     TYPE ZIB_NFE_FORN-NU_CHAVE_DV,
        VL_NU_CHAVE        TYPE ZIB_NFE_FORN-NU_CHAVE,
        TL_ZLEST0061       TYPE TABLE OF ZLEST0061,
        WL_ZLEST0061       TYPE ZLEST0061,
        TL_ZLEST0060       TYPE TABLE OF ZLEST0060,
        WL_ZLEST0060       TYPE ZLEST0060.

  TABLES: ZSDT0001.

  CASE SY-MANDT.
    WHEN 060.  MOVE 2 TO LS_ACTTAB_NEW-TPAMB.
    WHEN 160.  MOVE 2 TO LS_ACTTAB_NEW-TPAMB.
    WHEN 300.  MOVE 1 TO LS_ACTTAB_NEW-TPAMB.
  ENDCASE.

  "Erro de Interface
  IF IT_NOTAS-DOCSTAT IS INITIAL.
    "Autorização de Nota Fiscal
    IF IT_NOTAS-TP_AUTHCOD EQ '1'.
      MOVE '3'                   TO LS_DOC_NEW-DOCSTAT.
      "MOVE it_notas-docstat      TO ls_doc_new-docstat.
      MOVE '1'                   TO LS_ACTTAB_NEW-ACTION_REQU.
      MOVE 'V'                   TO LS_ACTTAB_NEW-MSSTAT.
      MOVE '3'                   TO LS_ACTTAB_NEW-DOCSTA.
      "MOVE it_notas-docstat      TO ls_acttab_new-docsta.
      MOVE 'A'                   TO LS_ACTTAB_NEW-SCSSTA.
      MOVE IT_NOTAS-CODE         TO LS_ACTTAB_NEW-CODE.

      "CS2016001716
      CLEAR: LS_ACTTAB_NEW-AUTHCOD.

      SELECT SINGLE NU_CHAVE_DV NU_CHAVE
        INTO (VL_NU_CHAVE_DV, VL_NU_CHAVE)
        FROM ZIB_NFE_FORN
       WHERE DOCNUM EQ LS_DOC_NEW-DOCNUM.

      IF SY-SUBRC IS INITIAL.
        MOVE VL_NU_CHAVE_DV      TO LS_ACTTAB_NEW-CDV.
      ELSE.
        MOVE IT_NOTAS-CDV        TO LS_ACTTAB_NEW-CDV.
      ENDIF.
      IF NOT IT_NOTAS-REGIAO IS INITIAL.
        MOVE IT_NOTAS-REGIAO       TO LS_ACTTAB_NEW-REGIO.
      ENDIF.
      MOVE IT_NOTAS-DOCNUM9      TO LS_ACTTAB_NEW-DOCNUM9.
      "CLEAR: LS_ACTTAB_NEW-DOCNUM9, LS_ACTTAB_NEW-CDV, LS_ACTTAB_NEW-AUTHCOD.
      "Fim CS2016001716

      IF ( LS_ACTTAB_NEW-CODE EQ '998' ) AND ( LS_ACTTAB_NEW-NFNUM9 IS NOT INITIAL ).
        LS_DOC_NEW-NFENUM = LS_ACTTAB_NEW-NFNUM9.
      ENDIF.
      PERFORM REGISTRA_LOG USING LS_ACTTAB_NEW LS_DOC_NEW IT_NOTAS.

      "Deleta registro de movimentação referente ao controle de Certificação Socioambiental.
      IF IT_NOTAS-NU_DOCUMENTO_SAP IS NOT INITIAL.
        CALL FUNCTION 'ZSD_CHECK_MOV_CERTIFICADO'
          EXPORTING
            I_TP_MOV  = 'S'
            I_DOCNUM  = IT_NOTAS-NU_DOCUMENTO_SAP
            I_DEL_MOV = 'X'.
      ENDIF.

      "Cancelamento de Nota Fiscal
    ELSEIF IT_NOTAS-TP_AUTHCOD EQ '2'.
      IF LS_DOC_NEW-DOCSTAT EQ '1'.
        MOVE '1'                 TO LS_DOC_NEW-DOCSTAT.   "1
        MOVE '1'                 TO LS_ACTTAB_NEW-DOCSTA. "1
        MOVE '0'                 TO LS_ACTTAB_NEW-SCSSTA. "0
        MOVE 'A'                 TO LS_ACTTAB_NEW-MSSTAT. "G
        MOVE 'C'                 TO LS_ACTTAB_NEW-ACTION_REQU.
      ELSEIF ( LS_DOC_NEW-DOCSTAT EQ '2' ) OR ( LS_DOC_NEW-DOCSTAT IS INITIAL ).
        MOVE '0'                 TO LS_ACTTAB_NEW-SCSSTA. "0
        MOVE 'B'                 TO LS_ACTTAB_NEW-MSSTAT. "G
        MOVE '1'                 TO LS_ACTTAB_NEW-ACTION_REQU.
      ENDIF.
      MOVE IT_NOTAS-CODE         TO LS_ACTTAB_NEW-CODE.
      PERFORM REGISTRA_LOG USING LS_ACTTAB_NEW LS_DOC_NEW IT_NOTAS.
      "Carta de Correção
    ELSEIF IT_NOTAS-TP_AUTHCOD EQ '3'.
      CLEAR LS_ZCARTA_CORRECAO.

      SELECT SINGLE *
        INTO LS_ZCARTA_CORRECAO
        FROM ZCARTA_CORRECAO
       WHERE DOCNUM = IT_NOTAS-NU_DOCUMENTO_SAP
         AND ID_CC  = ( SELECT MAX( ID_CC ) FROM ZCARTA_CORRECAO WHERE DOCNUM = IT_NOTAS-NU_DOCUMENTO_SAP ).

      LS_ZCARTA_CORRECAO-TP_AUTHCOD    = IT_NOTAS-TP_AUTHCOD .
      LS_ZCARTA_CORRECAO-XML_VERS      = IT_NOTAS-XMLVERS.
      LS_ZCARTA_CORRECAO-AUTHCODE      = IT_NOTAS-AUTHCOD .
      LS_ZCARTA_CORRECAO-DT_AUTHCOD    = IT_NOTAS-DT_AUTHCOD .
      LS_ZCARTA_CORRECAO-HR_AUTHCOD    = IT_NOTAS-HR_AUTHCOD .
      LS_ZCARTA_CORRECAO-CODE          = IT_NOTAS-CODE .
      LS_ZCARTA_CORRECAO-DT_ATUALIZADO = SY-DATUM.
      LS_ZCARTA_CORRECAO-HR_ATUALIZADO = SY-UZEIT.
      LS_ZCARTA_CORRECAO-MSG           = IT_NOTAS-MS_ERRO.
      LS_ZCARTA_CORRECAO-DS_URL        = IT_NOTAS-DS_URL_DANFE.

      MODIFY ZCARTA_CORRECAO FROM  LS_ZCARTA_CORRECAO.

    ELSEIF IT_NOTAS-TP_AUTHCOD EQ '4'.

      IF ( IT_NOTAS-MODEL  = '55' ).  "Manifestão Destinatario NF-e

        CLEAR: WA_ZSDT0127.

        SELECT SINGLE *
          FROM ZSDT0127 INTO WA_ZSDT0127
         WHERE DOC_MANIFESTO = IT_NOTAS-NU_DOCUMENTO_SAP.

        WA_ZSDT0127-STATUS        = '3'.
        WA_ZSDT0127-CODE          = IT_NOTAS-CODE .
        WA_ZSDT0127-DT_ATUALIZADO = SY-DATUM.
        WA_ZSDT0127-HR_ATUALIZADO = SY-UZEIT.
        WA_ZSDT0127-MSG_RETORNO   = IT_NOTAS-MS_ERRO.

        CLEAR: WA_ZSDT0127-AUTHCODE.

        MODIFY ZSDT0127 FROM WA_ZSDT0127.

      ELSE. "Autorização MDF-e

        SELECT SINGLE *
          INTO WA_ZSDT0102
          FROM ZSDT0102
         WHERE DOCNUM = IT_NOTAS-NU_DOCUMENTO_SAP.

        WA_ZSDT0102-STATUS        = '3'.
        WA_ZSDT0102-CODE          = IT_NOTAS-CODE .
        WA_ZSDT0102-DT_ATUALIZADO = SY-DATUM.
        WA_ZSDT0102-HR_ATUALIZADO = SY-UZEIT.
        WA_ZSDT0102-MSG           = IT_NOTAS-MS_ERRO.

        CLEAR: WA_ZSDT0102-TRANSMISSAO.

        CLEAR: WA_ZSDT0102-DOCNUM9, WA_ZSDT0102-CDV, WA_ZSDT0102-AUTHCODE.

        MODIFY ZSDT0102 FROM WA_ZSDT0102.

      ENDIF.

    ELSEIF IT_NOTAS-TP_AUTHCOD EQ '5'. "Cancelamento MDF-e

      SELECT SINGLE *
        INTO WA_ZSDT0102
        FROM ZSDT0102
       WHERE DOCNUM = IT_NOTAS-NU_DOCUMENTO_SAP.

      WA_ZSDT0102-CODE          = IT_NOTAS-CODE .
      WA_ZSDT0102-DT_ATUALIZADO = SY-DATUM.
      WA_ZSDT0102-HR_ATUALIZADO = SY-UZEIT.
      WA_ZSDT0102-MSG           = IT_NOTAS-MS_ERRO.

      CLEAR: WA_ZSDT0102-TRANSMISSAO.

      MODIFY ZSDT0102 FROM WA_ZSDT0102.

    ELSEIF IT_NOTAS-TP_AUTHCOD EQ '6'. "Encerramento MDF-e

      SELECT SINGLE *
        INTO WA_ZSDT0102
        FROM ZSDT0102
       WHERE DOCNUM = IT_NOTAS-NU_DOCUMENTO_SAP.

      WA_ZSDT0102-CODE          = IT_NOTAS-CODE .
      WA_ZSDT0102-DT_ATUALIZADO = SY-DATUM.
      WA_ZSDT0102-HR_ATUALIZADO = SY-UZEIT.
      WA_ZSDT0102-MSG           = IT_NOTAS-MS_ERRO.

      CLEAR: WA_ZSDT0102-TRANSMISSAO.

      MODIFY ZSDT0102 FROM WA_ZSDT0102.

    ENDIF.

    "Autorização
  ELSEIF IT_NOTAS-DOCSTAT EQ '1'.
    "Autorização de Uso
    IF IT_NOTAS-TP_AUTHCOD EQ '1'.

      "Nota Fiscal
      MOVE IT_NOTAS-DOCSTAT      TO LS_DOC_NEW-DOCSTAT.
      MOVE IT_NOTAS-AUTHCOD      TO LS_DOC_NEW-AUTHCOD.
      MOVE IT_NOTAS-CODE         TO LS_DOC_NEW-CODE.
      IF NOT IT_NOTAS-XMLVERS IS INITIAL.
        MOVE IT_NOTAS-XMLVERS      TO LS_DOC_NEW-XMLVERS.
      ENDIF.
      MOVE ' '                   TO LS_DOC_NEW-CONTING.

      SELECT SINGLE NU_CHAVE_DV NU_CHAVE
        INTO (VL_NU_CHAVE_DV, VL_NU_CHAVE)
        FROM ZIB_NFE_FORN
       WHERE DOCNUM EQ LS_DOC_NEW-DOCNUM.

      IF SY-SUBRC IS INITIAL.
        MOVE VL_NU_CHAVE_DV      TO LS_ACTTAB_NEW-CDV.
        MOVE VL_NU_CHAVE+34(1)   TO LS_ACTTAB_NEW-TPEMIS.

        IF  (
              ( ( LS_ACTTAB_NEW-SERIE GE '890' ) AND ( LS_ACTTAB_NEW-SERIE LE '899' ) ) OR
              ( ( LS_ACTTAB_NEW-SERIE GE '900' ) AND ( LS_ACTTAB_NEW-SERIE LE '999' ) )
            ) AND
            ( LS_ACTTAB_NEW-STCD1 NE VL_NU_CHAVE+6(14) ) AND
            ( VL_NU_CHAVE+6(14)   IS NOT INITIAL ).
          LS_ACTTAB_NEW-STCD1 = VL_NU_CHAVE+6(14).
        ENDIF.

      ELSE.
        MOVE IT_NOTAS-CDV          TO LS_ACTTAB_NEW-CDV.
      ENDIF.


      "Active Nota Fiscal
      MOVE 'C'                   TO LS_ACTTAB_NEW-ACTION_REQU.
      MOVE '0'                   TO LS_ACTTAB_NEW-SCSSTA.
      MOVE IT_NOTAS-DOCSTAT      TO LS_ACTTAB_NEW-DOCSTA.
      IF NOT IT_NOTAS-REGIAO IS INITIAL.
        MOVE IT_NOTAS-REGIAO       TO LS_ACTTAB_NEW-REGIO.
      ENDIF.
      MOVE IT_NOTAS-CODE         TO LS_ACTTAB_NEW-CODE.
      MOVE IT_NOTAS-DOCNUM9      TO LS_ACTTAB_NEW-DOCNUM9.
      MOVE IT_NOTAS-AUTHCOD      TO LS_ACTTAB_NEW-AUTHCOD.
      MOVE 'A'                   TO LS_ACTTAB_NEW-MSSTAT.
      MOVE ' '                   TO LS_ACTTAB_NEW-CONTING.
      IF NOT LS_DOC_NEW-FORM IS INITIAL.
        PERFORM INSESIR_INF_SIMETRYA USING IT_NOTAS LS_ACTTAB_NEW.
      ENDIF.

      "Marcar registro de movimentação referente ao controle de Certificação Socioambiental como efetivado.
      IF IT_NOTAS-NU_DOCUMENTO_SAP IS NOT INITIAL.
        CALL FUNCTION 'ZSD_CHECK_MOV_CERTIFICADO'
          EXPORTING
            I_TP_MOV        = 'S'
            I_DOCNUM        = IT_NOTAS-NU_DOCUMENTO_SAP
            I_AUTORIZAR_MOV = 'X'.
      ENDIF.

      SELECT * FROM ZLEST0061
        INTO TABLE TL_ZLEST0061
      WHERE DOCNUM EQ IT_NOTAS-NU_DOCUMENTO_SAP.

      IF ( SY-SUBRC EQ 0 ).

        SELECT * FROM ZLEST0060
          INTO TABLE TL_ZLEST0060
          FOR ALL ENTRIES IN TL_ZLEST0061
        WHERE BUKRS      EQ TL_ZLEST0061-BUKRS
          AND WERKS      EQ TL_ZLEST0061-WERKS
          AND NR_VIAGEM  EQ TL_ZLEST0061-NR_VIAGEM
          AND ANO_VIAGEM EQ TL_ZLEST0061-ANO_VIAGEM
          AND NR_DCO     EQ TL_ZLEST0061-NR_DCO
          AND SAFRA      EQ TL_ZLEST0061-SAFRA
          AND CL_CODIGO  EQ TL_ZLEST0061-CL_CODIGO
          AND NOME_EMB   EQ TL_ZLEST0061-NOME_EMB
          AND DOCNUM     EQ TL_ZLEST0061-DOCNUM.

        LOOP AT TL_ZLEST0060 INTO WL_ZLEST0060.

          READ TABLE TL_ZLEST0061 INTO WL_ZLEST0061 WITH KEY BUKRS      = WL_ZLEST0060-BUKRS
                                                             WERKS      = WL_ZLEST0060-WERKS
                                                             NR_VIAGEM  = WL_ZLEST0060-NR_VIAGEM
                                                             ANO_VIAGEM = WL_ZLEST0060-ANO_VIAGEM
                                                             NR_DCO     = WL_ZLEST0060-NR_DCO
                                                             SAFRA      = WL_ZLEST0060-SAFRA
                                                             CL_CODIGO  = WL_ZLEST0060-CL_CODIGO
                                                             NOME_EMB   = WL_ZLEST0060-NOME_EMB
                                                             DOCNUM     = WL_ZLEST0060-DOCNUM.
          IF ( SY-SUBRC EQ 0 ).

            UPDATE ZSDT0001 SET DOCNUM_AQUAV =  IT_NOTAS-NU_DOCUMENTO_SAP
                                CT_AQUAV     = 'X'
                               WHERE NR_ROMANEIO  EQ WL_ZLEST0060-NR_ROMANEIO
                                                                           AND TP_MOVIMENTO EQ 'E'
                                                                           AND NR_SAFRA     EQ WL_ZLEST0060-SAFRA
                                                                           AND BUKRS        EQ WL_ZLEST0060-BUKRS
                                                                           AND BRANCH       EQ WL_ZLEST0060-DT_CODIGO.
          ENDIF.
          CLEAR: WL_ZLEST0060, WL_ZLEST0061.
        ENDLOOP.
      ENDIF.

      " Cancelamento
    ELSEIF IT_NOTAS-TP_AUTHCOD EQ '2'.
      "Nota Fiscal
      MOVE IT_NOTAS-DOCSTAT      TO LS_DOC_NEW-DOCSTAT.
      MOVE IT_NOTAS-AUTHCOD      TO LS_DOC_NEW-AUTHCOD.
      MOVE IT_NOTAS-CODE         TO LS_DOC_NEW-CODE.
      "Active Nota Fiscal
      MOVE 'C'                   TO LS_ACTTAB_NEW-ACTION_REQU.
      MOVE '2'                   TO LS_ACTTAB_NEW-SCSSTA.
      MOVE IT_NOTAS-AUTHCOD      TO LS_ACTTAB_NEW-AUTHCOD.
      MOVE 'X'                   TO LS_ACTTAB_NEW-CANCEL.
      MOVE 'B'                   TO LS_ACTTAB_NEW-MSSTAT.
      IF NOT LS_DOC_NEW-FORM IS INITIAL.
        PERFORM INSESIR_INF_SIMETRYA USING IT_NOTAS LS_ACTTAB_NEW.
      ENDIF.

      "Marcar registro de movimentação referente ao controle de Certificação Socioambiental como eliminado.
      IF IT_NOTAS-NU_DOCUMENTO_SAP IS NOT INITIAL.
        CALL FUNCTION 'ZSD_CHECK_MOV_CERTIFICADO'
          EXPORTING
            I_TP_MOV         = 'S'
            I_DOCNUM         = IT_NOTAS-NU_DOCUMENTO_SAP
            I_MARCAR_ESTORNO = 'X'.

*        TRY .
*            ZCL_AVERBACAO_SEGURO=>CANCELAR_AVERBACAO_CTE( I_DOCNUM = IT_NOTAS-NU_DOCUMENTO_SAP ).
*          CATCH ZCX_AVERBACAO_SEGURO.    "
*          CATCH ZCX_ARQUIVO.    "
*          CATCH ZCX_CADASTRO.    "
*        ENDTRY.

      ENDIF.

    ELSEIF IT_NOTAS-TP_AUTHCOD EQ '4'.

      IF ( IT_NOTAS-MODEL  = '55' ).  "Manifestão Destinatario NF-e

        CLEAR: WA_ZSDT0127.

        SELECT SINGLE *
          INTO WA_ZSDT0127
          FROM ZSDT0127
         WHERE DOC_MANIFESTO = IT_NOTAS-NU_DOCUMENTO_SAP.

        WA_ZSDT0127-TP_AUTHCOD    = IT_NOTAS-TP_AUTHCOD .
        WA_ZSDT0127-AUTHCODE      = IT_NOTAS-AUTHCOD .
        WA_ZSDT0127-DT_AUTHCOD    = IT_NOTAS-DT_AUTHCOD .
        WA_ZSDT0127-HR_AUTHCOD    = IT_NOTAS-HR_AUTHCOD .
        WA_ZSDT0127-CODE          = IT_NOTAS-CODE .
        WA_ZSDT0127-DT_ATUALIZADO = SY-DATUM.
        WA_ZSDT0127-HR_ATUALIZADO = SY-UZEIT.
        WA_ZSDT0127-MSG_RETORNO   = IT_NOTAS-MS_ERRO.
        WA_ZSDT0127-STATUS        = IT_NOTAS-DOCSTAT.
        WA_ZSDT0127-AUTORIZADO    = 'X'.

        MODIFY ZSDT0127 FROM WA_ZSDT0127.

      ELSE. "Autorização Uso MDF-e

        SELECT SINGLE *
          INTO WA_ZSDT0102
          FROM ZSDT0102
         WHERE DOCNUM = IT_NOTAS-NU_DOCUMENTO_SAP.

        WA_ZSDT0102-TP_AUTHCOD    = IT_NOTAS-TP_AUTHCOD .
        WA_ZSDT0102-XML_VERS      = IT_NOTAS-XMLVERS.
        WA_ZSDT0102-AUTHCODE      = IT_NOTAS-AUTHCOD .
        WA_ZSDT0102-DT_AUTHCOD    = IT_NOTAS-DT_AUTHCOD .
        WA_ZSDT0102-HR_AUTHCOD    = IT_NOTAS-HR_AUTHCOD .
        WA_ZSDT0102-CODE          = IT_NOTAS-CODE .
        WA_ZSDT0102-DT_ATUALIZADO = SY-DATUM.
        WA_ZSDT0102-HR_ATUALIZADO = SY-UZEIT.
        WA_ZSDT0102-MSG           = IT_NOTAS-MS_ERRO.
        WA_ZSDT0102-URL_SEFAZ     = IT_NOTAS-DS_URL_DANFE.
        WA_ZSDT0102-CDV           = IT_NOTAS-CDV.
        WA_ZSDT0102-DOCNUM9       = IT_NOTAS-DOCNUM9.
        WA_ZSDT0102-STATUS        = IT_NOTAS-DOCSTAT.
        WA_ZSDT0102-AUTORIZADO    = 'X'.

        CLEAR: WA_ZSDT0102-TRANSMISSAO.

        MODIFY ZSDT0102 FROM WA_ZSDT0102.

        "Registra Historico
        CLEAR: WA_ZSDT0107.
        WA_ZSDT0107-DOCNUM        = WA_ZSDT0102-DOCNUM.
        WA_ZSDT0107-NMDFE         = WA_ZSDT0102-NMDFE.
        WA_ZSDT0107-TP_AUTHCOD    = IT_NOTAS-TP_AUTHCOD.
        WA_ZSDT0107-AUTHCODE      = IT_NOTAS-AUTHCOD.
        WA_ZSDT0107-DT_AUTHCOD    = IT_NOTAS-DT_AUTHCOD.
        WA_ZSDT0107-HR_AUTHCOD    = IT_NOTAS-HR_AUTHCOD.
        WA_ZSDT0107-CODE          = IT_NOTAS-CODE.
        WA_ZSDT0107-MSG           = IT_NOTAS-MS_ERRO.
        INSERT ZSDT0107 FROM WA_ZSDT0107.

      ENDIF.

    ELSEIF IT_NOTAS-TP_AUTHCOD EQ '5'. "Cancelamento MDF-e

      SELECT SINGLE *
        INTO WA_ZSDT0102
        FROM ZSDT0102
       WHERE DOCNUM = IT_NOTAS-NU_DOCUMENTO_SAP.

      WA_ZSDT0102-TP_AUTHCOD    = IT_NOTAS-TP_AUTHCOD .
      WA_ZSDT0102-AUTHCODE      = IT_NOTAS-AUTHCOD .
      WA_ZSDT0102-DT_AUTHCOD    = IT_NOTAS-DT_AUTHCOD .
      WA_ZSDT0102-HR_AUTHCOD    = IT_NOTAS-HR_AUTHCOD .
      WA_ZSDT0102-CODE          = IT_NOTAS-CODE .
      WA_ZSDT0102-DT_ATUALIZADO = SY-DATUM.
      WA_ZSDT0102-HR_ATUALIZADO = SY-UZEIT.
      WA_ZSDT0102-MSG           = IT_NOTAS-MS_ERRO.
      WA_ZSDT0102-CANCEL        = 'X'.
      WA_ZSDT0102-STATUS        = IT_NOTAS-DOCSTAT.

      CLEAR: WA_ZSDT0102-TRANSMISSAO.

      MODIFY ZSDT0102 FROM WA_ZSDT0102.

      "Registra Historico
      CLEAR: WA_ZSDT0107.
      WA_ZSDT0107-DOCNUM        = WA_ZSDT0102-DOCNUM.
      WA_ZSDT0107-NMDFE         = WA_ZSDT0102-NMDFE.
      WA_ZSDT0107-TP_AUTHCOD    = IT_NOTAS-TP_AUTHCOD.
      WA_ZSDT0107-AUTHCODE      = IT_NOTAS-AUTHCOD.
      WA_ZSDT0107-DT_AUTHCOD    = IT_NOTAS-DT_AUTHCOD.
      WA_ZSDT0107-HR_AUTHCOD    = IT_NOTAS-HR_AUTHCOD.
      WA_ZSDT0107-CODE          = IT_NOTAS-CODE.
      WA_ZSDT0107-MSG           = IT_NOTAS-MS_ERRO.
      INSERT ZSDT0107 FROM WA_ZSDT0107.

    ELSEIF IT_NOTAS-TP_AUTHCOD EQ '6'. "Encerramento MDF-e

      SELECT SINGLE *
        INTO WA_ZSDT0102
        FROM ZSDT0102
       WHERE DOCNUM = IT_NOTAS-NU_DOCUMENTO_SAP.

      WA_ZSDT0102-TP_AUTHCOD    = IT_NOTAS-TP_AUTHCOD .
      WA_ZSDT0102-AUTHCODE      = IT_NOTAS-AUTHCOD .
      WA_ZSDT0102-DT_AUTHCOD    = IT_NOTAS-DT_AUTHCOD .
      WA_ZSDT0102-HR_AUTHCOD    = IT_NOTAS-HR_AUTHCOD .
      WA_ZSDT0102-CODE          = IT_NOTAS-CODE .
      WA_ZSDT0102-DT_ATUALIZADO = SY-DATUM.
      WA_ZSDT0102-HR_ATUALIZADO = SY-UZEIT.
      WA_ZSDT0102-MSG           = IT_NOTAS-MS_ERRO.
      WA_ZSDT0102-ENCERRADO     = 'X'.
      WA_ZSDT0102-STATUS        = IT_NOTAS-DOCSTAT.

      CLEAR: WA_ZSDT0102-TRANSMISSAO.

      MODIFY ZSDT0102 FROM WA_ZSDT0102.

      "Registra Historico
      CLEAR: WA_ZSDT0107.
      WA_ZSDT0107-DOCNUM        = WA_ZSDT0102-DOCNUM.
      WA_ZSDT0107-NMDFE         = WA_ZSDT0102-NMDFE.
      WA_ZSDT0107-TP_AUTHCOD    = IT_NOTAS-TP_AUTHCOD.
      WA_ZSDT0107-AUTHCODE      = IT_NOTAS-AUTHCOD.
      WA_ZSDT0107-DT_AUTHCOD    = IT_NOTAS-DT_AUTHCOD.
      WA_ZSDT0107-HR_AUTHCOD    = IT_NOTAS-HR_AUTHCOD.
      WA_ZSDT0107-CODE          = IT_NOTAS-CODE.
      WA_ZSDT0107-MSG           = IT_NOTAS-MS_ERRO.
      INSERT ZSDT0107 FROM WA_ZSDT0107.

    ENDIF.

    "Autorização Contingência
  ELSEIF IT_NOTAS-DOCSTAT EQ '5'.
    MOVE '1'                   TO LS_DOC_NEW-DOCSTAT.
    MOVE IT_NOTAS-AUTHCOD      TO LS_DOC_NEW-AUTHCOD.
    MOVE 'X'                   TO LS_DOC_NEW-CONTING.
    "Active Nota Fiscal
    MOVE 'C'                   TO LS_ACTTAB_NEW-ACTION_REQU.
    MOVE '0'                   TO LS_ACTTAB_NEW-SCSSTA.
    MOVE '1'                   TO LS_ACTTAB_NEW-DOCSTA.
    MOVE IT_NOTAS-CODE         TO LS_ACTTAB_NEW-CODE.
    MOVE 'A'                   TO LS_ACTTAB_NEW-MSSTAT.
    MOVE 'X'                   TO LS_ACTTAB_NEW-CONTING.
    MOVE IT_NOTAS-DOCNUM9      TO LS_ACTTAB_NEW-DOCNUM9.
    IF NOT IT_NOTAS-REGIAO IS INITIAL.
      MOVE IT_NOTAS-REGIAO       TO LS_ACTTAB_NEW-REGIO.
    ENDIF.
    MOVE IT_NOTAS-CDV          TO LS_ACTTAB_NEW-CDV.
    IF NOT LS_DOC_NEW-FORM IS INITIAL.
      PERFORM INSESIR_INF_SIMETRYA USING IT_NOTAS LS_ACTTAB_NEW.
    ENDIF.

    IF IT_NOTAS-TP_AUTHCOD EQ '4'.

      IF ( IT_NOTAS-MODEL  = '55' ).  "Manifestão Destinatario NF-e

        CLEAR: WA_ZSDT0127.

        SELECT SINGLE *
          FROM ZSDT0127 INTO WA_ZSDT0127
         WHERE DOC_MANIFESTO = IT_NOTAS-NU_DOCUMENTO_SAP.

        WA_ZSDT0127-TP_AUTHCOD    = IT_NOTAS-TP_AUTHCOD .
        WA_ZSDT0127-AUTHCODE      = IT_NOTAS-AUTHCOD .
        WA_ZSDT0127-DT_AUTHCOD    = IT_NOTAS-DT_AUTHCOD .
        WA_ZSDT0127-HR_AUTHCOD    = IT_NOTAS-HR_AUTHCOD .
        WA_ZSDT0127-CODE          = IT_NOTAS-CODE .
        WA_ZSDT0127-DT_ATUALIZADO = SY-DATUM.
        WA_ZSDT0127-HR_ATUALIZADO = SY-UZEIT.
        WA_ZSDT0127-MSG_RETORNO   = IT_NOTAS-MS_ERRO.
        WA_ZSDT0127-STATUS        = IT_NOTAS-DOCSTAT.
        WA_ZSDT0127-AUTORIZADO    = 'X'.

        MODIFY ZSDT0127 FROM WA_ZSDT0127.

      ELSE. "Envio MDF-e



        SELECT SINGLE *
          INTO WA_ZSDT0102
          FROM ZSDT0102
         WHERE DOCNUM = IT_NOTAS-NU_DOCUMENTO_SAP.

        WA_ZSDT0102-TP_AUTHCOD    = IT_NOTAS-TP_AUTHCOD .
        WA_ZSDT0102-XML_VERS      = IT_NOTAS-XMLVERS.
        WA_ZSDT0102-AUTHCODE      = IT_NOTAS-AUTHCOD .
        WA_ZSDT0102-DT_AUTHCOD    = IT_NOTAS-DT_AUTHCOD .
        WA_ZSDT0102-HR_AUTHCOD    = IT_NOTAS-HR_AUTHCOD .
        WA_ZSDT0102-CODE          = IT_NOTAS-CODE .
        WA_ZSDT0102-DT_ATUALIZADO = SY-DATUM.
        WA_ZSDT0102-HR_ATUALIZADO = SY-UZEIT.
        WA_ZSDT0102-MSG           = IT_NOTAS-MS_ERRO.
        WA_ZSDT0102-URL_SEFAZ     = IT_NOTAS-DS_URL_DANFE.
        WA_ZSDT0102-CDV           = IT_NOTAS-CDV.
        WA_ZSDT0102-DOCNUM9       = IT_NOTAS-DOCNUM9.
        WA_ZSDT0102-STATUS        = IT_NOTAS-DOCSTAT.
        WA_ZSDT0102-AUTORIZADO    = 'X'.

        CLEAR: WA_ZSDT0102-TRANSMISSAO.

        MODIFY ZSDT0102 FROM WA_ZSDT0102.

        "Registra Historico
        CLEAR: WA_ZSDT0107.
        WA_ZSDT0107-DOCNUM        = WA_ZSDT0102-DOCNUM.
        WA_ZSDT0107-NMDFE         = WA_ZSDT0102-NMDFE.
        WA_ZSDT0107-TP_AUTHCOD    = IT_NOTAS-TP_AUTHCOD.
        WA_ZSDT0107-AUTHCODE      = IT_NOTAS-AUTHCOD.
        WA_ZSDT0107-DT_AUTHCOD    = IT_NOTAS-DT_AUTHCOD.
        WA_ZSDT0107-HR_AUTHCOD    = IT_NOTAS-HR_AUTHCOD.
        WA_ZSDT0107-CODE          = IT_NOTAS-CODE.
        WA_ZSDT0107-MSG           = IT_NOTAS-MS_ERRO.
        INSERT ZSDT0107 FROM WA_ZSDT0107.

      ENDIF.

    ELSEIF IT_NOTAS-TP_AUTHCOD EQ '5'. "Cancelamento MDF-e

      SELECT SINGLE *
        INTO WA_ZSDT0102
        FROM ZSDT0102
       WHERE DOCNUM = IT_NOTAS-NU_DOCUMENTO_SAP.

      WA_ZSDT0102-TP_AUTHCOD    = IT_NOTAS-TP_AUTHCOD .
      WA_ZSDT0102-AUTHCODE      = IT_NOTAS-AUTHCOD .
      WA_ZSDT0102-DT_AUTHCOD    = IT_NOTAS-DT_AUTHCOD .
      WA_ZSDT0102-HR_AUTHCOD    = IT_NOTAS-HR_AUTHCOD .
      WA_ZSDT0102-CODE          = IT_NOTAS-CODE .
      WA_ZSDT0102-DT_ATUALIZADO = SY-DATUM.
      WA_ZSDT0102-HR_ATUALIZADO = SY-UZEIT.
      WA_ZSDT0102-MSG           = IT_NOTAS-MS_ERRO.
      WA_ZSDT0102-CANCEL        = 'X'.
      WA_ZSDT0102-STATUS        = IT_NOTAS-DOCSTAT.

      CLEAR: WA_ZSDT0102-TRANSMISSAO.

      MODIFY ZSDT0102 FROM WA_ZSDT0102.

      "Registra Historico
      CLEAR: WA_ZSDT0107.
      WA_ZSDT0107-DOCNUM        = WA_ZSDT0102-DOCNUM.
      WA_ZSDT0107-NMDFE         = WA_ZSDT0102-NMDFE.
      WA_ZSDT0107-TP_AUTHCOD    = IT_NOTAS-TP_AUTHCOD.
      WA_ZSDT0107-AUTHCODE      = IT_NOTAS-AUTHCOD.
      WA_ZSDT0107-DT_AUTHCOD    = IT_NOTAS-DT_AUTHCOD.
      WA_ZSDT0107-HR_AUTHCOD    = IT_NOTAS-HR_AUTHCOD.
      WA_ZSDT0107-CODE          = IT_NOTAS-CODE.
      WA_ZSDT0107-MSG           = IT_NOTAS-MS_ERRO.
      INSERT ZSDT0107 FROM WA_ZSDT0107.

    ELSEIF IT_NOTAS-TP_AUTHCOD EQ '6'. "Encerramento MDF-e

      SELECT SINGLE *
        INTO WA_ZSDT0102
        FROM ZSDT0102
       WHERE DOCNUM = IT_NOTAS-NU_DOCUMENTO_SAP.

      WA_ZSDT0102-TP_AUTHCOD    = IT_NOTAS-TP_AUTHCOD .
      WA_ZSDT0102-AUTHCODE      = IT_NOTAS-AUTHCOD .
      WA_ZSDT0102-DT_AUTHCOD    = IT_NOTAS-DT_AUTHCOD .
      WA_ZSDT0102-HR_AUTHCOD    = IT_NOTAS-HR_AUTHCOD .
      WA_ZSDT0102-CODE          = IT_NOTAS-CODE .
      WA_ZSDT0102-DT_ATUALIZADO = SY-DATUM.
      WA_ZSDT0102-HR_ATUALIZADO = SY-UZEIT.
      WA_ZSDT0102-MSG           = IT_NOTAS-MS_ERRO.
      WA_ZSDT0102-ENCERRADO     = 'X'.
      WA_ZSDT0102-STATUS        = IT_NOTAS-DOCSTAT.

      CLEAR: WA_ZSDT0102-TRANSMISSAO.

      MODIFY ZSDT0102 FROM WA_ZSDT0102.

      "Registra Historico
      CLEAR: WA_ZSDT0107.
      WA_ZSDT0107-DOCNUM        = WA_ZSDT0102-DOCNUM.
      WA_ZSDT0107-NMDFE         = WA_ZSDT0102-NMDFE.
      WA_ZSDT0107-TP_AUTHCOD    = IT_NOTAS-TP_AUTHCOD.
      WA_ZSDT0107-AUTHCODE      = IT_NOTAS-AUTHCOD.
      WA_ZSDT0107-DT_AUTHCOD    = IT_NOTAS-DT_AUTHCOD.
      WA_ZSDT0107-HR_AUTHCOD    = IT_NOTAS-HR_AUTHCOD.
      WA_ZSDT0107-CODE          = IT_NOTAS-CODE.
      WA_ZSDT0107-MSG           = IT_NOTAS-MS_ERRO.
      INSERT ZSDT0107 FROM WA_ZSDT0107.

    ENDIF.

    "Denegada
  ELSEIF IT_NOTAS-DOCSTAT EQ '2'.
    MOVE '2'                   TO LS_DOC_NEW-DOCSTAT.
    "MOVE it_notas-docstat      TO ls_doc_new-docstat.
    MOVE 'V'                   TO LS_ACTTAB_NEW-MSSTAT.
    MOVE '2'                   TO LS_ACTTAB_NEW-DOCSTA.
    "MOVE it_notas-docstat      TO ls_acttab_new-docsta.
    MOVE '4'                   TO LS_ACTTAB_NEW-SCSSTA.
    MOVE '1'                   TO LS_ACTTAB_NEW-ACTION_REQU.
    MOVE IT_NOTAS-CODE         TO LS_ACTTAB_NEW-CODE.
    MOVE IT_NOTAS-DS_URL_DANFE TO LS_ACTTAB_NEW-REASON1.
    "    PERFORM registra_log USING ls_acttab_new ls_doc_new.
    PERFORM REGISTRA_LOG USING LS_ACTTAB_NEW LS_DOC_NEW IT_NOTAS.
  ENDIF.

  MOVE-CORRESPONDING LS_ACTTAB_NEW TO LS_HISTTAB_NEW.

* Check existing key entries for history table
  CALL FUNCTION 'J_1B_NFE_HISTORY_COUNT'
    CHANGING
      CH_HISTORY = LS_HISTTAB_NEW.

  UPDATE J_1BNFE_ACTIVE FROM LS_ACTTAB_NEW.
  UPDATE J_1BNFDOC FROM LS_DOC_NEW.

  CHECK NOT LS_DOC_NEW-FORM IS INITIAL.

* BBKO/Pathelle Atualizações Tabelas - Início 20/07/2010
  CALL FUNCTION 'ZSD_ATUALIZA_NFE'
    EXPORTING
      IN_NOTAS = IT_NOTAS
      IN_DOC   = LS_DOC_NEW.
* BBKO/Pathelle Atualizações Tabelas - Fim   20/07/2010

  CALL FUNCTION 'Z_LES_FINALIZA_VT'
    EXPORTING
      P_DOCNUM = LS_DOC_NEW-DOCNUM.

ENDFUNCTION.
