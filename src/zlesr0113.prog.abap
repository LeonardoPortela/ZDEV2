*&---------------------------------------------------------------------*
*& Report  ZLESR0113
*&
*&---------------------------------------------------------------------*
*&
*&
*&---------------------------------------------------------------------*
REPORT ZLESR0113.

TABLES: ZSDT0001.

DATA: TG_ZSDT0001  TYPE TABLE OF ZSDT0001  WITH HEADER LINE,
      TG_ZLEST0149 TYPE TABLE OF ZLEST0149 WITH HEADER LINE.


SELECTION-SCREEN BEGIN OF BLOCK A1.
SELECT-OPTIONS:
    P_BUKRS  FOR ZSDT0001-BUKRS  NO INTERVALS NO-EXTENSION NO-DISPLAY,
    P_BRANCH FOR ZSDT0001-BRANCH NO INTERVALS NO-EXTENSION NO-DISPLAY,
    P_DTINI  FOR ZSDT0001-DT_MOVIMENTO NO INTERVALS NO-EXTENSION NO-DISPLAY.
SELECTION-SCREEN END   OF BLOCK A1.

START-OF-SELECTION.

  DATA: VG_JOB      TYPE I.

  SELECT SINGLE COUNT( * ) INTO VG_JOB
    FROM TBTCO
   WHERE JOBNAME EQ 'ZLESR0113_JOB'
     AND STATUS EQ 'R'.

  IF ( VG_JOB EQ 1 ) OR ( P_DTINI-LOW IS NOT INITIAL ).
    PERFORM: F_SELECIONA_DADOS,
             F_PROCESSAR_DADOS.
  ENDIF.

FORM F_SELECIONA_DADOS .

  RANGES: R_LOC_DESCARGA FOR ZSDT0001-LOCAL_DESCARGA.

  PERFORM: F_INICIAR_VARIAVEIS.

  "Get Local Descargas parametrizados.
  SELECT *
    FROM SETLEAF INTO TABLE @DATA(_TG_SET_LEAF)
   WHERE SETNAME = 'ZLES0147_ROM_CCT'.

  DELETE _TG_SET_LEAF WHERE VALFROM IS INITIAL.

  CHECK _TG_SET_LEAF[] IS NOT INITIAL.

  LOOP AT _TG_SET_LEAF INTO DATA(WL_SET).
    R_LOC_DESCARGA-SIGN   = 'I'.
    R_LOC_DESCARGA-OPTION = 'EQ'.
    R_LOC_DESCARGA-LOW    = WL_SET-VALFROM.
    APPEND R_LOC_DESCARGA.
  ENDLOOP.

  SELECT *
    FROM ZLEST0149 INTO TABLE TG_ZLEST0149.

  LOOP AT TG_ZLEST0149.

    CHECK ( TG_ZLEST0149-BUKRS       IS NOT INITIAL ) AND
          ( TG_ZLEST0149-BRANCH      IS NOT INITIAL ) AND
          ( TG_ZLEST0149-DT_INI_ROM  IS NOT INITIAL ).

    IF P_DTINI-LOW IS NOT INITIAL. "Chamado por submit
      SELECT *
        FROM ZSDT0001 APPENDING CORRESPONDING FIELDS OF TABLE TG_ZSDT0001
       WHERE BUKRS           =  TG_ZLEST0149-BUKRS
         AND BRANCH          =  TG_ZLEST0149-BRANCH
         AND DT_MOVIMENTO    >= TG_ZLEST0149-DT_INI_ROM
         AND BUKRS           =  P_BUKRS-LOW
         AND BRANCH          =  P_BRANCH-LOW
         AND DT_MOVIMENTO    >= P_DTINI-LOW
         AND TP_MOVIMENTO    =  'E'
         AND ST_CCT          IN  ( '','03' )
         AND LOCAL_DESCARGA  IN R_LOC_DESCARGA.
    ELSE.
      SELECT *
        FROM ZSDT0001 APPENDING CORRESPONDING FIELDS OF TABLE TG_ZSDT0001
       WHERE BUKRS           =  TG_ZLEST0149-BUKRS
         AND BRANCH          =  TG_ZLEST0149-BRANCH
         AND DT_MOVIMENTO    >= TG_ZLEST0149-DT_INI_ROM
         AND TP_MOVIMENTO    =  'E'
         AND ST_CCT          IN  ( '','03' )
         AND LOCAL_DESCARGA  IN R_LOC_DESCARGA.
    ENDIF.

  ENDLOOP.

ENDFORM.

FORM F_PROCESSAR_DADOS .

  DATA: ZCL_CCT_CONTROL_NF TYPE REF TO ZCL_CCT_CONTROL_NF.

  LOOP AT TG_ZLEST0149.

    LOOP AT TG_ZSDT0001 WHERE BUKRS  = TG_ZLEST0149-BUKRS
                          AND BRANCH = TG_ZLEST0149-BRANCH.

      FREE ZCL_CCT_CONTROL_NF.
      CREATE OBJECT ZCL_CCT_CONTROL_NF.
      DATA(_ATRIB) = ZCL_CCT_CONTROL_NF->ATRIBUIR_NF_ROM( I_CH_REFERENCIA = TG_ZSDT0001-CH_REFERENCIA ).
      IF _ATRIB EQ ABAP_TRUE.
        ZCL_CCT_CONTROL_NF->DISP_NF_CCT( ).
      ENDIF.

    ENDLOOP.

  ENDLOOP.

ENDFORM.

FORM F_INICIAR_VARIAVEIS .

  CLEAR: TG_ZSDT0001[], TG_ZLEST0149[].

ENDFORM.
