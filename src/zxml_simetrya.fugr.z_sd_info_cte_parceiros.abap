FUNCTION Z_SD_INFO_CTE_PARCEIROS .
*"----------------------------------------------------------------------
*"*"Interface local:
*"  IMPORTING
*"     REFERENCE(P_CTE_AVULSO) TYPE  J_1BDOCNUM
*"     REFERENCE(P_CTE_GERA) TYPE  CHAR01 OPTIONAL
*"     VALUE(DESTINATARIO) TYPE  J_1BNFNAD OPTIONAL
*"  EXPORTING
*"     REFERENCE(P_PARCEIROS) TYPE  ZCTE_PARCEIROS
*"  CHANGING
*"     VALUE(P_DOC_TRANSP) TYPE  VTTK OPTIONAL
*"----------------------------------------------------------------------

  DATA: WA_J_1BNFDOC     TYPE J_1BNFDOC,
        WA_J_1BNFDOC_NF  TYPE J_1BNFDOC,
        WA_J_1BNFLIN     TYPE J_1BNFLIN,
        CIDADE           TYPE J_1BTXJURT,
        WA_J_1BBRANCH    TYPE J_1BBRANCH,
        WA_ADRC          TYPE ADRC,
        WA_KNA1          TYPE KNA1,
        WA_LFA1          TYPE LFA1,
        WA_VTTK          TYPE VTTK,
        WA_VTPA          TYPE VTPA,
        WA_VBRP          TYPE VBRP,
        WA_VBAK          TYPE VBAK,
        WA_VTTP          TYPE VTTP,
        WA_VBPA          TYPE VBPA,
        WA_ZSDT0022      TYPE ZSDT0022,
        IT_CTE_INFO_NOTA TYPE TABLE OF ZCTE_INFO_NOTA WITH HEADER LINE,
        P_PARID          TYPE J_1BPARID,
        P_PARID_WE       TYPE J_1BPARID,
        P_PARID_PC       TYPE J_1BPARID,
        P_PARID_LR       TYPE J_1BPARID,
        P_PARID_RG       TYPE J_1BPARID.

  IF P_DOC_TRANSP IS INITIAL.
    CALL FUNCTION 'Z_SD_INFO_CTE_IDENT'
      EXPORTING
        P_CTE_AVULSO = P_CTE_AVULSO
        P_CTE_GERA   = C_X
      CHANGING
        P_DOC_TRANSP = P_DOC_TRANSP.
  ENDIF.

  IF P_CTE_GERA IS INITIAL.
    SELECT SINGLE * INTO P_PARCEIROS
      FROM ZCTE_PARCEIROS
     WHERE DOCNUM EQ P_CTE_AVULSO.
  ELSE.
    CLEAR WA_J_1BNFDOC_NF.
    CALL FUNCTION 'Z_SD_INFO_CTE_NOTAS'
      EXPORTING
        P_CTE_AVULSO     = P_CTE_AVULSO
        P_CTE_GERA       = C_X
      IMPORTING
        DESTINATARIO     = DESTINATARIO
      TABLES
        IT_CTE_INFO_NOTA = IT_CTE_INFO_NOTA
      EXCEPTIONS
        SEM_NOTAS        = 1
        OTHERS           = 2.

    IF SY-SUBRC IS INITIAL.
      READ TABLE IT_CTE_INFO_NOTA INDEX 1.

      SELECT SINGLE * INTO WA_J_1BNFDOC_NF
        FROM J_1BNFDOC
       WHERE DOCNUM EQ IT_CTE_INFO_NOTA-DOCNUM_NF
       AND   DOCNUM NE 0.
    ENDIF.

    P_PARCEIROS-DOCNUM = P_CTE_AVULSO.

    SELECT SINGLE * INTO WA_J_1BNFDOC
      FROM J_1BNFDOC
     WHERE DOCNUM EQ P_CTE_AVULSO.

    CHECK SY-SUBRC IS INITIAL.

    CLEAR: WA_J_1BBRANCH, WA_ADRC.

    "Busca Emissor do Conhecimento
    SELECT SINGLE * INTO WA_J_1BBRANCH
      FROM J_1BBRANCH
     WHERE BUKRS  = WA_J_1BNFDOC-BUKRS
       AND BRANCH = WA_J_1BNFDOC-BRANCH.

    IF SY-SUBRC IS INITIAL.

      SELECT SINGLE * INTO WA_ADRC
        FROM ADRC
       WHERE ADDRNUMBER EQ WA_J_1BBRANCH-ADRNR.

      CALL FUNCTION 'CONVERSION_EXIT_ALPHA_INPUT'
        EXPORTING
          INPUT  = WA_J_1BNFDOC-BRANCH
        IMPORTING
          OUTPUT = P_PARCEIROS-EMIT_CODIGO.

      P_PARCEIROS-EMIT_CNPJ    = WA_J_1BBRANCH-STCD1.
      P_PARCEIROS-EMIT_IE      = WA_J_1BBRANCH-STATE_INSC.
      P_PARCEIROS-EMIT_XNOME   = WA_ADRC-NAME1.
      P_PARCEIROS-EMIT_XFANT   = WA_ADRC-NAME1.
      P_PARCEIROS-EMIT_XLGR    = WA_ADRC-STREET(25).
      IF WA_ADRC-HOUSE_NUM1 IS INITIAL.
        P_PARCEIROS-EMIT_NRO     = C_SN.
      ELSE.
        P_PARCEIROS-EMIT_NRO     = WA_ADRC-HOUSE_NUM1.
      ENDIF.
      "p_parceiros-emit_xcpl    = emitente-.
      P_PARCEIROS-EMIT_XBAIRRO = WA_ADRC-CITY2.
      P_PARCEIROS-EMIT_UF      = WA_ADRC-TAXJURCODE(3).
      P_PARCEIROS-EMIT_CMUN    = WA_ADRC-TAXJURCODE+3(7).

      SELECT SINGLE * INTO CIDADE
        FROM J_1BTXJURT
       WHERE SPRAS      = WA_ADRC-LANGU
         AND COUNTRY    = WA_ADRC-COUNTRY
         AND TAXJURCODE = WA_ADRC-TAXJURCODE.

      IF SY-SUBRC IS INITIAL.
        P_PARCEIROS-EMIT_XMUN    = CIDADE-TEXT.
      ENDIF.
      P_PARCEIROS-EMIT_CEP     = WA_ADRC-POST_CODE1.
      P_PARCEIROS-EMIT_UF      = WA_ADRC-REGION.
      P_PARCEIROS-EMIT_FONE    = WA_ADRC-TEL_NUMBER.

    ENDIF.

    IF ( WA_J_1BNFDOC_NF-DIRECT NE '1'  ) AND
       ( WA_J_1BNFDOC_NF IS NOT INITIAL ) AND
       ( P_DOC_TRANSP-SHTYP NE 'Z005'   ) .

      CLEAR: WA_J_1BBRANCH, WA_ADRC.
      CLEAR: WA_J_1BNFLIN, WA_VBRP, WA_VBAK, WA_ZSDT0022.

      SELECT SINGLE * FROM J_1BNFLIN INTO WA_J_1BNFLIN WHERE DOCNUM EQ WA_J_1BNFDOC-DOCNUM.
      SELECT SINGLE * FROM VBRP      INTO WA_VBRP      WHERE VBELN  EQ WA_J_1BNFLIN-REFKEY.
      SELECT SINGLE * FROM VBAK      INTO WA_VBAK      WHERE VBELN  EQ WA_VBRP-VGBEL.
      SELECT SINGLE * FROM ZSDT0022  INTO WA_ZSDT0022  WHERE AUART  EQ WA_VBAK-AUART.

      IF ( SY-SUBRC NE 0                      ) AND
         ( WA_J_1BNFDOC-DOCTYP = '2'          ) AND "Complentar
         ( WA_J_1BNFDOC-DOCREF IS NOT INITIAL ).

        SELECT SINGLE * FROM J_1BNFLIN INTO @DATA(_WL_LIN)  WHERE DOCNUM EQ @WA_J_1BNFDOC-DOCREF.
        SELECT SINGLE * FROM VBRP      INTO @DATA(_WL_VBRP) WHERE VBELN  EQ @_WL_LIN-REFKEY.
        SELECT SINGLE * FROM VBAK      INTO @DATA(_WL_VBAK) WHERE VBELN  EQ @_WL_VBRP-VGBEL.
        SELECT SINGLE * FROM ZSDT0022  INTO WA_ZSDT0022  WHERE AUART EQ _WL_VBAK-AUART.
      ENDIF.

      CASE WA_ZSDT0022-FATURA.
        WHEN: 'P'.

          CALL FUNCTION 'CONVERSION_EXIT_ALPHA_INPUT'
            EXPORTING
              INPUT  = WA_J_1BNFDOC-PARID
            IMPORTING
              OUTPUT = WA_J_1BNFDOC-PARID.

          "Busca Remetente de Mercadoria
          SELECT SINGLE * INTO WA_J_1BBRANCH
            FROM J_1BBRANCH
           WHERE BUKRS  = WA_J_1BNFDOC-BUKRS
             AND BRANCH = WA_J_1BNFDOC-PARID+6(4).

        WHEN: 'T'.

          CALL FUNCTION 'CONVERSION_EXIT_ALPHA_INPUT'
            EXPORTING
              INPUT  = WA_J_1BNFDOC_NF-PARID
            IMPORTING
              OUTPUT = WA_J_1BNFDOC_NF-PARID.

          SELECT SINGLE * INTO WA_J_1BBRANCH
            FROM J_1BBRANCH
           WHERE BUKRS  = WA_J_1BNFDOC_NF-BUKRS
             AND BRANCH = WA_J_1BNFDOC_NF-BRANCH.

      ENDCASE.

      IF P_DOC_TRANSP-SHTYP EQ 'Z020'. "19.02.2018
        SELECT SINGLE * INTO WA_J_1BBRANCH
          FROM J_1BBRANCH
         WHERE BUKRS  = WA_J_1BNFDOC_NF-BUKRS
           AND BRANCH = WA_J_1BNFDOC_NF-BRANCH.
      ENDIF.

      IF SY-SUBRC IS INITIAL.

        SELECT SINGLE * INTO WA_ADRC
          FROM ADRC
         WHERE ADDRNUMBER EQ WA_J_1BBRANCH-ADRNR.

        "19.02.2018
*        CALL FUNCTION 'CONVERSION_EXIT_ALPHA_INPUT'
*          EXPORTING
*            INPUT  = WA_J_1BNFDOC-PARID
*          IMPORTING
*            OUTPUT = P_PARCEIROS-REME_CODIGO.

        CALL FUNCTION 'CONVERSION_EXIT_ALPHA_INPUT'
          EXPORTING
            INPUT  = WA_J_1BBRANCH-BRANCH
          IMPORTING
            OUTPUT = P_PARCEIROS-REME_CODIGO.

        P_PARCEIROS-REME_CNPJ    = WA_J_1BBRANCH-STCD1.
        P_PARCEIROS-REME_IE      = WA_J_1BBRANCH-STATE_INSC.
        P_PARCEIROS-REME_XNOME   = WA_ADRC-NAME1.
        P_PARCEIROS-REME_XFANT   = WA_ADRC-NAME1.
        P_PARCEIROS-REME_XLGR    = WA_ADRC-STREET(25).
        IF WA_ADRC-HOUSE_NUM1 IS INITIAL.
          P_PARCEIROS-REME_NRO     = C_SN.
        ELSE.
          P_PARCEIROS-REME_NRO     = WA_ADRC-HOUSE_NUM1.
        ENDIF.
        "p_parceiros-emit_xcpl    = emitente-.
        P_PARCEIROS-REME_XBAIRRO = WA_ADRC-CITY2.
        P_PARCEIROS-REME_CMUN    = WA_ADRC-TAXJURCODE+3(7).

        SELECT SINGLE * INTO CIDADE
          FROM J_1BTXJURT
         WHERE SPRAS      = WA_ADRC-LANGU
           AND COUNTRY    = WA_ADRC-COUNTRY
           AND TAXJURCODE = WA_ADRC-TAXJURCODE.

        IF SY-SUBRC IS INITIAL.
          P_PARCEIROS-REME_XMUN    = CIDADE-TEXT.
        ENDIF.
        P_PARCEIROS-REME_CEP     = WA_ADRC-POST_CODE1.
        P_PARCEIROS-REME_UF      = WA_ADRC-REGION.
        P_PARCEIROS-REME_FONE    = WA_ADRC-TEL_NUMBER.
      ENDIF.

      IF DESTINATARIO IS NOT INITIAL.

        CLEAR: WA_KNA1, WA_ADRC.

        "Busca Emissor do Conhecimento
        SELECT SINGLE * INTO WA_KNA1
          FROM KNA1
         WHERE KUNNR EQ DESTINATARIO-PARID.

        IF SY-SUBRC IS INITIAL.

          SELECT SINGLE * INTO WA_ADRC
            FROM ADRC
            WHERE ADDRNUMBER EQ WA_KNA1-ADRNR.

          P_PARCEIROS-DEST_CODIGO  = DESTINATARIO-PARID.
          IF WA_KNA1-STKZN IS INITIAL.
            P_PARCEIROS-DEST_CNPJ = WA_KNA1-STCD1.
          ELSE.
            P_PARCEIROS-DEST_CPF = WA_KNA1-STCD2.
          ENDIF.
          P_PARCEIROS-DEST_IE      = WA_KNA1-STCD3.
          P_PARCEIROS-DEST_XNOME   = WA_KNA1-NAME1.
          P_PARCEIROS-DEST_XFANT   = WA_KNA1-NAME1.
          P_PARCEIROS-DEST_XLGR    = WA_ADRC-STREET(25).

          IF WA_ADRC-HOUSE_NUM1 IS INITIAL.
            P_PARCEIROS-DEST_NRO     = C_SN.
          ELSE.
            P_PARCEIROS-DEST_NRO     = WA_ADRC-HOUSE_NUM1.
          ENDIF.

          "p_parceiros-emit_xcpl    = emitente-.
          P_PARCEIROS-DEST_XBAIRRO = WA_ADRC-CITY2.
          P_PARCEIROS-DEST_CMUN    = WA_ADRC-TAXJURCODE+3(7).

          SELECT SINGLE * INTO CIDADE
            FROM J_1BTXJURT
           WHERE SPRAS      = WA_ADRC-LANGU
             AND COUNTRY    = WA_ADRC-COUNTRY
             AND TAXJURCODE = WA_ADRC-TAXJURCODE.

          IF SY-SUBRC IS INITIAL.
            P_PARCEIROS-DEST_XMUN    = CIDADE-TEXT.
          ENDIF.

          P_PARCEIROS-DEST_CEP     = WA_ADRC-POST_CODE1.
          P_PARCEIROS-DEST_UF      = WA_ADRC-REGION.
          P_PARCEIROS-DEST_FONE    = WA_ADRC-TEL_NUMBER.
        ENDIF.

      ENDIF.

    ELSEIF ( P_DOC_TRANSP-ABFER = C_1 ) AND
           ( ( P_DOC_TRANSP-SHTYP EQ C_Z026 ) OR
             ( P_DOC_TRANSP-SHTYP EQ 'Z005' ) OR
             ( P_DOC_TRANSP-SHTYP EQ 'Z025' ) OR
             ( P_DOC_TRANSP-SHTYP EQ 'Z009' ) ) .

      CALL FUNCTION 'Z_REMETENTE_MERCADORIA_CTE'
        EXPORTING
          P_DOCNUM   = P_CTE_AVULSO
        CHANGING
          P_PARID    = P_PARID    "Remetente da Mercadoria
          P_PARID_WE = P_PARID_WE "Receberdor da Mercadoria
          P_PARID_PC = P_PARID_PC "Ponto de Coleta
          P_PARID_LR = P_PARID_LR "Local de Entrega
          P_PARID_RG = P_PARID_RG. "Tomador de Serviço

      SELECT SINGLE * INTO WA_LFA1 FROM LFA1 WHERE LIFNR EQ P_PARID.
      IF SY-SUBRC IS INITIAL.
        SELECT SINGLE * INTO WA_ADRC
          FROM ADRC
         WHERE ADDRNUMBER EQ WA_LFA1-ADRNR.
        P_PARCEIROS-REME_CODIGO  = WA_LFA1-LIFNR.
        IF WA_LFA1-STKZN IS INITIAL.
          P_PARCEIROS-REME_CNPJ = WA_LFA1-STCD1.
        ELSE.
          P_PARCEIROS-REME_CPF  = WA_LFA1-STCD2.
        ENDIF.
        P_PARCEIROS-REME_IE      = WA_LFA1-STCD3.
        P_PARCEIROS-REME_XNOME   = WA_ADRC-NAME1.
        P_PARCEIROS-REME_XFANT   = WA_ADRC-NAME1.
        P_PARCEIROS-REME_XLGR    = WA_ADRC-STREET(25).
        IF WA_ADRC-HOUSE_NUM1 IS INITIAL.
          P_PARCEIROS-REME_NRO     = C_SN.
        ELSE.
          P_PARCEIROS-REME_NRO     = WA_ADRC-HOUSE_NUM1.
        ENDIF.
        "p_parceiros-emit_xcpl    = emitente-.
        P_PARCEIROS-REME_XBAIRRO = WA_ADRC-CITY2.
        P_PARCEIROS-REME_CMUN    = WA_ADRC-TAXJURCODE+3(7).
        SELECT SINGLE * INTO CIDADE
          FROM J_1BTXJURT
         WHERE SPRAS      = WA_ADRC-LANGU
           AND COUNTRY    = WA_ADRC-COUNTRY
           AND TAXJURCODE = WA_ADRC-TAXJURCODE.
        IF SY-SUBRC IS INITIAL.
          P_PARCEIROS-REME_XMUN    = CIDADE-TEXT.
        ENDIF.
        P_PARCEIROS-REME_CEP     = WA_ADRC-POST_CODE1.
        P_PARCEIROS-REME_UF      = WA_ADRC-REGION.
        P_PARCEIROS-REME_FONE    = WA_ADRC-TEL_NUMBER.
      ENDIF.

      SELECT SINGLE * INTO WA_KNA1 FROM KNA1 WHERE KUNNR EQ P_PARID_WE.
      IF SY-SUBRC IS INITIAL.

        SELECT SINGLE * INTO WA_ADRC
          FROM ADRC
          WHERE ADDRNUMBER EQ WA_KNA1-ADRNR.

        P_PARCEIROS-DEST_CODIGO  = WA_KNA1-KUNNR.
        IF WA_KNA1-STKZN IS INITIAL.
          P_PARCEIROS-DEST_CNPJ = WA_KNA1-STCD1.
        ELSE.
          P_PARCEIROS-DEST_CPF = WA_KNA1-STCD2.
        ENDIF.
        P_PARCEIROS-DEST_IE      = WA_KNA1-STCD3.
        P_PARCEIROS-DEST_XNOME   = WA_KNA1-NAME1.
        P_PARCEIROS-DEST_XFANT   = WA_KNA1-NAME1.
        P_PARCEIROS-DEST_XLGR    = WA_ADRC-STREET(25).
        IF WA_ADRC-HOUSE_NUM1 IS INITIAL.
          P_PARCEIROS-DEST_NRO     = C_SN.
        ELSE.
          P_PARCEIROS-DEST_NRO     = WA_ADRC-HOUSE_NUM1.
        ENDIF.
        "p_parceiros-emit_xcpl    = emitente-.
        P_PARCEIROS-DEST_XBAIRRO = WA_ADRC-CITY2.
        P_PARCEIROS-DEST_CMUN    = WA_ADRC-TAXJURCODE+3(7).
        SELECT SINGLE * INTO CIDADE
          FROM J_1BTXJURT
         WHERE SPRAS      = WA_ADRC-LANGU
           AND COUNTRY    = WA_ADRC-COUNTRY
           AND TAXJURCODE = WA_ADRC-TAXJURCODE.
        IF SY-SUBRC IS INITIAL.
          P_PARCEIROS-DEST_XMUN    = CIDADE-TEXT.
        ENDIF.
        P_PARCEIROS-DEST_CEP     = WA_ADRC-POST_CODE1.
        P_PARCEIROS-DEST_UF      = WA_ADRC-REGION.
        P_PARCEIROS-DEST_FONE    = WA_ADRC-TEL_NUMBER.
      ENDIF.

      "Nota Fiscal de entrada emitente é fornecedor
      SELECT SINGLE * INTO WA_LFA1 FROM LFA1 WHERE LIFNR EQ P_PARID_PC.

      IF SY-SUBRC IS INITIAL.

        SELECT SINGLE * INTO WA_ADRC
          FROM ADRC
         WHERE ADDRNUMBER EQ WA_LFA1-ADRNR.

        P_PARCEIROS-COLE_CODIGO = WA_LFA1-LIFNR.
        IF WA_LFA1-STKZN IS INITIAL.
          P_PARCEIROS-COLE_CNPJ = WA_LFA1-STCD1.
        ELSE.
          P_PARCEIROS-COLE_CPF = WA_LFA1-STCD2.
        ENDIF.
        P_PARCEIROS-COLE_IE      = WA_LFA1-STCD3.
        P_PARCEIROS-COLE_XNOME   = WA_LFA1-NAME1.
        P_PARCEIROS-COLE_XFANT   = WA_LFA1-NAME1.
        P_PARCEIROS-COLE_XLGR    = WA_ADRC-STREET(25).
        IF WA_ADRC-HOUSE_NUM1 IS INITIAL.
          P_PARCEIROS-COLE_NRO     = C_SN.
        ELSE.
          P_PARCEIROS-COLE_NRO     = WA_ADRC-HOUSE_NUM1.
        ENDIF.
        "p_parceiros-emit_xcpl    = emitente-.
        P_PARCEIROS-COLE_XBAIRRO = WA_ADRC-CITY2.
        P_PARCEIROS-COLE_CMUN    = WA_ADRC-TAXJURCODE+3(7).

        SELECT SINGLE * INTO CIDADE
          FROM J_1BTXJURT
         WHERE SPRAS      = WA_ADRC-LANGU
           AND COUNTRY    = WA_ADRC-COUNTRY
           AND TAXJURCODE = WA_ADRC-TAXJURCODE.

        IF SY-SUBRC IS INITIAL.
          P_PARCEIROS-COLE_XMUN    = CIDADE-TEXT.
        ENDIF.
        P_PARCEIROS-COLE_CEP     = WA_ADRC-POST_CODE1.
        P_PARCEIROS-COLE_UF      = WA_ADRC-REGION.
        P_PARCEIROS-COLE_FONE    = WA_ADRC-TEL_NUMBER.
      ENDIF.


      IF P_DOC_TRANSP-SHTYP EQ 'Z009'.
        SELECT SINGLE * INTO WA_KNA1 FROM KNA1 WHERE KUNNR EQ P_PARID_WE.
      ELSE.
        SELECT SINGLE * INTO WA_KNA1 FROM KNA1 WHERE KUNNR EQ P_PARID_RG.
      ENDIF.
      IF SY-SUBRC IS INITIAL.

        SELECT SINGLE * INTO WA_ADRC
          FROM ADRC
          WHERE ADDRNUMBER EQ WA_KNA1-ADRNR.

        P_PARCEIROS-TOMA_CODIGO  = WA_KNA1-KUNNR.
        IF WA_KNA1-STKZN IS INITIAL.
          P_PARCEIROS-TOMA_CNPJ = WA_KNA1-STCD1.
        ELSE.
          P_PARCEIROS-TOMA_CPF = WA_KNA1-STCD2.
        ENDIF.
        P_PARCEIROS-TOMA_IE      = WA_KNA1-STCD3.
        P_PARCEIROS-TOMA_XNOME   = WA_KNA1-NAME1.
        P_PARCEIROS-TOMA_XFANT   = WA_KNA1-NAME1.
        P_PARCEIROS-TOMA_XLGR    = WA_ADRC-STREET(25).
        IF WA_ADRC-HOUSE_NUM1 IS INITIAL.
          P_PARCEIROS-TOMA_NRO     = C_SN.
        ELSE.
          P_PARCEIROS-TOMA_NRO     = WA_ADRC-HOUSE_NUM1.
        ENDIF.
        "p_parceiros-emit_xcpl    = emitente-.
        P_PARCEIROS-TOMA_XBAIRRO = WA_ADRC-CITY2.
        P_PARCEIROS-TOMA_CMUN    = WA_ADRC-TAXJURCODE+3(7).
        SELECT SINGLE * INTO CIDADE
          FROM J_1BTXJURT
         WHERE SPRAS      = WA_ADRC-LANGU
           AND COUNTRY    = WA_ADRC-COUNTRY
           AND TAXJURCODE = WA_ADRC-TAXJURCODE.
        IF SY-SUBRC IS INITIAL.
          P_PARCEIROS-DEST_XMUN    = CIDADE-TEXT.
        ENDIF.
        P_PARCEIROS-TOMA_CEP     = WA_ADRC-POST_CODE1.
        P_PARCEIROS-TOMA_UF      = WA_ADRC-REGION.
        P_PARCEIROS-TOMA_FONE    = WA_ADRC-TEL_NUMBER.
      ENDIF.

    ELSE.
      CLEAR: WA_LFA1, WA_ADRC.

      "Nota Fiscal de entrada emitente é fornecedor
      IF IT_CTE_INFO_NOTA[] IS INITIAL.
        SELECT SINGLE * FROM VTTP INTO WA_VTTP WHERE TKNUM EQ P_DOC_TRANSP-TKNUM.
        IF ( SY-SUBRC EQ 0 ).
          SELECT SINGLE * FROM VBPA INTO WA_VBPA WHERE VBELN EQ WA_VTTP-VBELN
                                                   AND PARVW EQ 'WL'.
          IF SY-SUBRC IS NOT INITIAL.
            SELECT SINGLE * FROM VBPA INTO WA_VBPA WHERE VBELN EQ WA_VTTP-VBELN
                                                     AND PARVW EQ 'LF'.
          ENDIF.
          SELECT SINGLE * FROM LFA1 INTO WA_LFA1 WHERE LIFNR EQ WA_VBPA-LIFNR.
        ENDIF.
      ELSE.
        SELECT SINGLE * INTO WA_LFA1
          FROM LFA1
         WHERE LIFNR EQ IT_CTE_INFO_NOTA-CLIENTE.
      ENDIF.

      IF SY-SUBRC IS INITIAL.

        SELECT SINGLE * INTO WA_ADRC
          FROM ADRC
         WHERE ADDRNUMBER EQ WA_LFA1-ADRNR.

        CALL FUNCTION 'CONVERSION_EXIT_ALPHA_INPUT'
          EXPORTING
            INPUT  = WA_LFA1-LIFNR "IT_CTE_INFO_NOTA-CLIENTE
          IMPORTING
            OUTPUT = P_PARCEIROS-REME_CODIGO.
        IF WA_LFA1-STKZN IS INITIAL.
          P_PARCEIROS-REME_CNPJ = WA_LFA1-STCD1.
        ELSE.
          P_PARCEIROS-REME_CPF = WA_LFA1-STCD2.
        ENDIF.
        P_PARCEIROS-REME_IE      = WA_LFA1-STCD3.
        P_PARCEIROS-REME_XNOME   = WA_LFA1-NAME1.
        P_PARCEIROS-REME_XFANT   = WA_LFA1-NAME1.
        P_PARCEIROS-REME_XLGR    = WA_ADRC-STREET(25).
        IF WA_ADRC-HOUSE_NUM1 IS INITIAL.
          P_PARCEIROS-REME_NRO     = C_SN.
        ELSE.
          P_PARCEIROS-REME_NRO     = WA_ADRC-HOUSE_NUM1.
        ENDIF.
        "p_parceiros-emit_xcpl    = emitente-.
        P_PARCEIROS-REME_XBAIRRO = WA_ADRC-CITY2.
        P_PARCEIROS-REME_CMUN    = WA_ADRC-TAXJURCODE+3(7).

        SELECT SINGLE * INTO CIDADE
          FROM J_1BTXJURT
         WHERE SPRAS      = WA_ADRC-LANGU
           AND COUNTRY    = WA_ADRC-COUNTRY
           AND TAXJURCODE = WA_ADRC-TAXJURCODE.

        IF SY-SUBRC IS INITIAL.
          P_PARCEIROS-REME_XMUN    = CIDADE-TEXT.
        ENDIF.
        P_PARCEIROS-REME_CEP     = WA_ADRC-POST_CODE1.
        P_PARCEIROS-REME_UF      = WA_ADRC-REGION.
        P_PARCEIROS-REME_FONE    = WA_ADRC-TEL_NUMBER.
      ENDIF.

      CLEAR: WA_J_1BBRANCH, WA_ADRC.

      "Busca Destinatário de Nota Fiscal de Entrada
      CLEAR WA_KNA1.
      IF ( IT_CTE_INFO_NOTA[] IS INITIAL ) OR ( WA_J_1BNFDOC_NF IS INITIAL ).
        SELECT SINGLE * FROM VTTP INTO WA_VTTP WHERE TKNUM EQ P_DOC_TRANSP-TKNUM.
        IF ( SY-SUBRC EQ 0 ).
          SELECT SINGLE * FROM VBPA INTO WA_VBPA WHERE VBELN EQ WA_VTTP-VBELN
                                                   AND PARVW EQ 'LR'.
          SELECT SINGLE * FROM KNA1 INTO WA_KNA1 WHERE KUNNR EQ WA_VBPA-KUNNR.
        ENDIF.
      ELSE.
        SELECT SINGLE * INTO WA_J_1BBRANCH
          FROM J_1BBRANCH
         WHERE BUKRS  = WA_J_1BNFDOC_NF-BUKRS
           AND BRANCH = WA_J_1BNFDOC_NF-BRANCH.
      ENDIF.

      IF SY-SUBRC IS INITIAL.
        IF WA_KNA1 IS NOT INITIAL.
          SELECT SINGLE * INTO WA_ADRC
            FROM ADRC
           WHERE ADDRNUMBER EQ WA_KNA1-ADRNR.

          P_PARCEIROS-DEST_CODIGO  = WA_KNA1-KUNNR.

          CALL FUNCTION 'CONVERSION_EXIT_ALPHA_INPUT'
            EXPORTING
              INPUT  = P_PARCEIROS-DEST_CODIGO
            IMPORTING
              OUTPUT = P_PARCEIROS-DEST_CODIGO.

          P_PARCEIROS-DEST_CNPJ    = WA_KNA1-STCD1.
          P_PARCEIROS-DEST_IE      = WA_KNA1-STCD3.
        ELSE.

          P_PARCEIROS-DEST_CODIGO  = WA_J_1BNFDOC_NF-BRANCH.
          CALL FUNCTION 'CONVERSION_EXIT_ALPHA_INPUT'
            EXPORTING
              INPUT  = P_PARCEIROS-DEST_CODIGO
            IMPORTING
              OUTPUT = P_PARCEIROS-DEST_CODIGO.

          SELECT SINGLE * FROM KNA1 INTO WA_KNA1 WHERE KUNNR EQ P_PARCEIROS-DEST_CODIGO.
          SELECT SINGLE * INTO WA_ADRC
           FROM ADRC
          WHERE ADDRNUMBER EQ WA_KNA1-ADRNR.

          P_PARCEIROS-DEST_CNPJ    = WA_J_1BBRANCH-STCD1.
          P_PARCEIROS-DEST_IE      = WA_J_1BBRANCH-STATE_INSC.
        ENDIF.

        P_PARCEIROS-DEST_XNOME   = WA_ADRC-NAME1.
        P_PARCEIROS-DEST_XFANT   = WA_ADRC-NAME1.
        P_PARCEIROS-DEST_XLGR    = WA_ADRC-STREET(25).

        IF WA_ADRC-HOUSE_NUM1 IS INITIAL.
          P_PARCEIROS-DEST_NRO     = C_SN.
        ELSE.
          P_PARCEIROS-DEST_NRO     = WA_ADRC-HOUSE_NUM1.
        ENDIF.

        "p_parceiros-emit_xcpl    = emitente-.
        P_PARCEIROS-DEST_XBAIRRO = WA_ADRC-CITY2.
        P_PARCEIROS-DEST_CMUN    = WA_ADRC-TAXJURCODE+3(7).

        SELECT SINGLE * INTO CIDADE
          FROM J_1BTXJURT
         WHERE SPRAS      = WA_ADRC-LANGU
           AND COUNTRY    = WA_ADRC-COUNTRY
           AND TAXJURCODE = WA_ADRC-TAXJURCODE.

        IF SY-SUBRC IS INITIAL.
          P_PARCEIROS-DEST_XMUN    = CIDADE-TEXT.
        ENDIF.

        P_PARCEIROS-DEST_CEP     = WA_ADRC-POST_CODE1.
        P_PARCEIROS-DEST_UF      = WA_ADRC-REGION.
        P_PARCEIROS-DEST_FONE    = WA_ADRC-TEL_NUMBER.
      ENDIF.

    ENDIF.

    CLEAR: WA_VTTK, WA_VTPA.

    SELECT SINGLE * FROM VTTK INTO WA_VTTK WHERE TKNUM EQ P_DOC_TRANSP-TKNUM.

    IF ( SY-SUBRC EQ 0 ).

      CASE WA_VTTK-SHTYP.
        WHEN: 'Z001' OR 'Z004'.

          SELECT SINGLE * FROM VTPA INTO WA_VTPA WHERE VBELN EQ WA_VTTK-TKNUM
                                                   AND PARVW EQ 'LR'.

          CLEAR: WA_KNA1.

          SELECT SINGLE * FROM KNA1 INTO WA_KNA1 WHERE KUNNR EQ WA_VTPA-KUNNR.
          P_PARCEIROS-LR_CODIGO     = WA_KNA1-KUNNR.
          P_PARCEIROS-LR_NOME       = WA_KNA1-NAME1.
          P_PARCEIROS-LR_RAZAO      = WA_KNA1-NAME1.
          P_PARCEIROS-LR_CNPJ       = WA_KNA1-STCD1.
          P_PARCEIROS-LR_CPF        = WA_KNA1-STCD2.
          P_PARCEIROS-LR_LOGRADOURO = WA_KNA1-STRAS.

          SELECT SINGLE * INTO WA_ADRC
             FROM ADRC
          WHERE ADDRNUMBER EQ WA_KNA1-ADRNR.

          P_PARCEIROS-LR_NUMERO    = WA_ADRC-HOUSE_NUM1.
          P_PARCEIROS-LR_BAIRRO    = WA_KNA1-ORT02.
          P_PARCEIROS-LR_UF        = WA_KNA1-REGIO.
          P_PARCEIROS-LR_MUNICIPIO = WA_ADRC-TAXJURCODE+3(7).
          P_PARCEIROS-LR_CEP       = WA_KNA1-PSTLZ.
          P_PARCEIROS-LR_FONE      = WA_KNA1-TELF1.

      ENDCASE.

    ENDIF.

  ENDIF.
ENDFUNCTION.
