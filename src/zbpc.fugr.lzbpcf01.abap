*----------------------------------------------------------------------*
***INCLUDE LZBPCF01 .
*----------------------------------------------------------------------*
*&---------------------------------------------------------------------*
*&      Form  ZSELECIONA_DADOS_SLD_ACM_MES
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM ZSELECIONA_DADOS_SLD_ACM_MES .

  REFRESH : IT_SETLEAF, IT_ZGL030_DRE_ACM, IT_CSKS.

  LOOP AT IT_SALDO_ACUMULADO_MES INTO WA_SALDO_ACUMULADO_MES.

    IF WA_SALDO_ACUMULADO_MES-CAMPO EQ 'BUKRS'.
      P_BUKRS-LOW    = WA_SALDO_ACUMULADO_MES-VALOR_DE.
      P_BUKRS-HIGH   = WA_SALDO_ACUMULADO_MES-VALOR_ATE.
      P_BUKRS-SIGN   = WA_SALDO_ACUMULADO_MES-SIGN.
      P_BUKRS-OPTION = WA_SALDO_ACUMULADO_MES-OPTION.
      APPEND P_BUKRS.
    ENDIF.

    IF WA_SALDO_ACUMULADO_MES-CAMPO EQ 'GJAHR'.
      P_GJAHR-LOW    = WA_SALDO_ACUMULADO_MES-VALOR_DE.
      P_GJAHR-HIGH   = WA_SALDO_ACUMULADO_MES-VALOR_ATE.
      P_GJAHR-SIGN   = WA_SALDO_ACUMULADO_MES-SIGN.
      P_GJAHR-OPTION = WA_SALDO_ACUMULADO_MES-OPTION.
      APPEND P_GJAHR.
    ENDIF.

    IF WA_SALDO_ACUMULADO_MES-CAMPO EQ 'MONAT'.
      P_MONAT-LOW    = WA_SALDO_ACUMULADO_MES-VALOR_DE.
      P_MONAT-HIGH   = WA_SALDO_ACUMULADO_MES-VALOR_ATE.
      P_MONAT-SIGN   = WA_SALDO_ACUMULADO_MES-SIGN.
      P_MONAT-OPTION = WA_SALDO_ACUMULADO_MES-OPTION.
      APPEND P_MONAT.
    ENDIF.

    IF WA_SALDO_ACUMULADO_MES-CAMPO EQ 'SAKNR'.
      P_SAKNR-LOW    = WA_SALDO_ACUMULADO_MES-VALOR_DE.
      P_SAKNR-HIGH   = WA_SALDO_ACUMULADO_MES-VALOR_ATE.
      P_SAKNR-SIGN   = WA_SALDO_ACUMULADO_MES-SIGN.
      P_SAKNR-OPTION = WA_SALDO_ACUMULADO_MES-OPTION.
      APPEND P_SAKNR.
    ENDIF.

  ENDLOOP.

  "CSB Comentei esse techo
*  SELECT *
*    INTO TABLE it_setleaf
*    FROM setleaf
*   WHERE setname = 'MAGGI_ESTRUTURA_BPC'.
*
*  LOOP AT it_setleaf INTO wa_setleaf.
*    p_set-low    = wa_setleaf-valfrom.
*    p_set-high   = wa_setleaf-valto.
*    p_set-sign   = wa_setleaf-valsign.
*    p_set-option = wa_setleaf-valoption.
*  ENDLOOP.

  " Conforme solicitação chamado 97025
  RANGES:  RG_VERSN FOR ZGL030_DRE_ACM-VERSN.
  REFRESH: RG_VERSN.
  CLEAR: IT_ZFIT0039,WA_ZFIT0039.

  SELECT *
    INTO TABLE IT_ZFIT0039
    FROM ZFIT0039
   WHERE BUKRS IN P_BUKRS.

  LOOP AT IT_ZFIT0039 INTO WA_ZFIT0039.
    RG_VERSN-SIGN   = 'I'.
    RG_VERSN-OPTION = 'EQ'.
    RG_VERSN-LOW    = WA_ZFIT0039-VERSN.
    APPEND RG_VERSN.
    CLEAR: RG_VERSN.
  ENDLOOP.

  SELECT *
    INTO TABLE IT_ZGL030_DRE_ACM_AUX
    FROM ZGL030_DRE_ACM
   WHERE BUKRS IN P_BUKRS
     "AND VERSN IN P_SET
     AND VERSN IN RG_VERSN
     AND SAKNR IN P_SAKNR
     AND MONAT IN P_MONAT
     AND GJAHR IN P_GJAHR.

  SELECT KOSTL KOKRS
    INTO TABLE IT_CSKS
    FROM CSKS
    FOR ALL ENTRIES IN IT_ZGL030_DRE_ACM_AUX
   WHERE KOSTL = IT_ZGL030_DRE_ACM_AUX-KOSTL.

  SELECT *
    INTO TABLE IT_ZGL014_DRE_DEPA
    FROM ZGL014_DRE_DEPA
     FOR ALL ENTRIES IN IT_ZGL030_DRE_ACM_AUX
   WHERE BUKRS = IT_ZGL030_DRE_ACM_AUX-BUKRS
     AND PRCTR = IT_ZGL030_DRE_ACM_AUX-PRCTR.

  SELECT *
    INTO TABLE IT_MARA
    FROM MARA
     FOR ALL ENTRIES IN IT_ZGL014_DRE_DEPA
   WHERE MATNR = IT_ZGL014_DRE_DEPA-MATNR.

  SORT: IT_ZGL014_DRE_DEPA BY BUKRS PRCTR,
        IT_MARA            BY MATNR.

  LOOP AT IT_ZGL030_DRE_ACM_AUX INTO WA_ZGL030_DRE_ACM_AUX .

    READ TABLE IT_ZGL014_DRE_DEPA INTO WA_ZGL014_DRE_DEPA WITH KEY BUKRS = WA_ZGL030_DRE_ACM_AUX-BUKRS  PRCTR = WA_ZGL030_DRE_ACM_AUX-PRCTR BINARY SEARCH.

    READ TABLE IT_MARA INTO WA_MARA WITH KEY MATNR = WA_ZGL014_DRE_DEPA-MATNR BINARY SEARCH.

    MOVE-CORRESPONDING WA_ZGL030_DRE_ACM_AUX TO WA_ZGL030_DRE_ACM.

    WA_ZGL030_DRE_ACM-MATKL = WA_MARA-MATKL.

    APPEND WA_ZGL030_DRE_ACM TO IT_ZGL030_DRE_ACM.

  ENDLOOP.


ENDFORM.                    " ZSELECIONA_DADOS_SLD_ACM_MES
*&---------------------------------------------------------------------*
*&      Form  ZPROCESSA_RETORNO_SLD_ACM_MES
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM ZPROCESSA_RETORNO_SLD_ACM_MES .

  SORT : IT_CSKS BY KOSTL.
  DATA: VL_CENTRO_AR   TYPE C LENGTH 1.

  LOOP AT IT_ZGL030_DRE_ACM INTO WA_ZGL030_DRE_ACM.

    READ TABLE IT_CSKS INTO WA_CSKS WITH KEY KOSTL = WA_ZGL030_DRE_ACM-KOSTL.
    CLEAR VL_CENTRO_AR.

    SELECT SINGLE *
      FROM SETLEAF
      INTO WA_SETLEAF
     WHERE SETNAME = 'MAGGI_EMPRESA_EXTERIOR'
       AND VALFROM = WA_ZGL030_DRE_ACM-BUKRS.

    IF SY-SUBRC IS INITIAL .
      VL_CENTRO_AR = 'S'.
    ELSE.
      VL_CENTRO_AR = 'N'.
    ENDIF.

    WA_RET_SALDO_ACUMULADO_MES-EMPRESA             = WA_ZGL030_DRE_ACM-BUKRS.
    WA_RET_SALDO_ACUMULADO_MES-EXERCICIO           = WA_ZGL030_DRE_ACM-GJAHR.
    WA_RET_SALDO_ACUMULADO_MES-MES_EXERCICIO       = WA_ZGL030_DRE_ACM-MONAT.
    WA_RET_SALDO_ACUMULADO_MES-CONTA_RAZAO         = WA_ZGL030_DRE_ACM-SAKNR.
    WA_RET_SALDO_ACUMULADO_MES-SOCIEDADE_PARCEIRA  = WA_ZGL030_DRE_ACM-VBUND.
    WA_RET_SALDO_ACUMULADO_MES-CENTRO_CUSTO        = WA_ZGL030_DRE_ACM-KOSTL.
    WA_RET_SALDO_ACUMULADO_MES-KOKRS               = WA_CSKS-KOKRS.
    WA_RET_SALDO_ACUMULADO_MES-GRUPO_MERCADORIA    = WA_ZGL030_DRE_ACM-MATKL.
    WA_RET_SALDO_ACUMULADO_MES-MOEDA               = 'BRL'.
    IF VL_CENTRO_AR = 'S' .
      WA_RET_SALDO_ACUMULADO_MES-SLD_ACL_MES         = WA_ZGL030_DRE_ACM-VLR_GRUPO." Caso argentina
    ELSE.
      WA_RET_SALDO_ACUMULADO_MES-SLD_ACL_MES         = WA_ZGL030_DRE_ACM-VLR_REA.
    ENDIF.


    COLLECT  WA_RET_SALDO_ACUMULADO_MES INTO IT_RET_SALDO_ACUMULADO_MES.

    WA_RET_SALDO_ACUMULADO_MES-EMPRESA             = WA_ZGL030_DRE_ACM-BUKRS.
    WA_RET_SALDO_ACUMULADO_MES-EXERCICIO           = WA_ZGL030_DRE_ACM-GJAHR.
    WA_RET_SALDO_ACUMULADO_MES-MES_EXERCICIO       = WA_ZGL030_DRE_ACM-MONAT.
    WA_RET_SALDO_ACUMULADO_MES-CONTA_RAZAO         = WA_ZGL030_DRE_ACM-SAKNR.
    WA_RET_SALDO_ACUMULADO_MES-SOCIEDADE_PARCEIRA  = WA_ZGL030_DRE_ACM-VBUND.
    WA_RET_SALDO_ACUMULADO_MES-CENTRO_CUSTO        = WA_ZGL030_DRE_ACM-KOSTL.
    WA_RET_SALDO_ACUMULADO_MES-KOKRS               = WA_CSKS-KOKRS.
    WA_RET_SALDO_ACUMULADO_MES-GRUPO_MERCADORIA    = WA_ZGL030_DRE_ACM-MATKL.
    WA_RET_SALDO_ACUMULADO_MES-MOEDA               = 'USD'.
    WA_RET_SALDO_ACUMULADO_MES-SLD_ACL_MES         = WA_ZGL030_DRE_ACM-VLR_DOLAR.

    COLLECT  WA_RET_SALDO_ACUMULADO_MES INTO IT_RET_SALDO_ACUMULADO_MES.

    IF VL_CENTRO_AR = 'S' .

      WA_RET_SALDO_ACUMULADO_MES-EMPRESA             = WA_ZGL030_DRE_ACM-BUKRS.
      WA_RET_SALDO_ACUMULADO_MES-EXERCICIO           = WA_ZGL030_DRE_ACM-GJAHR.
      WA_RET_SALDO_ACUMULADO_MES-MES_EXERCICIO       = WA_ZGL030_DRE_ACM-MONAT.
      WA_RET_SALDO_ACUMULADO_MES-CONTA_RAZAO         = WA_ZGL030_DRE_ACM-SAKNR.
      WA_RET_SALDO_ACUMULADO_MES-SOCIEDADE_PARCEIRA  = WA_ZGL030_DRE_ACM-VBUND.
      WA_RET_SALDO_ACUMULADO_MES-CENTRO_CUSTO        = WA_ZGL030_DRE_ACM-KOSTL.
      WA_RET_SALDO_ACUMULADO_MES-KOKRS               = WA_CSKS-KOKRS.
      WA_RET_SALDO_ACUMULADO_MES-GRUPO_MERCADORIA    = WA_ZGL030_DRE_ACM-MATKL.
      WA_RET_SALDO_ACUMULADO_MES-MOEDA               = 'ARS'.
      WA_RET_SALDO_ACUMULADO_MES-SLD_ACL_MES         = WA_ZGL030_DRE_ACM-VLR_REA.

      COLLECT  WA_RET_SALDO_ACUMULADO_MES INTO IT_RET_SALDO_ACUMULADO_MES.

    ENDIF.

  ENDLOOP.

ENDFORM.                    " ZPROCESSA_RETORNO_SLD_ACM_MES
