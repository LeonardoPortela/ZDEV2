*&---------------------------------------------------------------------*
*&  Include           ZFIS34PAI
*&---------------------------------------------------------------------*

MODULE USER_COMMAND_0100.
  CASE SY-UCOMM.

    WHEN 'BUSCAR'.

      FREE:   IT_SAIDA_PRIN[], R_CENTRO_AUX[], R_WERKS[].
      CLEAR:  WA_SAIDA_PRIN.

      PERFORM MONTA_PRINCIPAL.

    WHEN 'GERAR'.

      IF WA_ALV_0001 IS NOT INITIAL.
        CALL METHOD WA_ALV_0001->GET_SELECTED_ROWS
          IMPORTING
            ET_INDEX_ROWS = IT_SELECTED_ROWS.
      ENDIF.

      FREE: IT_SAIDA_GERA[].

      LOOP AT IT_SELECTED_ROWS INTO WA_SELECTED_ROWS WHERE INDEX IS NOT INITIAL.

        READ TABLE IT_SAIDA_PRIN INTO WA_SAIDA_PRIN INDEX WA_SELECTED_ROWS.

        IF WA_SAIDA_PRIN-STATUS EQ ICON_CHECKED.
          MESSAGE TEXT-011 TYPE 'I'.
          CLEAR: WA_SAIDA_PRIN, WA_SELECTED_ROWS.
          CHECK SY-SUBRC NE 0.
        ELSE.
          APPEND WA_SAIDA_PRIN TO IT_SAIDA_GERA.
        ENDIF.

      ENDLOOP.

      IF IT_SAIDA_GERA[] IS NOT INITIAL.
        PERFORM GERAR_CONTABIL.
        CLEAR: WA_SAIDA_PRIN, WA_SELECTED_ROWS.

        LOOP AT IT_SAIDA_GERA INTO WA_SAIDA_GERA.

          LOOP AT IT_SAIDA_PRIN INTO WA_SAIDA_PRIN WHERE FILIAL EQ WA_SAIDA_GERA-FILIAL.

            WA_SAIDA_PRIN-STATUS       = ICON_TIME.

            MODIFY IT_SAIDA_PRIN FROM WA_SAIDA_PRIN.

          ENDLOOP.
        ENDLOOP.

        CALL METHOD WA_ALV_0001->REFRESH_TABLE_DISPLAY.

      ELSE.
        MESSAGE TEXT-009 TYPE 'I'.
        CLEAR: WA_SAIDA_PRIN, WA_SELECTED_ROWS.

      ENDIF.

    WHEN 'ESTORNAR'.

      DATA: ANS TYPE C.

          IF WA_ALV_0001 IS NOT INITIAL.
            CALL METHOD WA_ALV_0001->GET_SELECTED_ROWS
              IMPORTING
                ET_INDEX_ROWS = IT_SELECTED_ROWS.
          ENDIF.

          FREE: IT_SAIDA_GERA[].

          LOOP AT IT_SELECTED_ROWS INTO WA_SELECTED_ROWS.

            READ TABLE IT_SAIDA_PRIN INTO WA_SAIDA_PRIN INDEX WA_SELECTED_ROWS.

            IF WA_SAIDA_PRIN-STATUS EQ ICON_ACTIVITY.
              MESSAGE TEXT-012 TYPE 'I'.
              CLEAR: WA_SAIDA_PRIN, WA_SELECTED_ROWS.
              CHECK SY-SUBRC NE 0.
            ENDIF.

            APPEND WA_SAIDA_PRIN TO IT_SAIDA_GERA.

          ENDLOOP.

          IF IT_SAIDA_GERA[] IS NOT INITIAL.
            PERFORM GERAR_CONTABIL.
            CLEAR WA_SAIDA_PRIN. CLEAR WA_SELECTED_ROWS.
          ELSE.
            MESSAGE TEXT-009 TYPE 'I'.
            CLEAR: WA_SAIDA_PRIN, WA_SELECTED_ROWS.
          ENDIF.

          LOOP AT IT_SAIDA_GERA INTO WA_SAIDA_GERA.

          LOOP AT IT_SAIDA_PRIN INTO WA_SAIDA_PRIN WHERE FILIAL EQ WA_SAIDA_GERA-FILIAL.

            WA_SAIDA_PRIN-STATUS       = ICON_TIME.

            MODIFY IT_SAIDA_PRIN FROM WA_SAIDA_PRIN.

          ENDLOOP.
        ENDLOOP.

          CALL METHOD WA_ALV_0001->REFRESH_TABLE_DISPLAY.


    WHEN 'ATUALIZAR'.

      LOOP AT IT_SAIDA_PRIN INTO WA_SAIDA_PRIN.
        CLEAR: XICONE, XZIB, L_ERRO.

        PERFORM VALIDA_CONTABIL USING P_BUKRS-LOW
                                      WA_SAIDA_PRIN-FILIAL
                                      P_MES-LOW
                                      P_ANO-LOW.

        IF WA_ZFIT0138-OBJ_KEY IS NOT INITIAL.

          PERFORM BUSCA_STATUS USING WA_ZFIT0138-OBJ_KEY.

          IF XICONE EQ ICON_INCOMPLETE OR XICONE EQ ICON_CHECKED.
            WA_SAIDA_PRIN-STATUS = XICONE.
          ENDIF.

          IF XZIB IS NOT INITIAL.

              IF WA_ZFIT0138-ESTORNAR IS NOT INITIAL.
                WA_SAIDA_PRIN-NR_DOC_ESTORNO = XZIB.
                WA_SAIDA_PRIN-STATUS = ICON_ACTIVITY.
                CLEAR WA_SAIDA_PRIN-NR_DOCUMENTO.
              ELSE.
                WA_SAIDA_PRIN-NR_DOCUMENTO = XZIB.
                CLEAR WA_SAIDA_PRIN-NR_DOC_ESTORNO.
              ENDIF.

          ELSE.

             IF WA_ZFIT0138-ESTORNAR IS NOT INITIAL.
                WA_SAIDA_PRIN-NR_DOC_ESTORNO = L_ERRO.
                WA_SAIDA_PRIN-STATUS = ICON_INCOMPLETE.
                CLEAR WA_SAIDA_PRIN-NR_DOCUMENTO.
              ELSE.
                 WA_SAIDA_PRIN-NR_DOCUMENTO = L_ERRO.
                CLEAR WA_SAIDA_PRIN-NR_DOC_ESTORNO.
              ENDIF.

          ENDIF.

          MODIFY IT_SAIDA_PRIN FROM WA_SAIDA_PRIN.

        ELSE.
          WA_SAIDA_PRIN-STATUS = ICON_ACTIVITY.
          CLEAR WA_SAIDA_PRIN-NR_DOCUMENTO.

          MODIFY IT_SAIDA_PRIN FROM WA_SAIDA_PRIN.
        ENDIF.
      ENDLOOP.


      CALL METHOD WA_ALV_0001->REFRESH_TABLE_DISPLAY.

  ENDCASE.
ENDMODULE.

MODULE EXIT_SCREEN.
  CASE SY-UCOMM.
    WHEN 'EXIT' OR 'CANCEL' OR 'BACK'.
      LEAVE PROGRAM.
  ENDCASE.
ENDMODULE.

MODULE EXIT_SCREEN_2.
  CASE SY-UCOMM.
    WHEN 'EXIT' OR 'CANCEL'.
      LEAVE TO SCREEN 0.
    WHEN 'BACK'.
      LEAVE TO SCREEN 0100.
  ENDCASE.
ENDMODULE.
