*&---------------------------------------------------------------------*
*& Report  ZGL019_JOB_RECONCILIA
*&
*&---------------------------------------------------------------------*
*&
*&
*&---------------------------------------------------------------------*

REPORT  ZGL019_JOB_RECONCILIA.

TYPE-POOLS: ICON.

DATA: BEGIN OF TG_ZGLT041 OCCURS 0.
        INCLUDE STRUCTURE ZGLT041.
DATA: END OF TG_ZGLT041.

DATA: BEGIN OF TG_ZGLT043 OCCURS 0.
        INCLUDE STRUCTURE ZGLT043.
DATA: END OF TG_ZGLT043.

DATA: BEGIN OF TG_SAIDA OCCURS 0,
        STATUS           TYPE ICONNAME,
        STATUS_PRAZO     TYPE ICONNAME,
        DIAS_VENCIDO     TYPE I,
        SAKNR            LIKE SKB1-SAKNR,
        BUKRS            TYPE BUKRS,
        TXT50            LIKE SKAT-TXT50,
        SALDO_MI         TYPE FAGLFLEXT-HSLVT,
        SALDO_MI2        TYPE FAGLFLEXT-KSLVT,
        SALDO_MI3        TYPE FAGLFLEXT-OSLVT,
        DEP_RESP         TYPE CHAR30,
        BNAME            TYPE ZGLT041-BNAME2,
        PRAZO_ENTR       TYPE DATUM,
        DT_ATUALIZACAO   TYPE ZFIED023,
        C_BALANCO        TYPE CHAR30,
        C_NOTA           TYPE CHAR30,
        CTA_MONET        TYPE ZGLT041-CTA_MONET,
        CTA_INTERCOMPANY TYPE ZGLT041-CTA_INTERCOMPANY,
      END OF TG_SAIDA.

DATA: VG_MES_ATUAL  TYPE MONAT,
      VG_ANO_ATUAL  TYPE GJAHR,
      VG_MES_INICIA TYPE MONAT,
      VG_ANO_INICIA TYPE GJAHR,
      IT_T001       TYPE TABLE OF T001 WITH HEADER LINE,
      IT_DEPART     TYPE TABLE OF ZIMP_CAD_DEPTO WITH HEADER LINE,
      LC_MONAT      TYPE ZGLT043-MONAT,
      LC_GJAHR      TYPE ZGLT043-GJAHR,
      RSPAR_TAB     TYPE TABLE OF RSPARAMS,
      RSPAR_LINE    LIKE LINE OF RSPAR_TAB.

RANGES: RANGE_BUKRS FOR T001-BUKRS.

SELECT * INTO TABLE IT_T001
  FROM T001.

SELECT * INTO TABLE IT_DEPART
  FROM ZIMP_CAD_DEPTO.

CLEAR RSPAR_LINE.
RSPAR_LINE-SELNAME = 'P_PRAZO'.
RSPAR_LINE-KIND    = 'P'.
RSPAR_LINE-OPTION  = 'EQ'.
RSPAR_LINE-LOW     = 'X'.
APPEND RSPAR_LINE TO RSPAR_TAB.

CLEAR RSPAR_LINE.
RSPAR_LINE-SELNAME = 'P_NAO'.
RSPAR_LINE-KIND    = 'P'.
RSPAR_LINE-OPTION  = 'EQ'.
RSPAR_LINE-LOW     = ' '.
APPEND RSPAR_LINE TO RSPAR_TAB.

LOOP AT IT_T001.

  CLEAR: RANGE_BUKRS, RANGE_BUKRS[].
  RANGE_BUKRS-SIGN   = 'I'.
  RANGE_BUKRS-OPTION = 'EQ'.
  RANGE_BUKRS-LOW    = IT_T001-BUKRS.
  RANGE_BUKRS-HIGH   = IT_T001-BUKRS.
  APPEND RANGE_BUKRS.

  LOOP AT IT_DEPART.

    VG_MES_ATUAL  = SY-DATUM+4(2).
    VG_ANO_ATUAL  = SY-DATUM(4).
    VG_MES_INICIA = 01.
    VG_ANO_INICIA = 2015.
    CLEAR: TG_SAIDA[].

*    WHILE ( VG_ANO_INICIA LE VG_ANO_ATUAL ) OR ( VG_ANO_INICIA EQ VG_ANO_ATUAL AND VG_MES_INICIA LE VG_MES_ATUAL ).  "/Modificação CS2017000372

    SELECT R~BUKRS
           R~SAKNR
           R~COD_CLAS_BAL
           R~COD_CLAS_NOT2
           R~COD_CLAS_NOT
           R~CTA_MONET
           R~CTA_INTERCOMPANY
           R~DEP_RESP2
           R~BNAME2
           R~PRAZO_ENTR
           R~CRIT_VECTO
      INTO CORRESPONDING FIELDS OF TABLE TG_ZGLT041
      FROM ZGLT041 AS R
     INNER JOIN T001 AS E ON E~BUKRS EQ R~BUKRS
     WHERE R~BUKRS     EQ IT_T001-BUKRS
       AND R~DEP_RESP2 EQ IT_DEPART-DEP_RESP
*         AND R~GJAHR EQ VG_ANO_INICIA "/Modificação CS2017000372
       AND EXISTS ( SELECT * FROM SKB1 AS K WHERE K~BUKRS EQ R~BUKRS AND K~SAKNR EQ R~SAKNR ) "#EC CI_DB_OPERATION_OK[2431747]
       AND EXISTS ( SELECT * FROM SKA1 AS T WHERE T~KTOPL EQ E~KTOPL AND T~SAKNR EQ R~SAKNR ) "#EC CI_DB_OPERATION_OK[2431747]
       AND NOT EXISTS ( SELECT * FROM ZGLT043B AS B WHERE B~KTOPL EQ E~KTOPL AND B~SAKNR EQ R~SAKNR AND B~BUKRS EQ R~BUKRS ) "#EC CI_DB_OPERATION_OK[2389136]
       AND NOT EXISTS ( SELECT * "#EC CI_DB_OPERATION_OK[2431747]
                          FROM SKA1     AS C "#EC CI_DB_OPERATION_OK[2389136]
                         INNER JOIN ZGLT043A AS A ON A~KTOPL EQ C~KTOPL
                                                 AND A~KTOKS EQ C~KTOKS
                         WHERE C~KTOPL EQ E~KTOPL
                           AND C~SAKNR EQ R~SAKNR
                           AND A~BUKRS EQ R~BUKRS ). "/Modificação 11.11.2016/

*      IF SY-SUBRC IS INITIAL. "/Modificação CS2017000372
*        SUBMIT ZGL019 USING SELECTION-SCREEN '1000'
*                             WITH SELECTION-TABLE RSPAR_TAB
*                             WITH P_BUKRS  IN RANGE_BUKRS
*                             WITH P_DEP_RE EQ IT_DEPART-DEP_RESP
*                             WITH P_MONAT  EQ VG_MES_INICIA
*                             WITH P_GJAHR  EQ VG_ANO_INICIA
*                             WITH E_MAIL   EQ 'X'
*                             AND RETURN.
*      ENDIF.

    IF SY-SUBRC IS NOT INITIAL.
      CONTINUE.
    ENDIF.

    WHILE ( VG_ANO_INICIA LE VG_ANO_ATUAL ) OR ( VG_ANO_INICIA EQ VG_ANO_ATUAL AND VG_MES_INICIA LE VG_MES_ATUAL ).

      SUBMIT ZGL019 USING SELECTION-SCREEN '1000'
                     WITH SELECTION-TABLE RSPAR_TAB
                     WITH P_BUKRS  IN RANGE_BUKRS
                     WITH P_DEP_RE EQ IT_DEPART-DEP_RESP
                     WITH P_MONAT  EQ VG_MES_INICIA
                     WITH P_GJAHR  EQ VG_ANO_INICIA
                     WITH E_MAIL   EQ 'X'
                     AND RETURN.

      IF VG_MES_INICIA EQ 12.
        ADD 1 TO VG_ANO_INICIA.
        VG_MES_INICIA = 01.
      ELSE.
        ADD 1 TO VG_MES_INICIA.
      ENDIF.

    ENDWHILE.

  ENDLOOP.

ENDLOOP.
