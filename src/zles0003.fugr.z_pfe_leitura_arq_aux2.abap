FUNCTION Z_PFE_LEITURA_ARQ_AUX2.
*"----------------------------------------------------------------------
*"*"Interface local:
*"  IMPORTING
*"     VALUE(DIRETORIO) TYPE  ADMI_PATH OPTIONAL
*"     VALUE(ARQUIVO) TYPE  ADMI_PATH
*"     VALUE(UNIX) TYPE  CFLAG DEFAULT 'X'
*"     VALUE(LOCAL) TYPE  CFLAG OPTIONAL
*"     VALUE(GERAR_LOTES) TYPE  CFLAG DEFAULT 'X'
*"  TABLES
*"      T_ARQUIVO STRUCTURE  ZPFE_ARQUIVO OPTIONAL
*"      T_REG_CABECALHO STRUCTURE  ZPFE_LOTE OPTIONAL
*"      T_REG_ITENS STRUCTURE  ZPFE_LOTE_ITEM OPTIONAL
*"  EXCEPTIONS
*"      INVALID_EPS_SUBDIR
*"      SAPGPARAM_FAILED
*"      BUILD_DIRECTORY_FAILED
*"      NO_AUTHORIZATION
*"      READ_DIRECTORY_FAILED
*"      TOO_MANY_READ_ERRORS
*"      EMPTY_DIRECTORY_LIST
*"      NAO_ADMINISTRADORA
*"      NAO_LOCAL_NEGOCIO
*"      INTERVAL_NOT_FOUND
*"      NUMBER_RANGE_NOT_INTERN
*"      OUTROS_ERROS
*"----------------------------------------------------------------------

  TYPES BEGIN OF TY_VALORES.
  TYPES: CD_CIOT   TYPE ZCIOT,
         DOCNUM    TYPE J_1BDOCNUM,
         VL_PERDA	 TYPE KWERT,
         VL_QUEBRA TYPE KWERT.
  TYPES END OF TY_VALORES.

  DATA: ARQ                TYPE EPSFILNAM,
        IT_DIR             TYPE TABLE OF EPSFILI,
        WA_DIR             TYPE EPSFILI,
        DIR_ARQ            TYPE STRING,
*        T_ARQUIVO           TYPE TABLE OF ZPFE_ARQUIVO WITH HEADER LINE,
*        T_REG_CABECALHO    TYPE TABLE OF ZPFE_LOTE WITH HEADER LINE,
*        T_REG_ITENS        TYPE TABLE OF ZPFE_LOTE_ITEM WITH HEADER LINE,
        T_REG_ITENS_AD     TYPE TABLE OF ZPFE_LOTE_ITEM WITH HEADER LINE,
        T_REG_ITENS_AUX    TYPE TABLE OF ZPFE_LOTE_ITEM WITH HEADER LINE,
        WA_REG_CABECALHO   TYPE ZPFE_LOTE,
        WA_REG_ITENS       TYPE ZPFE_LOTE_ITEM,
        WA_REG_ITENS_AUX   TYPE ZPFE_LOTE_ITEM,
        TG_REG_ITENS_AUX   TYPE TABLE OF ZPFE_LOTE_ITEM,
        IT_FILE_TABLE      TYPE TABLE OF SDOKPATH WITH HEADER LINE,
        IT_DIR_TABLE       TYPE TABLE OF SDOKPATH WITH HEADER LINE,
        WA_FILE_TABLE      TYPE SDOKPATH,
        DIR_NAME           LIKE EPSF-EPSDIRNAM,
        FILE_MASK          LIKE EPSF-EPSFILNAM,
        ST_LOTE            TYPE ZPFE_NUMERO_LOTE,
        ST_LOTE_AUX        TYPE ZPFE_NUMERO_LOTE,
        VG_LOTE            TYPE I,
        P_TIPCONTABIL      TYPE ZTIPCONTABIL,
        WA_ZCTE_CIOT       TYPE ZCTE_CIOT,
        TG_ZCTE_CIOT       TYPE TABLE OF ZCTE_CIOT,
        WA_ZCTE_IDENTIFICA TYPE ZCTE_IDENTIFICA,
        TG_ZCTE_IDENTIFICA TYPE TABLE OF ZCTE_IDENTIFICA,
        VG_DIFERENCA       TYPE J_1BNETQTY,
        VG_TOLERAVEL       TYPE J_1BNETQTY,
        IT_ZLEST0025       TYPE TABLE OF ZLEST0025 WITH HEADER LINE,
        IT_VALORES         TYPE TABLE OF TY_VALORES WITH HEADER LINE,
        VG_TABIX           TYPE SY-TABIX,
        VG_NM_LOTE_ITEM	   TYPE ZPFE_NUMERO_LOTE,
        WL_TABIX           TYPE SY-TABIX,
        wl_teste(1).

  DATA: WDIR TYPE C LENGTH 100,
        WARQ TYPE C LENGTH 100.

  DATA: SELTAB  LIKE RANGE OF ZPFE_ARQUIVO-LINHA,
      SELTAB_WA LIKE LINE OF SELTAB.
  DATA: JOBCOUNT LIKE TBTCJOB-JOBCOUNT.




  CONCATENATE DIRETORIO ARQUIVO INTO ARQ.

  VG_LOTE = 0.

  IF UNIX EQ 'X'.

    DIR_NAME  = DIRETORIO.

    CALL FUNCTION 'EPS_GET_DIRECTORY_LISTING'
      EXPORTING
        DIR_NAME               = DIR_NAME
      TABLES
        DIR_LIST               = IT_DIR
      EXCEPTIONS
        INVALID_EPS_SUBDIR     = 1
        SAPGPARAM_FAILED       = 2
        BUILD_DIRECTORY_FAILED = 3
        NO_AUTHORIZATION       = 4
        READ_DIRECTORY_FAILED  = 5
        TOO_MANY_READ_ERRORS   = 6
        EMPTY_DIRECTORY_LIST   = 7
        OTHERS                 = 8.

    CASE SY-SUBRC.
      WHEN 01.
        RAISE INVALID_EPS_SUBDIR.
      WHEN 02.
        RAISE SAPGPARAM_FAILED.
      WHEN 03.
        RAISE BUILD_DIRECTORY_FAILED.
      WHEN 04.
        RAISE NO_AUTHORIZATION.
      WHEN 05.
        RAISE READ_DIRECTORY_FAILED.
      WHEN 06.
        RAISE TOO_MANY_READ_ERRORS.
      WHEN 07.
        MESSAGE E001 WITH DIRETORIO RAISING EMPTY_DIRECTORY_LIST.
      WHEN 08.
        MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO
           WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4 RAISING OUTROS_ERROS.
    ENDCASE.

    LOOP AT IT_DIR INTO WA_DIR.

      CONCATENATE DIRETORIO WA_DIR-NAME INTO DIR_ARQ.

      CALL FUNCTION 'Z_PFE_ARQUIVO'
        EXPORTING
          ARQUIVO                 = DIR_ARQ
        TABLES
          T_ARQUIVO               = T_ARQUIVO
        EXCEPTIONS
          FILE_OPEN_ERROR         = 1
          FILE_READ_ERROR         = 2
          NO_BATCH                = 3
          GUI_REFUSE_FILETRANSFER = 4
          INVALID_TYPE            = 5
          NO_AUTHORITY            = 6
          UNKNOWN_ERROR           = 7
          BAD_DATA_FORMAT         = 8
          HEADER_NOT_ALLOWED      = 9
          SEPARATOR_NOT_ALLOWED   = 10
          HEADER_TOO_LONG         = 11
          UNKNOWN_DP_ERROR        = 12
          ACCESS_DENIED           = 13
          DP_OUT_OF_MEMORY        = 14
          DISK_FULL               = 15
          DP_TIMEOUT              = 16
          OUTROS                  = 17
          OTHERS                  = 18.

      IF SY-SUBRC <> 0.
        MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO
           WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4 RAISING OUTROS_ERROS.
      ENDIF.

      VG_LOTE = VG_LOTE + 1.

      CALL FUNCTION 'Z_PFE_ARQUIVO_REGISTOS'
        TABLES
          T_ARQUIVO          = T_ARQUIVO
          T_REG_CABECALHO    = T_REG_CABECALHO
        CHANGING
          VG_LOTE            = VG_LOTE
        EXCEPTIONS
          NAO_ADMINISTRADORA = 1
          NAO_LOCAL_NEGOCIO  = 2
          OTHERS             = 3.

      CASE SY-SUBRC.
        WHEN 1.
          MESSAGE E002 WITH SY-MSGV1 RAISING NAO_ADMINISTRADORA.
        WHEN 2.
          MESSAGE E003 WITH SY-MSGV1 RAISING NAO_LOCAL_NEGOCIO.
        WHEN 3.
          MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4 RAISING OUTROS_ERROS.
      ENDCASE.

    ENDLOOP.

  ELSE.

    MOVE: DIRETORIO TO WDIR,
          ARQUIVO   TO WARQ.

    CALL FUNCTION 'TMP_GUI_DIRECTORY_LIST_FILES'
      EXPORTING
        DIRECTORY  = WDIR
        FILTER     = WARQ
      TABLES
        FILE_TABLE = IT_FILE_TABLE
        DIR_TABLE  = IT_DIR_TABLE
      EXCEPTIONS
        CNTL_ERROR = 1
        OTHERS     = 2.

    IF SY-SUBRC IS NOT INITIAL.
      MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4 RAISING OUTROS_ERROS.
    ENDIF.

    LOOP AT IT_FILE_TABLE INTO WA_FILE_TABLE.
      REFRESH: SELTAB.
      CONCATENATE DIRETORIO WA_FILE_TABLE-PATHNAME INTO DIR_ARQ.

      CALL FUNCTION 'Z_PFE_ARQUIVO'
        EXPORTING
          ARQUIVO                 = DIR_ARQ
          UNIX                    = SPACE
          LOCAL                   = 'X'
        TABLES
          T_ARQUIVO               = T_ARQUIVO
        EXCEPTIONS
          FILE_OPEN_ERROR         = 1
          FILE_READ_ERROR         = 2
          NO_BATCH                = 3
          GUI_REFUSE_FILETRANSFER = 4
          INVALID_TYPE            = 5
          NO_AUTHORITY            = 6
          UNKNOWN_ERROR           = 7
          BAD_DATA_FORMAT         = 8
          HEADER_NOT_ALLOWED      = 9
          SEPARATOR_NOT_ALLOWED   = 10
          HEADER_TOO_LONG         = 11
          UNKNOWN_DP_ERROR        = 12
          ACCESS_DENIED           = 13
          DP_OUT_OF_MEMORY        = 14
          DISK_FULL               = 15
          DP_TIMEOUT              = 16
          OUTROS                  = 17
          OTHERS                  = 18.

      IF SY-SUBRC <> 0.
        MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO
           WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4 RAISING OUTROS_ERROS.
      ENDIF.

      VG_LOTE = VG_LOTE + 1.
***
*    SUBMIT ZLESR0027
      CALL FUNCTION 'JOB_OPEN'
        EXPORTING
          JOBNAME  = 'IMP_RODOVIARIO'
        IMPORTING
          JOBCOUNT = JOBCOUNT.

*      SELTAB_WA-SELNAME = 'T_ARQ'.
      SELTAB_WA-SIGN    = 'I'.
      SELTAB_WA-OPTION  = 'EQ'.

      APPEND SELTAB_WA TO SELTAB.
      LOOP AT T_ARQUIVO.
        SELTAB_WA-LOW = T_ARQUIVO-LINHA.
        APPEND SELTAB_WA TO SELTAB.
      ENDLOOP.

      SUBMIT ZLESR0027
               USER SY-UNAME VIA JOB 'IMP_RODOVIARIO' NUMBER JOBCOUNT
               WITH T_ARQ IN SELTAB AND RETURN
               WITH lote = VG_LOTE
               WITH teste = wl_teste.

      CALL FUNCTION 'JOB_CLOSE'
        EXPORTING
          JOBCOUNT  = JOBCOUNT
          JOBNAME   = 'IMP_RODOVIARIO'
          STRTIMMED = 'X'.

*
*      CALL FUNCTION 'Z_PFE_ARQUIVO_REGISTOS'
*        TABLES
*          T_ARQUIVO          = T_ARQUIVO
*          T_REG_CABECALHO    = T_REG_CABECALHO
*          T_REG_ITENS        = T_REG_ITENS
*        CHANGING
*          VG_LOTE            = VG_LOTE
*        EXCEPTIONS
*          NAO_ADMINISTRADORA = 1
*          NAO_LOCAL_NEGOCIO  = 2
*          OTHERS             = 3.
*
*      CASE SY-SUBRC.
*        WHEN 1.
*          MESSAGE E002 WITH SY-MSGV1 RAISING NAO_ADMINISTRADORA.
*        WHEN 2.
*          MESSAGE E003 WITH SY-MSGV1 RAISING NAO_LOCAL_NEGOCIO.
*        WHEN 3.
*          MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4 RAISING OUTROS_ERROS.
*      ENDCASE.

    ENDLOOP.

  ENDIF.



ENDFUNCTION.
