DATA LW_COMPONENTS         TYPE TY_GENERIC_LIST.
DATA LV_ORDEM_CARREGAMENTO TYPE AUFK-ORDEMCARREG.
DATA LT_STPO               TYPE TABLE OF STPO_API02.

DATA(_SERVICES) = NEW ZCL_PP_SERVICES( ).

_SERVICES->SELECT_SHIPMENT(
  EXPORTING
  ORDEM_CARREGAMENTO = ORDEM_CARREGAMENTO
  EXCEPTIONS
  SHIPMENT_NOT_FOUND = 4
).

IF ( SY-SUBRC IS INITIAL ).
  DATA(_SHIPMENT) = _SERVICES->GET_SHIPMENT( ).

  "//Seleciona Empresa/nome
  SELECT SINGLE BUTXT
    FROM T001
    INTO GW_ORDER_HEADER-EMPRESA
   WHERE BUKRS = _SHIPMENT-BUKRS.

  "//Seleciona Filial/Nome
  SELECT SINGLE NAME
    FROM J_1BBRANCH
    INTO GW_ORDER_HEADER-FILIAL
   WHERE BUKRS  = _SHIPMENT-BUKRS
     AND BRANCH = _SHIPMENT-WERKS.

  "//Seleciona cliente/nome
  SELECT SINGLE A~KUNNR B~NAME1
    FROM VBAK AS A
   INNER JOIN KNA1 AS B ON A~KUNNR = B~KUNNR
    INTO (GW_ORDER_HEADER-CLIENTE,
          GW_ORDER_HEADER-NOME )
   WHERE VBELN = _SHIPMENT-KDAUF.

  "//Seleciona pedido
  SELECT SINGLE BSTKD
    FROM VBKD
    INTO GW_ORDER_HEADER-PEDIDO
   WHERE VBELN = _SHIPMENT-KDAUF.

  SELECT SINGLE NAME_TEXT
    FROM V_USERNAME
    INTO GW_ORDER_HEADER-USERNAME
   WHERE BNAME = SY-UNAME.

  _SERVICES->SELECT_MATERIAL(
   EXPORTING
    MATERIAL = _SHIPMENT-MATNR
   IMPORTING
    T_MARA = DATA(_MARA)
    T_MAKT = DATA(_MAKT)
  ).

  GW_ORDER_HEADER-REGISTRO_MAPA      = _MARA-GROES.
  GW_ORDER_HEADER-ORDEM_PRODUCAO     = _SHIPMENT-AUFNR.
  GW_ORDER_HEADER-ORDEM_CARREGAMENTO = _SHIPMENT-ORDEMCARREG.
  GW_ORDER_HEADER-DATA               = _SHIPMENT-ERDAT.
  GW_ORDER_HEADER-LOTE               = _SHIPMENT-AUFNR.
  GW_ORDER_HEADER-MATERIAL           = _SHIPMENT-MATNR.
  GW_ORDER_HEADER-TEXTO              = _MAKT-MAKTX.
  GW_ORDER_HEADER-QUANTIDADE         = _SHIPMENT-PSMNG.
  GW_ORDER_HEADER-PLACA              = _SHIPMENT-PLACA.

  "--- //OBTEM TEORES DO MATERIAL ACABADO
  PERFORM GET_TEOR_REAL
    USING _SHIPMENT-MATNR
          GW_FORMULATION
          _SERVICES.

  GW_FORMULATION-MENGE = GW_ORDER_HEADER-QUANTIDADE.
  GW_FORMULATION-IDNRK = GW_ORDER_HEADER-MATERIAL.
  GW_FORMULATION-DESCR = GW_ORDER_HEADER-TEXTO.
  "-- //END

  "--//OBTEM TEORES DAS MATÃ‰RIAS PRIMAS;
  PERFORM GET_COMPONENTS
   TABLES
    LT_STPO
   USING
    _SHIPMENT-MATNR
    _SHIPMENT-WERKS
    _SHIPMENT-STLAL.

  LOOP AT LT_STPO INTO DATA(LW_STPO).
    DATA COMPONENT TYPE MAKT-MATNR.

    CALL FUNCTION 'CONVERSION_EXIT_ALPHA_INPUT'
      EXPORTING
        INPUT  = LW_STPO-COMPONENT
      IMPORTING
        OUTPUT = COMPONENT.

    SELECT SINGLE *
      FROM MAKT
      INTO @DATA(LW_MAKT)
     WHERE MATNR = @COMPONENT.

    PERFORM GET_TEOR_REAL
      USING LW_STPO-COMPONENT LW_COMPONENTS _SERVICES.

    PERFORM GET_TEOR_NOMINAL
      USING LW_STPO-COMPONENT LW_COMPONENTS _SERVICES.

    TRY.
        LW_COMPONENTS-TOTAL = LW_STPO-COMP_QTY * GW_ORDER_HEADER-QUANTIDADE.
      CATCH CX_SY_CONVERSION_NO_NUMBER.
    ENDTRY.

    LW_COMPONENTS-IDNRK = LW_STPO-COMPONENT.
    LW_COMPONENTS-DESCR = LW_MAKT-MAKTX.
    LW_COMPONENTS-MENGE = LW_STPO-COMP_QTY.
    APPEND LW_COMPONENTS TO GT_COMPONENTS.

    CLEAR: LW_COMPONENTS.
  ENDLOOP.
  "-- //END
ENDIF.
