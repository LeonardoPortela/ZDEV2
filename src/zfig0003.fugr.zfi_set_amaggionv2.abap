FUNCTION ZFI_SET_AMAGGIONV2.
*"----------------------------------------------------------------------
*"*"Interface local:
*"  IMPORTING
*"     VALUE(I_INPUT) TYPE  ZDE_IN_AMAGGION_TO_S4_T OPTIONAL
*"  EXPORTING
*"     VALUE(RESPONSE) TYPE  ZDE_RETORNO_AMAGGION_T
*"----------------------------------------------------------------------

  DATA: LT_ZFIT0225 TYPE TABLE OF ZFIT0225.
  DATA: LS_ITAU_BOLETO TYPE ZDE_IN_ITAU_BOLETO.


* "// Armazenamento de LOG de Entrada
  INCLUDE ZAFL_MACROS.
  /AFL/LOG_INIT.
  /AFL/SAVE.

  LOOP AT I_INPUT INTO DATA(LS_INPUT).

    IF LS_INPUT-DADO_BOLETO-DADOS_INDIVIDUAIS_BOLETO IS NOT INITIAL.
      READ TABLE LS_INPUT-DADO_BOLETO-DADOS_INDIVIDUAIS_BOLETO INTO DATA(LS_BOLETO) INDEX 1.
    ENDIF.

    GET TIME STAMP FIELD DATA(TMS).

    APPEND
    VALUE #(
              NUMERO_PEDIDO       = LS_INPUT-NUMERO_PEDIDO
              ID_BENEFICIARIO     = LS_INPUT-BENEFICIARIO-ID_BENEFICIARIO
              NOSSO_NUMERO        = LS_BOLETO-NUMERO_NOSSO_NUMERO
              TXID                = LS_INPUT-DADOS_QRCODE-TXID
              USUARIO             = SY-UNAME
              DATA                = SY-DATUM
              HORA                = SY-UZEIT
              TIMESTEMP           = TMS
           ) TO LT_ZFIT0225.

    APPEND
    VALUE #(
              NUMERO_PEDIDO = LS_INPUT-NUMERO_PEDIDO
              ID_BENEFICIARIO = LS_INPUT-BENEFICIARIO-ID_BENEFICIARIO
              NUMERO_NOSSO_NUMERO = LS_BOLETO-NUMERO_NOSSO_NUMERO
           ) TO RESPONSE.

*"// Armazena os dados Do Boleto enviado pelo AMAGGION
    LS_ITAU_BOLETO =
    VALUE #(
             ID_BENEFICIARIO = LS_INPUT-BENEFICIARIO-ID_BENEFICIARIO
             NOSSO_NUMERO = LS_BOLETO-NUMERO_NOSSO_NUMERO
             CORRELATIONID = /AFL/LOG-GUID
             CONTROLE = SY-XFORM
           ).

    IF LS_ITAU_BOLETO-ID_BENEFICIARIO IS INITIAL.
      CONTINUE.
    ENDIF.

    IF LS_ITAU_BOLETO-NOSSO_NUMERO IS INITIAL.
      CONTINUE.
    ENDIF.

    CALL METHOD ZCL_FI_UTILS=>RUN_API_ITAU
      EXPORTING
        I_ITAU_BOLETO = LS_ITAU_BOLETO.

  ENDLOOP.

  MODIFY ZFIT0225 FROM TABLE LT_ZFIT0225.
  COMMIT WORK.

ENDFUNCTION.
