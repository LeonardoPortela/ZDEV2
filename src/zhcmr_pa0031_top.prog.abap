*&---------------------------------------------------------------------*
*&  Include           ZHCMR_PA0031_TOP
*&---------------------------------------------------------------------*

REPORT ZHCMR_PA0031.

TABLES: BSIK.

TYPES: BEGIN OF TY_ESTRUTURA.
        INCLUDE TYPE SLIS_FIELDCAT_MAIN.
        INCLUDE TYPE SLIS_FIELDCAT_ALV_SPEC.
TYPES: END OF TY_ESTRUTURA.

TYPES: BEGIN OF TY_SAIDA_0100,
         BUKRS        TYPE BSIK-BUKRS,
         BUTXT        TYPE T001-BUTXT,
         GJAHR        TYPE BSIK-GJAHR,
         LIFNR        TYPE LFA1-LIFNR,
         NAME1        TYPE LFA1-NAME1,
         BELNR        TYPE BSIK-BELNR,
         BUZEI        TYPE BSIK-BUZEI,
         BLDAT        TYPE BSIK-BLDAT,
         BUDAT        TYPE BSIK-BUDAT,
         WAERS        TYPE BSIK-WAERS,
         KOART        TYPE C,
         ZFBDT        TYPE BSIK-ZFBDT,
         DMBTR        TYPE BSIK-DMBTR,
         DMBE2        TYPE BSIK-DMBE2,
         DMBTR_BX     TYPE BSIK-DMBTR,
         AUGBL        TYPE BSIK-AUGBL,
         KURSF        TYPE BKPF-KURSF,
         SGTXT        TYPE BSIK-SGTXT,
         BSCHL        TYPE BSIK-BSCHL,
         UMSKS        TYPE BSIK-UMSKS,
         UMSKZ        TYPE BSIK-UMSKZ,
         SHKZG        TYPE BSIK-SHKZG,
         GSBER        TYPE BSIK-GSBER,
         KIDNO        TYPE BSIK-KIDNO,
         ZUONR        TYPE BSIK-ZUONR,
         XBLNR        TYPE BKPF-XBLNR,
         BLART        TYPE BSIK-BLART,
         ZTERM        TYPE BSIK-ZTERM,
         BL_DESMEMB   TYPE BSIK-BELNR,
         BZ_DESMEMB   TYPE BSIK-BUZEI,
         VLR_RSD      TYPE BSIK-DMBTR,
         NOME_ARQUIVO TYPE ZHCMT_PY_0019-NOME_ARQUIVO,
         US_FILE      TYPE C LENGTH 500,
         HKONT_BX     TYPE T012K-HKONT,
         HBKID        TYPE BSIK-HBKID.
TYPES END OF TY_SAIDA_0100.

TYPES: BEGIN OF TY_LFA1,
         LIFNR TYPE LFA1-LIFNR,
         NAME1 TYPE LFA1-NAME1,
       END OF TY_LFA1,

       BEGIN OF TY_T012K,
         BUKRS TYPE T012K-BUKRS,
         HBKID TYPE T012K-HBKID,
         HKONT TYPE T012K-HKONT,
       END OF TY_T012K,

       BEGIN OF TY_BSIK,
         BUKRS TYPE BSIK-BUKRS,
         LIFNR TYPE BSIK-LIFNR,
         BELNR TYPE BSIK-BELNR,
         BUZEI TYPE BSIK-BUZEI,
         BLDAT TYPE BSIK-BLDAT,
         BUDAT TYPE BSIK-BUDAT,
         GJAHR TYPE BSIK-GJAHR,
         ZFBDT TYPE BSIK-ZFBDT,
         DMBTR TYPE BSIK-DMBTR,
         DMBE2 TYPE BSIK-DMBE2,
         HBKID TYPE BSIK-HBKID,
         WAERS TYPE BSIK-WAERS,
         UMSKS TYPE BSIK-UMSKS,
         UMSKZ TYPE BSIK-UMSKZ,
         SHKZG TYPE BSIK-SHKZG,
         GSBER TYPE BSIK-GSBER,
         KIDNO TYPE BSIK-KIDNO,
         ZUONR TYPE BSIK-ZUONR,
         XBLNR TYPE BKPF-XBLNR,
         BLART TYPE BSIK-BLART,
         ZTERM TYPE BSIK-ZTERM,
         SGTXT TYPE BSIK-SGTXT,
         BSCHL TYPE BSIK-BSCHL,
       END OF TY_BSIK,

       BEGIN OF TY_T001,
         BUKRS      TYPE T001-BUKRS,
         BUTXT      TYPE T001-BUTXT,
         WAERS      TYPE T001-WAERS,
         WAERS2     TYPE X001-HWAE2,
       END OF TY_T001,

       BEGIN OF TY_BKPF,
         BUKRS TYPE BKPF-BUKRS,
         BELNR TYPE BKPF-BELNR,
         GJAHR TYPE BKPF-GJAHR,
         USNAM TYPE BKPF-USNAM,
         KURSF TYPE BKPF-KURSF,
         KURS2 TYPE BKPF-KURS2,
         STBLG TYPE BKPF-STBLG,
         CPUDT TYPE BKPF-CPUDT,
         CPUTM TYPE BKPF-CPUTM,
       END OF TY_BKPF,

       BEGIN OF TY_USER_ADDRP,
         BNAME      TYPE USER_ADDRP-BNAME,
         NAME_FIRST TYPE USER_ADDRP-NAME_FIRST,
       END OF TY_USER_ADDRP.

*---------------------------------------------------------------------*
*  Inicio Definition Classes
*---------------------------------------------------------------------*

CLASS LCL_ALV_TOOLBAR_0100 DEFINITION.
  PUBLIC SECTION.
*Constructor
    METHODS: CONSTRUCTOR
                IMPORTING IO_ALV_GRID TYPE REF TO CL_GUI_ALV_GRID,
*Event for toolbar
    ON_TOOLBAR FOR EVENT TOOLBAR OF CL_GUI_ALV_GRID
               IMPORTING  E_OBJECT,

    HANDLE_USER_COMMAND FOR EVENT USER_COMMAND OF CL_GUI_ALV_GRID
               IMPORTING E_UCOMM.

ENDCLASS.                    "LCL_ALV_TOOLBAR DEFINITION

CLASS LCL_EVENT_HANDLER_0100 DEFINITION.
  PUBLIC SECTION.

    CLASS-METHODS:
      CATCH_HOTSPOT FOR EVENT HOTSPOT_CLICK OF CL_GUI_ALV_GRID
            IMPORTING E_ROW_ID E_COLUMN_ID ES_ROW_NO,

      DATA_CHANGED_FINISHED FOR EVENT DATA_CHANGED_FINISHED OF CL_GUI_ALV_GRID
        IMPORTING E_MODIFIED ET_GOOD_CELLS SENDER.

ENDCLASS.

DATA: OBJ_ALV_0100         TYPE REF TO CL_GUI_ALV_GRID,
      OBJ_CONTAINER_0100   TYPE REF TO CL_GUI_CUSTOM_CONTAINER.

DATA: GT_CATALOG       TYPE LVC_T_FCAT,
      GW_CATALOG       TYPE LVC_S_FCAT.

DATA: OBJ_TOOLBAR_0100 TYPE REF TO LCL_ALV_TOOLBAR_0100.

* ALV field catalogs
DATA: IT_FCAT    TYPE LVC_T_FCAT,
      WA_FCAT    TYPE LVC_S_FCAT.

* ALV excluded functions
DATA: IT_EXCLUDE_FCODE TYPE UI_FUNCTIONS,
      WA_EXCLUDE_FCODE LIKE LINE OF IT_EXCLUDE_FCODE.

* Alv Styles
DATA: LS_EDIT         TYPE LVC_S_STYL,
      LT_EDIT         TYPE LVC_T_STYL.

* ALV layout variant
DATA: GS_VARIANT       TYPE DISVARIANT.

* ALV layout
DATA: GS_LAYOUT        TYPE LVC_S_LAYO.

* ALV Stable
DATA: WA_STABLE        TYPE LVC_S_STBL.

DATA: IT_SELECTEDCELL  TYPE LVC_T_CELL,
      WA_SELECTEDCELL  TYPE LVC_S_CELL.

DATA: IT_SEL_ROWS         TYPE LVC_T_ROW,
      WA_SEL_ROWS         TYPE LVC_S_ROW.

DATA: GT_ESTILO   TYPE LVC_T_STYL WITH HEADER LINE,
      WL_ESTILO   TYPE LVC_S_STYL.

DATA: GT_F4  TYPE LVC_T_F4 WITH HEADER LINE.

* Objetos
DATA: C_ALV_TOOLBARMANAGER TYPE REF TO CL_ALV_GRID_TOOLBAR_MANAGER,
      TY_TOOLBAR TYPE STB_BUTTON.

DATA: WA_ESTRUTURA       TYPE TY_ESTRUTURA,
      ESTRUTURA          TYPE TABLE OF TY_ESTRUTURA.

*-------------------------------------------------------------------
* Tabelas Internas and Work Areas.
*-------------------------------------------------------------------
DATA: IT_SAIDA_0100       TYPE TABLE OF TY_SAIDA_0100,
      IT_SAIDA_COMP       TYPE TABLE OF TY_SAIDA_0100,
      WA_SAIDA_0100       TYPE TY_SAIDA_0100,
      TG_LFA1_SET         TYPE TABLE OF TY_LFA1 WITH HEADER LINE,
      TG_LFA1             TYPE TABLE OF TY_LFA1 WITH HEADER LINE,
      TG_BSIK             TYPE TABLE OF TY_BSIK WITH HEADER LINE,
      TG_BKPF             TYPE TABLE OF TY_BKPF WITH HEADER LINE,
      TG_T012K            TYPE TABLE OF TY_T012K WITH HEADER LINE,
      TG_T001             TYPE TABLE OF TY_T001 WITH HEADER LINE,
      TG_USER_ADDRP       TYPE TABLE OF TY_USER_ADDRP WITH HEADER LINE.

DATA: GT_RETURN_TAB TYPE TABLE OF DDSHRETVAL WITH HEADER LINE,
      GT_DSELC      TYPE TABLE OF DSELC      WITH HEADER LINE.

*-------------------------------------------------------------------
* VÃ¡riaveis
*-------------------------------------------------------------------
DATA: VG_OPERACAO TYPE C LENGTH 20,
      VAR_ANSWER  TYPE C.

*-------------------------------------------------------------------
* Ranges
*-------------------------------------------------------------------

RANGES: R_LIFNR_SET FOR BSIK-LIFNR,
        R_GJAHR     FOR BSIK-GJAHR.

*-------------------------------------------------------------------
* Constantes
*-------------------------------------------------------------------
CONSTANTS: C_COMP_BANCO   TYPE C VALUE 'COMP_BANCO' LENGTH 12,
           C_COMP_LCTOS   TYPE C VALUE 'COMP_LCTOS' LENGTH 12.


SELECTION-SCREEN: BEGIN OF SCREEN 0001 AS SUBSCREEN.

SELECTION-SCREEN BEGIN OF LINE.
SELECTION-SCREEN COMMENT 02(15) TEXT-I01 FOR FIELD P_BUKRS.
SELECT-OPTIONS: P_BUKRS FOR BSIK-BUKRS.
SELECTION-SCREEN COMMENT 75(60) V_DS_EMP.
SELECTION-SCREEN END OF LINE.

SELECTION-SCREEN BEGIN OF LINE.
SELECTION-SCREEN COMMENT 02(15) TEXT-I02 FOR FIELD P_LIFNR.
SELECT-OPTIONS: P_LIFNR FOR BSIK-LIFNR NO INTERVALS.
SELECTION-SCREEN END OF LINE.

SELECTION-SCREEN BEGIN OF LINE.
SELECTION-SCREEN COMMENT 02(15) TEXT-I03 FOR FIELD P_ZFBDT.
SELECT-OPTIONS: P_ZFBDT FOR BSIK-ZFBDT.
SELECTION-SCREEN END OF LINE.


SELECTION-SCREEN: END OF SCREEN 0001.

AT SELECTION-SCREEN OUTPUT.

  CLEAR: V_DS_EMP.
  IF ( P_BUKRS-LOW  IS NOT INITIAL ) AND
     ( P_BUKRS-HIGH IS INITIAL     ) AND
     ( LINES( P_BUKRS ) EQ 1 ).
    SELECT SINGLE *
      FROM T001 INTO @DATA(_WL_T001)
     WHERE BUKRS = @P_BUKRS-LOW.

    IF SY-SUBRC = 0.
      V_DS_EMP = _WL_T001-BUTXT.
    ENDIF.
  ENDIF.


AT SELECTION-SCREEN ON VALUE-REQUEST FOR P_LIFNR-LOW.

  PERFORM F_GET_BANCO_SET.

  CALL FUNCTION 'F4IF_INT_TABLE_VALUE_REQUEST'
    EXPORTING
      RETFIELD        = 'LIFNR'
      DYNPPROG        = SY-REPID
      DYNPNR          = SY-DYNNR
      DYNPROFIELD     = 'P_LIFNR-LOW'
      VALUE_ORG       = 'S'
    TABLES
      VALUE_TAB       = TG_LFA1_SET
      RETURN_TAB      = GT_RETURN_TAB
      DYNPFLD_MAPPING = GT_DSELC.


INITIALIZATION.

 CALL SCREEN 0100.
