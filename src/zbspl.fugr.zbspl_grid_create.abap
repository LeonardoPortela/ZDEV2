FUNCTION ZBSPL_GRID_CREATE .
*"----------------------------------------------------------------------
*"*"Interface global:
*"  IMPORTING
*"     VALUE(IS_SETTINGS) LIKE  RFBILA_ALV_SETTINGS STRUCTURE
*"        RFBILA_ALV_SETTINGS
*"     VALUE(IT_LIST_COMMENTARY) TYPE  SLIS_T_LISTHEADER OPTIONAL
*"     REFERENCE(I_GRID_TITLE) TYPE  LVC_TITLE OPTIONAL
*"     REFERENCE(IS_GRID_SETTINGS) TYPE  LVC_S_GLAY OPTIONAL
*"     REFERENCE(P_BUKRS) TYPE  BUKRS
*"     REFERENCE(SD_CURT) TYPE  ALLGCRTP
*"     REFERENCE(SD_CURT2) TYPE  ALLGCRTP
*"     REFERENCE(I_DIR) TYPE  CHAR1 OPTIONAL
*"     REFERENCE(MONATINI) TYPE  RFSDO-BILABMON OPTIONAL
*"     REFERENCE(MONATFIM) TYPE  RFSDO-BILABMON OPTIONAL
*"----------------------------------------------------------------------
* local data declarations
  DATA: L_CB_PROGRAM LIKE SY-REPID   VALUE 'SAPLZBSPL'.
  DATA: LS_VARIANT   LIKE DISVARIANT.
  DATA: LS_LAYOUT    TYPE SLIS_LAYOUT_ALV.
  DATA: LT_FIELDCAT  TYPE SLIS_T_FIELDCAT_ALV.
  DATA: LT_SORT      TYPE SLIS_T_SORTINFO_ALV .
  DATA: LS_PRINT     TYPE SLIS_PRINT_ALV.
  DATA  LD_TLEVEL    TYPE NUMC2.                            "n1486648
  DATA: MOEDA_01 TYPE WAERS,
        MOEDA_02 TYPE WAERS,
        WA_T001  TYPE T001,
        E_X001   TYPE X001.
*----------------------------------------------------------------------*
  CALL FUNCTION 'RGRE_ERGSL_TEXT_GET'
    EXPORTING
      LANGUAGE        = IS_SETTINGS-FS_LANGUAGE
      BALANCE_VERSION = IS_SETTINGS-FS_VERSION
      TEXT_TYPE       = ' '    "<<< means all texts
    TABLES
      TEXT_TAB        = GT_ERGSL_TEXT.

* save RFBILA ALV SETTINGS
  GS_SETTINGS = IS_SETTINGS.

  PERFORM BSPL_GRID_TOTALS_CALCULATE TABLES GT_RSTHIE
                                            GT_BSPLDATA
                                            GT_GRIDTOTALS
                                      USING IS_SETTINGS.

  PERFORM BSPL_GRID_OUTTAB_FILL      TABLES GT_RSTHIE
                                            GT_BSPLDATA
                                            GT_GRIDTOTALS
                                            GT_ERGSL_TEXT
                                            GT_EDIT_SETTINGS
                                            GT_GRIDOUTTAB
                                      USING IS_SETTINGS.

* begin "n1486648
  CASE IS_SETTINGS-TOTALS_LEVEL.
    WHEN SPACE.
    WHEN 0.
      DELETE GT_GRIDOUTTAB
        WHERE RACCT > SPACE.
    WHEN OTHERS.
      LD_TLEVEL = IS_SETTINGS-TOTALS_LEVEL + 1.
      DELETE GT_GRIDOUTTAB
        WHERE RACCT > SPACE
        OR    TOTALS_LEVEL >= LD_TLEVEL
        OR    TLEVEL       > LD_TLEVEL.
  ENDCASE.
* end "n1486648

  CALL FUNCTION 'REUSE_ALV_FIELDCATALOG_MERGE'
    EXPORTING
      I_PROGRAM_NAME         = L_CB_PROGRAM
      I_STRUCTURE_NAME       = 'ZBSPL_GRID_FIELDCAT'
      I_CLIENT_NEVER_DISPLAY = 'X'
    CHANGING
      CT_FIELDCAT            = LT_FIELDCAT
    EXCEPTIONS
      INCONSISTENT_INTERFACE = 1
      PROGRAM_ERROR          = 2
      OTHERS                 = 3.

  IF SY-SUBRC <> 0.
    MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
  ENDIF.

  CALL FUNCTION 'FI_CURRENCY_INFORMATION'
    EXPORTING
      I_BUKRS                = P_BUKRS
    IMPORTING
      E_X001                 = E_X001
    EXCEPTIONS
      CURRENCY_2_NOT_DEFINED = 1
      CURRENCY_3_NOT_DEFINED = 2
      OTHERS                 = 3.

  IF SY-SUBRC <> 0.
    MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
  ENDIF.

  SELECT SINGLE * INTO WA_T001 FROM T001 WHERE BUKRS EQ P_BUKRS.

  IF SD_CURT EQ '10'.
    MOEDA_01 = WA_T001-WAERS.
  ELSEIF SD_CURT EQ E_X001-CURT2.
    MOEDA_01 = E_X001-HWAE2.
  ELSEIF SD_CURT EQ E_X001-CURT3.
    MOEDA_01 = E_X001-HWAE3.
  ENDIF.

  IF SD_CURT2 EQ '10'.
    MOEDA_02 = WA_T001-WAERS.
  ELSEIF SD_CURT2 EQ E_X001-CURT2.
    MOEDA_02 = E_X001-HWAE2.
  ELSEIF SD_CURT2 EQ E_X001-CURT3.
    MOEDA_02 = E_X001-HWAE3.
  ENDIF.

  LOOP AT LT_FIELDCAT ASSIGNING <FIELDCAT>.

    IF <FIELDCAT>-FIELDNAME EQ 'KTOPL' OR
       <FIELDCAT>-FIELDNAME EQ 'KKTPL' OR
       <FIELDCAT>-FIELDNAME EQ 'BILKT' OR
       <FIELDCAT>-FIELDNAME EQ 'KTOP2' OR
       <FIELDCAT>-FIELDNAME EQ 'ALTKT' OR
       <FIELDCAT>-FIELDNAME EQ 'RBUKRS' OR
       <FIELDCAT>-FIELDNAME EQ 'RBUSA' OR
       <FIELDCAT>-FIELDNAME EQ 'RFAREA' OR
       <FIELDCAT>-FIELDNAME EQ 'RYEAR' OR
       <FIELDCAT>-FIELDNAME EQ 'POPER' OR
       <FIELDCAT>-FIELDNAME EQ 'CURTP'.
      <FIELDCAT>-NO_OUT = CON_X.
    ENDIF.

    IF <FIELDCAT>-FIELDNAME EQ 'TEXT'.
      <FIELDCAT>-OUTPUTLEN = 40.
    ENDIF.

    IF <FIELDCAT>-FIELDNAME EQ 'KTOPL'.
      <FIELDCAT>-OUTPUTLEN = 30.
    ENDIF.

    IF <FIELDCAT>-FIELDNAME EQ 'REPVAL'   OR
       <FIELDCAT>-FIELDNAME EQ 'COMPVAL'  OR
       <FIELDCAT>-FIELDNAME EQ 'REPVAL2'  OR
       <FIELDCAT>-FIELDNAME EQ 'COMPVAL2'.
      <FIELDCAT>-OUTPUTLEN = 15.
    ENDIF.

    IF <FIELDCAT>-FIELDNAME EQ 'ABSVAR'   OR
       <FIELDCAT>-FIELDNAME EQ 'ABSVAR2'.
      <FIELDCAT>-OUTPUTLEN = 10.
      "<FIELDCAT>-NO_OUT = CON_X.
    ENDIF.

    IF <FIELDCAT>-FIELDNAME EQ 'REPVALV'  OR
       <FIELDCAT>-FIELDNAME EQ 'REPVAL2V' OR
       <FIELDCAT>-FIELDNAME EQ 'REPVAL3V'.
      <FIELDCAT>-OUTPUTLEN = 10.
      "<FIELDCAT>-NO_ZERO   = ABAP_TRUE.
    ENDIF.

    IF <FIELDCAT>-FIELDNAME EQ 'RELVAR'   OR
       <FIELDCAT>-FIELDNAME EQ 'RELVAR2'.
      <FIELDCAT>-OUTPUTLEN = 7.
    ENDIF.

    IF <FIELDCAT>-FIELDNAME EQ 'WAERS' OR
       <FIELDCAT>-FIELDNAME EQ 'WAER2'.
      <FIELDCAT>-OUTPUTLEN = 10.
      <FIELDCAT>-JUST      = 'C'.
    ENDIF.

    IF <FIELDCAT>-FIELDNAME EQ 'ERGSL'.
      <FIELDCAT>-OUTPUTLEN = 6.
    ENDIF.

  ENDLOOP.

  PERFORM BSPL_GRID_ALV_INTERFACE_SET
                               TABLES LT_FIELDCAT
                                USING IS_SETTINGS
                                      MOEDA_01
                                      MOEDA_02
                             CHANGING L_CB_PROGRAM
                                      LS_VARIANT
                                      LS_LAYOUT.

  PERFORM BSPL_GRID_SORTINFOS_SET  TABLES LT_SORT[].
  PERFORM BSPL_GRID_NEWPAGE_SET    TABLES GT_GRIDOUTTAB.
  PERFORM BSPL_GRID_PRINTINFOS_SET USING  LS_PRINT.

  BREAK ABAP.
  LOOP AT LT_FIELDCAT ASSIGNING <FIELDCAT>.

    IF I_DIR EQ 'W'.
      IF <FIELDCAT>-FIELDNAME NE 'ERGSL' AND
         <FIELDCAT>-FIELDNAME NE 'TEXT'  AND
         <FIELDCAT>-FIELDNAME NE 'WAERS' AND
         <FIELDCAT>-FIELDNAME NE 'RACCT'.
        <FIELDCAT>-NO_OUT = ABAP_TRUE.
      ENDIF.

      IF <FIELDCAT>-FIELDNAME EQ 'RBUSA'.
        <FIELDCAT>-NO_OUT = ABAP_FALSE.
      ENDIF.

      IF <FIELDCAT>-FIELDNAME CS 'PER0' OR <FIELDCAT>-FIELDNAME CS 'PER1'.
        <FIELDCAT>-SELTEXT_L    = |Per.{ <FIELDCAT>-FIELDNAME+3(2) }|.
        <FIELDCAT>-SELTEXT_M    = <FIELDCAT>-SELTEXT_L.
        <FIELDCAT>-SELTEXT_S    = <FIELDCAT>-SELTEXT_L.
        <FIELDCAT>-REPTEXT_DDIC = <FIELDCAT>-SELTEXT_L.
        <FIELDCAT>-OUTPUTLEN    = 10.

        IF <FIELDCAT>-FIELDNAME+3(2) BETWEEN MONATINI AND MONATFIM.
          <FIELDCAT>-NO_OUT = ABAP_FALSE.
        ELSE.
          <FIELDCAT>-NO_OUT = ABAP_TRUE.
        ENDIF.

      ENDIF.
    ELSE.
      IF <FIELDCAT>-FIELDNAME CS 'PER0' OR <FIELDCAT>-FIELDNAME CS 'PER1'.
        <FIELDCAT>-NO_OUT = ABAP_TRUE.
      ENDIF.
    ENDIF.


  ENDLOOP.

  CALL FUNCTION 'REUSE_ALV_GRID_DISPLAY'
    EXPORTING
      I_CALLBACK_PROGRAM          = L_CB_PROGRAM
      I_CALLBACK_PF_STATUS_SET    = 'BSPL_GRID_PF_STATUS_SET'
      I_CALLBACK_USER_COMMAND     = 'BSPL_GRID_USER_COMMAND'
      I_CALLBACK_TOP_OF_PAGE      = 'BSPL_GRID_TOP'
      I_CALLBACK_HTML_TOP_OF_PAGE = 'BSPL_GRID_TOP_HTML'
      I_GRID_TITLE                = I_GRID_TITLE
      I_GRID_SETTINGS             = IS_GRID_SETTINGS
      IS_LAYOUT                   = LS_LAYOUT
      IT_FIELDCAT                 = LT_FIELDCAT
      IT_SORT                     = LT_SORT
      I_DEFAULT                   = 'X'
      I_SAVE                      = 'A'
      IS_VARIANT                  = LS_VARIANT
      IS_PRINT                    = LS_PRINT
    TABLES
      T_OUTTAB                    = GT_GRIDOUTTAB
    EXCEPTIONS
      PROGRAM_ERROR               = 1
      OTHERS                      = 2.

  IF SY-SUBRC <> 0.
    MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO
            WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
  ENDIF.

  "  PERFORM call_badi_exit TABLES gt_gridouttab
  "                                it_list_commentary.

ENDFUNCTION.
