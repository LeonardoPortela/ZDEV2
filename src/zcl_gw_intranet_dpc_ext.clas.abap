class ZCL_GW_INTRANET_DPC_EXT definition
  public
  inheriting from ZCL_GW_INTRANET_DPC
  create public .

public section.
protected section.

  methods ENTITYEMPLOYEE_GET_ENTITYSET
    redefinition .
  methods FIREDEMPLOYEES_GET_ENTITYSET
    redefinition .
  methods HIREDEMPLOYEES_GET_ENTITYSET
    redefinition .
private section.
ENDCLASS.



CLASS ZCL_GW_INTRANET_DPC_EXT IMPLEMENTATION.


  METHOD ENTITYEMPLOYEE_GET_ENTITYSET.
    DATA EMPLOYEE TYPE ZHCMS_INTRANET_EMPLOYEE_DATA.

    SELECT *
      FROM ZHCMT0007
      INTO TABLE @DATA(USERS)
     WHERE SITUACAO = 'ATIVO'.

    CHECK NOT USERS IS INITIAL.
    DATA(_IMAGE_HELPER) = NEW ZCL_IMAGE_HELPER( ).

    LOOP AT USERS INTO DATA(_USER).

      SELECT SINGLE GESCH
        FROM PA0002
        INTO @DATA(_SEXO)
       WHERE PERNR = @_USER-PERNR.

      CONCATENATE _USER-DAT01+6(2) _USER-DAT01+4(2) _USER-DAT01(4) INTO EMPLOYEE-DT_ADMISSAO   SEPARATED BY '/'.
      CONCATENATE _USER-FDATE+6(2) _USER-FDATE+4(2) _USER-FDATE(4) INTO EMPLOYEE-DT_DEMISSAO   SEPARATED BY '/'.
      CONCATENATE _USER-GBDAT+6(2) _USER-GBDAT+4(2) _USER-GBDAT(4) INTO EMPLOYEE-DT_NASCIMENTO SEPARATED BY '/'.

      _IMAGE_HELPER->GET_PHOTO(
        EXPORTING
          ID     = ZCL_IMAGE_HELPER=>ID_REPOSITORY-HR_PHOTO
          NAME   = CONV #( _USER-PERNR )
        RECEIVING
          RESULT = EMPLOYEE-FOTO_BASE64
      ).

*      SELECT SINGLE A~ORGTX
*        INTO EMPLOYEE-AREA
*        FROM T527X AS A
*       INNER JOIN PA0001 AS B ON B~ORGEH = A~ORGEH
*       WHERE A~SPRSL = SY-LANGU
*         AND A~ENDDA = '99991231'
*         AND B~PERNR = _USER-PERNR.

      SELECT SINGLE LTEXT
      INTO EMPLOYEE-AREA
      FROM CSKT AS A
      INNER JOIN PA0001 AS B ON B~KOSTL = A~KOSTL
         WHERE A~SPRAS EQ SY-LANGU
           AND A~DATBI EQ '99991231'
           AND B~ENDDA EQ '99991231'
           AND B~PERNR EQ _USER-PERNR.

      EMPLOYEE-SEXO          = SWITCH #( _SEXO WHEN '1' THEN 'M' WHEN '2' THEN 'F' ELSE '' ).
      EMPLOYEE-MATRICULA     = _USER-PERNR.
      EMPLOYEE-NOME          = _USER-CNAME.
      EMPLOYEE-APELIDO       = _USER-CNAME.
      EMPLOYEE-EMPRESA       = _USER-BUKRS.
      EMPLOYEE-CNPJ_EMPRESA  = _USER-STCD1.
      EMPLOYEE-NOME_EMPRESA  = _USER-BUTXT.
      EMPLOYEE-UNIDADE       = _USER-WERKS.
      EMPLOYEE-NOME_UNIDADE  = _USER-WERKSN.
      EMPLOYEE-CARGO         = _USER-FUNCAO.
      EMPLOYEE-CPF           = _USER-CPF_NR.
      EMPLOYEE-SUPERIOR      = _USER-SUP_CNAME.
      EMPLOYEE-CPF_SUPERIOR  = _USER-SUP_CPF_NR.
      EMPLOYEE-EMAIL         = _USER-EMAIL.

      APPEND EMPLOYEE TO ET_ENTITYSET.
      CLEAR EMPLOYEE.
    ENDLOOP.
  ENDMETHOD.


  METHOD FIREDEMPLOYEES_GET_ENTITYSET.

    DATA EMPLOYEE TYPE ZHCMS_INTRANET_EMPLOYEE_DATA.

    SELECT *
      FROM ZHCMT0007
      INTO TABLE @DATA(USERS)
     WHERE FDATE = @SY-DATUM.

    CHECK NOT USERS IS INITIAL.
    DATA(_IMAGE_HELPER) = NEW ZCL_IMAGE_HELPER( ).

    LOOP AT USERS INTO DATA(_USER).

      SELECT SINGLE GESCH
        FROM PA0002
        INTO @DATA(_SEXO)
       WHERE PERNR = @_USER-PERNR.

      CONCATENATE _USER-DAT01+6(2) _USER-DAT01+4(2) _USER-DAT01(4) INTO EMPLOYEE-DT_ADMISSAO   SEPARATED BY '/'.
      CONCATENATE _USER-FDATE+6(2) _USER-FDATE+4(2) _USER-FDATE(4) INTO EMPLOYEE-DT_DEMISSAO   SEPARATED BY '/'.
      CONCATENATE _USER-GBDAT+6(2) _USER-GBDAT+4(2) _USER-GBDAT(4) INTO EMPLOYEE-DT_NASCIMENTO SEPARATED BY '/'.

      _IMAGE_HELPER->GET_PHOTO(
        EXPORTING
          ID     = ZCL_IMAGE_HELPER=>ID_REPOSITORY-HR_PHOTO
          NAME   = CONV #( _USER-PERNR )
        RECEIVING
          RESULT = EMPLOYEE-FOTO_BASE64
      ).

*      SELECT SINGLE A~ORGTX
*        INTO EMPLOYEE-AREA
*        FROM T527X AS A
*       INNER JOIN PA0001 AS B ON B~ORGEH = A~ORGEH
*       WHERE A~SPRSL = SY-LANGU
*         AND A~ENDDA = '99991231'
*         AND B~PERNR = _USER-PERNR.

      SELECT SINGLE LTEXT
        INTO EMPLOYEE-AREA
        FROM CSKT AS A
        INNER JOIN PA0001 AS B ON B~KOSTL = A~KOSTL
         WHERE A~SPRAS EQ SY-LANGU
           AND A~DATBI EQ '99991231'
           AND B~ENDDA EQ '99991231'
           AND B~PERNR EQ _USER-PERNR.

      EMPLOYEE-SEXO          = SWITCH #( _SEXO WHEN '1' THEN 'M' WHEN '2' THEN 'F' ELSE '' ).
      EMPLOYEE-MATRICULA     = _USER-PERNR.
      EMPLOYEE-NOME          = _USER-CNAME.
      EMPLOYEE-APELIDO       = _USER-CNAME.
      EMPLOYEE-EMPRESA       = _USER-BUKRS.
      EMPLOYEE-CNPJ_EMPRESA  = _USER-STCD1.
      EMPLOYEE-NOME_EMPRESA  = _USER-BUTXT.
      EMPLOYEE-UNIDADE       = _USER-WERKS.
      EMPLOYEE-NOME_UNIDADE  = _USER-WERKSN.
      EMPLOYEE-CARGO         = _USER-FUNCAO.
      EMPLOYEE-CPF           = _USER-CPF_NR.
      EMPLOYEE-SUPERIOR      = _USER-SUP_CNAME.
      EMPLOYEE-CPF_SUPERIOR  = _USER-SUP_CPF_NR.
      EMPLOYEE-EMAIL         = _USER-EMAIL.

      APPEND EMPLOYEE TO ET_ENTITYSET.
      CLEAR EMPLOYEE.
    ENDLOOP.
  ENDMETHOD.


  METHOD HIREDEMPLOYEES_GET_ENTITYSET.
    DATA EMPLOYEE TYPE ZHCMS_INTRANET_EMPLOYEE_DATA.

    SELECT *
      FROM ZHCMT0007
      INTO TABLE @DATA(USERS)
     WHERE DAT01 = @SY-DATUM.

    CHECK NOT USERS IS INITIAL.
    DATA(_IMAGE_HELPER) = NEW ZCL_IMAGE_HELPER( ).

    LOOP AT USERS INTO DATA(_USER).

      SELECT SINGLE GESCH
        FROM PA0002
        INTO @DATA(_SEXO)
       WHERE PERNR = @_USER-PERNR.

      CONCATENATE _USER-DAT01+6(2) _USER-DAT01+4(2) _USER-DAT01(4) INTO EMPLOYEE-DT_ADMISSAO   SEPARATED BY '/'.
      CONCATENATE _USER-FDATE+6(2) _USER-FDATE+4(2) _USER-FDATE(4) INTO EMPLOYEE-DT_DEMISSAO   SEPARATED BY '/'.
      CONCATENATE _USER-GBDAT+6(2) _USER-GBDAT+4(2) _USER-GBDAT(4) INTO EMPLOYEE-DT_NASCIMENTO SEPARATED BY '/'.

      _IMAGE_HELPER->GET_PHOTO(
        EXPORTING
          ID     = ZCL_IMAGE_HELPER=>ID_REPOSITORY-HR_PHOTO
          NAME   = CONV #( _USER-PERNR )
        RECEIVING
          RESULT = EMPLOYEE-FOTO_BASE64
      ).

*      SELECT SINGLE A~ORGTX
*        INTO EMPLOYEE-AREA
*        FROM T527X AS A
*       INNER JOIN PA0001 AS B ON B~ORGEH = A~ORGEH
*       WHERE A~SPRSL = SY-LANGU
*         AND A~ENDDA = '99991231'
*         AND B~PERNR = _USER-PERNR.

      SELECT SINGLE LTEXT
        INTO EMPLOYEE-AREA
        FROM CSKT AS A
        INNER JOIN PA0001 AS B ON B~KOSTL = A~KOSTL
         WHERE A~SPRAS EQ SY-LANGU
           AND A~DATBI EQ '99991231'
           AND B~ENDDA EQ '99991231'
           AND B~PERNR EQ _USER-PERNR.

      EMPLOYEE-SEXO          = SWITCH #( _SEXO WHEN '1' THEN 'M' WHEN '2' THEN 'F' ELSE '' ).
      EMPLOYEE-MATRICULA     = _USER-PERNR.
      EMPLOYEE-NOME          = _USER-CNAME.
      EMPLOYEE-APELIDO       = _USER-CNAME.
      EMPLOYEE-EMPRESA       = _USER-BUKRS.
      EMPLOYEE-CNPJ_EMPRESA  = _USER-STCD1.
      EMPLOYEE-NOME_EMPRESA  = _USER-BUTXT.
      EMPLOYEE-UNIDADE       = _USER-WERKS.
      EMPLOYEE-NOME_UNIDADE  = _USER-WERKSN.
      EMPLOYEE-CARGO         = _USER-FUNCAO.
      EMPLOYEE-CPF           = _USER-CPF_NR.
      EMPLOYEE-SUPERIOR      = _USER-SUP_CNAME.
      EMPLOYEE-CPF_SUPERIOR  = _USER-SUP_CPF_NR.
      EMPLOYEE-EMAIL         = _USER-EMAIL.

      APPEND EMPLOYEE TO ET_ENTITYSET.
      CLEAR EMPLOYEE.
    ENDLOOP.

  ENDMETHOD.
ENDCLASS.
