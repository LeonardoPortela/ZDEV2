*&---------------------------------------------------------------------*
*& Report  ZLESR0125
*&
*&---------------------------------------------------------------------*
*&
*&
*&---------------------------------------------------------------------*
REPORT ZLESR0125.

TABLES: ZLEST0032,  VTTK.



TYPES: BEGIN OF TY_EKBE,
         EBELN TYPE EKBE-EBELN,
         EBELP TYPE EKBE-EBELP,
         BEWTP TYPE EKBE-BEWTP,
         LFBNR TYPE EKBE-LFBNR,
         BELNR TYPE EKBE-BELNR,
         GJAHR TYPE EKBE-GJAHR,
       END OF   TY_EKBE.

TYPES: BEGIN OF TY_RBKP,
         BELNR TYPE RBKP-BELNR,
         GJAHR TYPE RBKP-GJAHR,
         STBLG TYPE RBKP-STBLG,
         XBLNR TYPE RBKP-XBLNR,
         LIFNR TYPE RBKP-LIFNR,
         BUKRS TYPE RBKP-BUKRS,
         BUPLA TYPE RBKP-BUPLA,
       END OF TY_RBKP.

TYPES: BEGIN OF TY_J_1BNFLIN,
         REFKEY TYPE J_1BNFLIN-REFKEY,
         REFITM TYPE J_1BNFLIN-REFITM,
         REFTYP TYPE J_1BNFLIN-REFTYP,
         DOCNUM TYPE J_1BNFLIN-DOCNUM,
       END OF TY_J_1BNFLIN.

TYPES: BEGIN OF TY_J_1BNFDOC,
         NFENUM TYPE J_1BNFDOC-NFENUM,
         SERIES TYPE J_1BNFDOC-SERIES,
         BUKRS  TYPE J_1BNFDOC-BUKRS,
         PARID  TYPE J_1BNFDOC-PARID,
         BRANCH TYPE J_1BNFDOC-BRANCH,
         DOCNUM TYPE J_1BNFDOC-DOCNUM,
         NFNUM  TYPE J_1BNFDOC-NFNUM,
       END OF TY_J_1BNFDOC.


DATA: T_SAIDA          TYPE TABLE OF ZLEST0032,
      T_ZLEST0032      TYPE TABLE OF ZLEST0032,
      T_EKBE           TYPE TABLE OF TY_EKBE,
      T_RBKP           TYPE TABLE OF TY_RBKP,
      T_J_1BNFLIN      TYPE TABLE OF TY_J_1BNFLIN,
      T_J_1BNFDOC      TYPE TABLE OF TY_J_1BNFDOC,
      T_J_1BNFDOC_AUX  TYPE TABLE OF TY_J_1BNFDOC,
      WA_SAIDA         TYPE ZLEST0032,
      WA_ZLEST0032     TYPE ZLEST0032,
      WA_EKBE          TYPE TY_EKBE,
      WA_RBKP          TYPE TY_RBKP,
      WA_J_1BNFLIN     TYPE TY_J_1BNFLIN,
      WA_J_1BNFDOC     TYPE TY_J_1BNFDOC,
      WA_J_1BNFDOC_AUX TYPE TY_J_1BNFDOC.

DATA: V_REFKEY    TYPE J_1BNFLIN-REFKEY,
      V_NFNUM     TYPE J_1BNFDOC-NFNUM,
      V_NFENUM(9) TYPE C,
      NFNUM       TYPE J_1BNFDOC-NFNUM,
      V_SERIES    TYPE J_1BNFDOC-SERIES,
      V_XBLNR(16) TYPE C,
      DATAINI     TYPE SY-DATUM,
      DATAFIM     TYPE SY-DATUM.



SELECTION-SCREEN BEGIN OF BLOCK B1 WITH FRAME TITLE TEXT-001.
SELECT-OPTIONS:  P_TKNUM FOR VTTK-TKNUM.
SELECTION-SCREEN END OF BLOCK B1.

INITIALIZATION.


START-OF-SELECTION.

  SELECT SINGLE COUNT(*) INTO @DATA(VG_JOB)
      FROM TBTCO
     WHERE JOBNAME EQ 'ZLEST0032_ATUALIZA_MIRO_TERCEIRO'
       AND STATUS EQ 'R'.

  PERFORM SELECIONA_DADOS.

END-OF-SELECTION.


FORM SELECIONA_DADOS.

  CLEAR: V_REFKEY,
         V_NFNUM,
         V_NFENUM,
         NFNUM,
         V_SERIES,
         V_XBLNR.

  IF ( VG_JOB EQ 1 ).
    CONCATENATE  SY-DATUM(4)  SY-DATUM+4(2) '01'  INTO DATAINI.

    CALL FUNCTION 'DATE_GET_MONTH_LASTDAY'
      EXPORTING
        I_DATE = DATAINI
      IMPORTING
        E_DATE = DATAFIM.

    SELECT  *
      FROM ZLEST0032
      INTO TABLE T_ZLEST0032
    WHERE DATA  BETWEEN DATAINI AND DATAFIM
    AND   ADD03 EQ '0000000002'
    AND   BELNR EQ ' '.

  ELSE.
    SELECT  *
      FROM ZLEST0032
      INTO TABLE T_ZLEST0032
    WHERE TKNUM  IN P_TKNUM
    AND   ADD03 EQ '0000000002'
    AND   BELNR EQ ' '.
  ENDIF.

  READ TABLE T_ZLEST0032 INTO WA_ZLEST0032 WITH KEY  ADD03 = '0000000002'
                                                     BELNR = ' '.
  IF SY-SUBRC = 0.

    SELECT EBELN EBELP
           BEWTP LFBNR
           BELNR GJAHR
      FROM EKBE
      INTO TABLE T_EKBE
     FOR ALL ENTRIES IN T_ZLEST0032
   WHERE LFBNR EQ T_ZLEST0032-LBLNI
    AND  EBELN EQ T_ZLEST0032-EBELN
    AND  EBELP EQ '00001'
    AND  BEWTP EQ 'Q'.

    READ TABLE T_EKBE INTO WA_EKBE  WITH KEY EBELN = WA_ZLEST0032-EBELN
                                             EBELP = '0001'
                                             BEWTP = 'Q'
                                             LFBNR = WA_ZLEST0032-LBLNI.

    IF SY-SUBRC = 0.
      CONCATENATE WA_EKBE-BELNR  WA_EKBE-GJAHR  INTO V_REFKEY.

      SELECT BELNR  GJAHR
             STBLG  XBLNR
             LIFNR  BUKRS
             BUPLA
        FROM RBKP
        INTO TABLE T_RBKP
        FOR ALL ENTRIES IN T_EKBE
      WHERE BELNR EQ T_EKBE-BELNR   "(miro)
      AND   GJAHR EQ T_EKBE-GJAHR   "(ano da miro)
      AND   STBLG EQ ' '.

    ENDIF.

    READ TABLE T_RBKP INTO WA_RBKP WITH KEY BELNR = WA_EKBE-BELNR
                                            GJAHR = WA_EKBE-GJAHR.
    IF SY-SUBRC = 0.
      NFNUM    = WA_RBKP-XBLNR.
      V_SERIES = NFNUM+5(1).
      V_NFNUM  = WA_RBKP-XBLNR(5).
      V_NFENUM = V_NFNUM.
    ENDIF.

    SELECT REFKEY  REFITM
           REFTYP  DOCNUM
      FROM J_1BNFLIN
      INTO TABLE T_J_1BNFLIN
    WHERE REFKEY EQ V_REFKEY
    AND   REFITM EQ '000001'
    AND   REFTYP EQ 'LI'.

    IF T_J_1BNFLIN[] IS INITIAL.
      SELECT NFENUM SERIES
             BUKRS  PARID
             BRANCH DOCNUM
             NFNUM
        FROM J_1BNFDOC
        INTO TABLE T_J_1BNFDOC
     WHERE NFNUM  EQ V_NFNUM
      AND  SERIES EQ V_SERIES
      AND  BUKRS  EQ WA_RBKP-BUKRS
      AND  PARID  EQ WA_RBKP-LIFNR.
      "AND  BRANCH EQ WA_RBKP-BUPLA

      IF T_J_1BNFDOC[] IS INITIAL.
        SELECT NFENUM SERIES
               BUKRS  PARID
               BRANCH DOCNUM
               NFNUM
          FROM J_1BNFDOC
          INTO TABLE T_J_1BNFDOC_AUX
       WHERE NFENUM EQ V_NFENUM
        AND  SERIES EQ V_SERIES
        AND  BUKRS  EQ WA_RBKP-BUKRS
        AND  PARID  EQ WA_RBKP-LIFNR.

      ENDIF.
    ENDIF.
    PERFORM TRATA_DADOS.

  ELSE.
    IF ( VG_JOB NE 1 ).
      MESSAGE TEXT-002 TYPE 'I'.
      EXIT.
    ENDIF.
  ENDIF.
ENDFORM.

FORM TRATA_DADOS.

  LOOP AT T_ZLEST0032 INTO WA_ZLEST0032.

    WA_SAIDA-TKNUM    = WA_ZLEST0032-TKNUM.
    WA_SAIDA-ADD03    = WA_ZLEST0032-ADD03.
    WA_SAIDA-FKNUM    = WA_ZLEST0032-FKNUM.
    WA_SAIDA-EBELN    = WA_ZLEST0032-EBELN.
    WA_SAIDA-EBELP    = WA_ZLEST0032-EBELP.
    WA_SAIDA-LBLNI    = WA_ZLEST0032-LBLNI.
    WA_SAIDA-DATA     = WA_ZLEST0032-DATA.
    WA_SAIDA-HORA     = WA_ZLEST0032-HORA.
    WA_SAIDA-NOME     = WA_ZLEST0032-NOME.
    WA_SAIDA-STATUS1  = 'X'.

    READ TABLE T_EKBE INTO WA_EKBE WITH KEY  EBELN = WA_ZLEST0032-EBELN
                                             EBELP = '0001'
                                             BEWTP = 'Q'
                                             LFBNR = WA_ZLEST0032-LBLNI.
    IF SY-SUBRC = 0.
      WA_SAIDA-BELNR = WA_EKBE-BELNR.
      WA_SAIDA-GJAHR = WA_EKBE-GJAHR.

    ENDIF.

    IF T_J_1BNFLIN[] IS NOT INITIAL.

      READ TABLE T_J_1BNFLIN INTO WA_J_1BNFLIN WITH KEY REFKEY = V_REFKEY
                                                        REFITM = '000001'
                                                        REFTYP = 'LI'.
      WA_SAIDA-DOCNUM = WA_J_1BNFLIN-DOCNUM.
    ELSE.
      READ TABLE T_J_1BNFDOC INTO WA_J_1BNFDOC WITH KEY NFNUM  = V_NFNUM
                                                        SERIES = V_SERIES
                                                        BUKRS  = WA_RBKP-BUKRS.
      WA_SAIDA-DOCNUM = WA_J_1BNFDOC-DOCNUM.
    ENDIF.

    MODIFY ZLEST0032 FROM WA_SAIDA.
    CLEAR: WA_SAIDA.
  ENDLOOP.

  IF ( VG_JOB NE 1 ).
    MESSAGE TEXT-003 TYPE 'I'.
  ENDIF.

ENDFORM.
