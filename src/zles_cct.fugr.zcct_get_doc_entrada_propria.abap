FUNCTION ZCCT_GET_DOC_ENTRADA_PROPRIA .
*"----------------------------------------------------------------------
*"*"Interface local:
*"  IMPORTING
*"     REFERENCE(I_NUMNF) TYPE  J_1BNFNUM9
*"     REFERENCE(I_DT_EMISSAO) TYPE  ZDE_DT_EMISSAO
*"     REFERENCE(I_SERIE) TYPE  J_1BSERIES
*"     REFERENCE(I_CNPJ) TYPE  STCD1
*"     REFERENCE(I_CPF) TYPE  STCD2
*"  CHANGING
*"     REFERENCE(C_RETORNO) TYPE  ZDE_RETORNO_PROC
*"     REFERENCE(C_DOCNUM) TYPE  J_1BDOCNUM
*"----------------------------------------------------------------------

  DATA: TG_PARC             TYPE TABLE OF TY_PARC          WITH HEADER LINE,
        TG_SERIES           TYPE TABLE OF TY_SERIES        WITH HEADER LINE,
        TG_ZMMT_EE_ZGR      TYPE TABLE OF ZMMT_EE_ZGR      WITH HEADER LINE,
        TG_ZSDT0001_E       TYPE TABLE OF ZSDT0001         WITH HEADER LINE,
        TG_ZMMT_EE_ZGR_DOCS TYPE TABLE OF ZMMT_EE_ZGR_DOCS WITH HEADER LINE,
        WL_ROM              LIKE ZSDT0001,
        WL_DOC              TYPE J_1BNFDOC.

  DATA: V_COUNT_NF_PROP TYPE I,
        V_NFNUM_ROM     TYPE ZSDT0001-NFNUM,
        V_MSG           TYPE STRING,
        V_CANDAT        TYPE J_1BNFDOC-CANDAT.

  CLEAR: C_RETORNO, WL_ROM, V_NFNUM_ROM, V_COUNT_NF_PROP, TG_PARC[], TG_SERIES[],
         WL_DOC, C_DOCNUM, TG_ZMMT_EE_ZGR[], TG_ZMMT_EE_ZGR_DOCS[], TG_ZSDT0001_E[], V_CANDAT.

  "Carregar Parceiros
  PERFORM F_GET_PARCEIROS TABLES TG_PARC
                           USING I_CNPJ
                                 I_CPF.
  "Carregar Serie
  PERFORM F_GET_SERIES TABLES TG_SERIES
                        USING I_SERIE.

  WL_ROM-NFNUM  = |{ I_NUMNF ALPHA = IN }|.
  WL_ROM-DOCDAT = I_DT_EMISSAO.

  LOOP AT TG_PARC WHERE PARTYP = 'V'.
    LOOP AT TG_SERIES.

      WL_ROM-PARID  = TG_PARC-PARID.
      WL_ROM-SERIES = TG_SERIES-SERIE.

      CLEAR: TG_ZSDT0001_E[].

      SELECT *
        FROM ZSDT0001 INTO TABLE TG_ZSDT0001_E
       WHERE DOCDAT          EQ WL_ROM-DOCDAT
         AND TP_MOVIMENTO    EQ 'E'
         AND PARID           EQ WL_ROM-PARID
         AND NFNUM           EQ WL_ROM-NFNUM
         AND SERIES          EQ WL_ROM-SERIES.

      LOOP AT TG_ZSDT0001_E.

        CLEAR: TG_ZMMT_EE_ZGR[], TG_ZMMT_EE_ZGR_DOCS[].

        SELECT *
          FROM ZMMT_EE_ZGR INTO TABLE TG_ZMMT_EE_ZGR
         WHERE CH_REFERENCIA EQ TG_ZSDT0001_E-CH_REFERENCIA.

        CHECK TG_ZMMT_EE_ZGR[] IS NOT INITIAL.

        SELECT *
          FROM ZMMT_EE_ZGR_DOCS INTO TABLE TG_ZMMT_EE_ZGR_DOCS
           FOR ALL ENTRIES IN TG_ZMMT_EE_ZGR
         WHERE OBJ_KEY EQ TG_ZMMT_EE_ZGR-OBJ_KEY.

        LOOP AT TG_ZMMT_EE_ZGR_DOCS WHERE DOCNUM IS NOT INITIAL.

          CLEAR: V_CANDAT, WL_DOC.

          SELECT SINGLE *
            FROM J_1BNFDOC INTO WL_DOC
           WHERE DOCNUM   EQ TG_ZMMT_EE_ZGR_DOCS-DOCNUM
             AND CANDAT   EQ V_CANDAT
             AND CANCEL   EQ SPACE
             AND DOCTYP   IN ('1','2','6').

          CHECK ( SY-SUBRC EQ 0 ) AND ( WL_DOC-ENTRAD EQ ABAP_TRUE ). "Entrada Propria.

          C_DOCNUM = WL_DOC-DOCNUM.

          ADD 1 TO V_COUNT_NF_PROP.
        ENDLOOP.

      ENDLOOP.

    ENDLOOP.
  ENDLOOP.

  IF V_COUNT_NF_PROP > 1.
    IF I_CNPJ IS NOT INITIAL.
      MESSAGE S114 WITH I_NUMNF I_CNPJ INTO V_MSG.
    ELSE.
      MESSAGE S115 WITH I_NUMNF I_CPF  INTO V_MSG.
    ENDIF.

    C_RETORNO-TYPE     = 'E'.
    C_RETORNO-MSGNO    = SY-MSGNO.
    C_RETORNO-TEXTO    = V_MSG.
    RETURN.
  ENDIF.

ENDFUNCTION.
