FUNCTION Z_MEMO_CANCELA.
*"----------------------------------------------------------------------
*"*"Interface local:
*"  IMPORTING
*"     REFERENCE(P_NR_MEMORANDO) TYPE  Z_MEMORANDO
*"----------------------------------------------------------------------

  DATA: WA_MEMORANDO          TYPE ZDOC_MEMORANDO,
        WA_ZDOC_MEMO_NF_EXP   TYPE ZDOC_MEMO_NF_EXP,
        WA_J_1BNFLIN          TYPE J_1BNFLIN,
        WA_VBRP               TYPE VBRP,
        IT_ZDOC_MEMO_NOTA     TYPE TABLE OF ZDOC_MEMO_NOTA INITIAL SIZE 0 WITH HEADER LINE,
        WA_ZDOC_MEMO_NOTA     TYPE ZDOC_MEMO_NOTA,
        IT_DOC_S              TYPE TABLE OF ZDOC_MEMO_NOTA_S INITIAL SIZE 0 WITH HEADER LINE,
        WA_DOC_S              TYPE ZDOC_MEMO_NOTA_S,
        IT_DOC_C              TYPE TABLE OF ZDOC_MEMO_NOTA_C,
        WA_DOC_C              TYPE ZDOC_MEMO_NOTA_C.

  CHECK NOT P_NR_MEMORANDO IS INITIAL.

  REFRESH: IT_ZDOC_MEMO_NOTA.
  CLEAR: WA_MEMORANDO, WA_DOC_S, WA_DOC_C.

  SELECT SINGLE * INTO WA_MEMORANDO
    FROM ZDOC_MEMORANDO
   WHERE NR_MEMORANDO EQ P_NR_MEMORANDO.

  IF SY-SUBRC IS INITIAL.

    WA_MEMORANDO-CANCELADO = C_X.
    MODIFY ZDOC_MEMORANDO FROM WA_MEMORANDO.

    IF WA_MEMORANDO-DIRECAO EQ '1'.

      SELECT * FROM ZDOC_MEMO_NOTA
        INTO TABLE IT_ZDOC_MEMO_NOTA
         WHERE NR_MEMORANDO EQ WA_MEMORANDO-NR_MEMORANDO.

      LOOP AT IT_ZDOC_MEMO_NOTA INTO WA_ZDOC_MEMO_NOTA.
        WA_DOC_C-DIRECAO = WA_MEMORANDO-DIRECAO.
        MOVE-CORRESPONDING WA_ZDOC_MEMO_NOTA TO WA_DOC_C.
        APPEND WA_DOC_C TO IT_DOC_C.
      ENDLOOP.
      INSERT ZDOC_MEMO_NOTA_C FROM TABLE IT_DOC_C.

      DELETE FROM ZDOC_MEMO_NOTA   WHERE NR_MEMORANDO EQ WA_MEMORANDO-NR_MEMORANDO.

      SELECT SINGLE * INTO WA_ZDOC_MEMO_NF_EXP
        FROM ZDOC_MEMO_NF_EXP
       WHERE NR_NOTA_EXP EQ WA_MEMORANDO-NR_NOTA_EXP.

      IF ( SY-SUBRC IS INITIAL ) AND ( NOT WA_ZDOC_MEMO_NF_EXP-DOCNUM IS INITIAL ).

        SELECT SINGLE * INTO WA_J_1BNFLIN
          FROM J_1BNFLIN
         WHERE DOCNUM EQ WA_ZDOC_MEMO_NF_EXP-DOCNUM.

        CHECK SY-SUBRC IS INITIAL.

        WA_VBRP-VBELN = WA_J_1BNFLIN-REFKEY(10).
        WA_VBRP-POSNR = WA_J_1BNFLIN-REFITM.

        SELECT SINGLE * INTO WA_VBRP
          FROM VBRP
         WHERE VBELN EQ WA_VBRP-VBELN
           AND POSNR EQ WA_VBRP-POSNR.

        CHECK SY-SUBRC IS INITIAL.

        SELECT * INTO TABLE IT_ZDOC_MEMO_NOTA
          FROM ZDOC_MEMO_NOTA
         WHERE NR_MEMORANDO EQ P_NR_MEMORANDO.

        LOOP AT IT_ZDOC_MEMO_NOTA INTO WA_ZDOC_MEMO_NOTA.
          DELETE FROM ZDOC_NF_PRODUTOR
           WHERE VBELN       EQ WA_VBRP-VGBEL
             AND DOCNUM_PROD EQ WA_ZDOC_MEMO_NOTA-DOCNUM
             AND ITMNUM_PROD EQ WA_ZDOC_MEMO_NOTA-ITMNUM.
        ENDLOOP.

      ENDIF.

    ELSE.

      SELECT * FROM ZDOC_MEMO_NOTA_S
        INTO TABLE IT_ZDOC_MEMO_NOTA
         WHERE NR_MEMORANDO EQ WA_MEMORANDO-NR_MEMORANDO.
      MOVE IT_ZDOC_MEMO_NOTA[] TO IT_DOC_S[].

      LOOP AT IT_DOC_S INTO WA_DOC_S.
        WA_DOC_C-DIRECAO = WA_MEMORANDO-DIRECAO.
        MOVE-CORRESPONDING WA_DOC_S TO WA_DOC_C.
        APPEND WA_DOC_C TO IT_DOC_C.
      ENDLOOP.
      INSERT ZDOC_MEMO_NOTA_C FROM TABLE IT_DOC_C.

      DELETE FROM ZDOC_MEMO_NOTA_S WHERE NR_MEMORANDO EQ WA_MEMORANDO-NR_MEMORANDO.

    ENDIF.

    COMMIT WORK.

  ENDIF.

ENDFUNCTION.
