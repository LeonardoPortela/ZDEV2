*&---------------------------------------------------------------------*
*& Report  ZMMR019_04
*&
*&---------------------------------------------------------------------*
*&
*&
*&---------------------------------------------------------------------*
REPORT ZMMR019_04.

FORM CHANGE_DOC_TROCA_TEXTO_ITEM TABLES P_IT_ITEMDATA STRUCTURE BAPI_INCINV_CREATE_ITEM
                                USING VG_INVOICEDOCNUMBER_MIRO TYPE BAPI_INCINV_FLD-INV_DOC_NO
                                      VG_ANO_MIRO TYPE BAPI_INCINV_FLD-FISC_YEAR.

  DATA: I_BSEG TYPE BSEG OCCURS 1,
        I_BKPF TYPE BKPF OCCURS 1,
        I_BSEC TYPE BSEC OCCURS 1,
        I_BSED TYPE BSED OCCURS 1,
        I_BSET TYPE BSET OCCURS 1,
        I_BKDF TYPE BKDF OCCURS 1.

  READ TABLE P_IT_ITEMDATA INTO DATA(WA_ITEMDATA) INDEX 1.
  IF WA_ITEMDATA-ITEM_TEXT IS NOT INITIAL.
    WAIT UP TO 2 SECONDS.
    " Troca testo do item do documento contabil
    DATA(VAWKEY) = |{ VG_INVOICEDOCNUMBER_MIRO } { VG_ANO_MIRO }|.
    CONDENSE VAWKEY NO-GAPS.
    SELECT SINGLE * FROM BKPF INTO @DATA(WA_BKPF)
         WHERE AWKEY = @VAWKEY.
    IF SY-SUBRC = 0.
      REFRESH: I_BKPF, I_BSEG.
      APPEND WA_BKPF TO I_BKPF.
      DATA RLDNR_L32C6R5918 TYPE RLDNR.
CALL FUNCTION 'FAGL_GET_LEADING_LEDGER'
  IMPORTING E_RLDNR = RLDNR_L32C6R5918
  EXCEPTIONS NOT_FOUND     = 1
             MORE_THAN_ONE = 2.
IF SY-SUBRC = 0.
CALL FUNCTION 'FAGL_GET_GL_DOCUMENT'
  EXPORTING
    I_RLDNR = RLDNR_L32C6R5918
    I_BUKRS = WA_BKPF-BUKRS
    I_BELNR = WA_BKPF-BELNR
    I_GJAHR = WA_BKPF-GJAHR
    IT_WHERE_CLAUSE = VALUE TT_RSDSWHERE( ( |BSCHL = '31'| ) )
  IMPORTING
    ET_BSEG = I_BSEG
  EXCEPTIONS NOT_FOUND = 1.
ENDIF.
IF SY-SUBRC <> 0 OR LINES( I_BSEG ) = 0.
  SY-SUBRC = 4.
  SY-DBCNT = 0.
ELSE.
  SY-DBCNT = LINES( I_BSEG ).
ENDIF.


      LOOP AT I_BSEG INTO DATA(WA_BSEG).
        WA_BSEG-SGTXT = WA_ITEMDATA-ITEM_TEXT.
        MODIFY I_BSEG FROM WA_BSEG.
      ENDLOOP.

      CALL FUNCTION 'CHANGE_DOCUMENT'
        TABLES
          T_BKDF = I_BKDF
          T_BKPF = I_BKPF
          T_BSEC = I_BSEC
          T_BSED = I_BSED
          T_BSEG = I_BSEG
          T_BSET = I_BSET.
      IF SY-SUBRC = 0.
        WAIT UP TO 1 SECONDS.
        CALL FUNCTION 'BAPI_TRANSACTION_COMMIT'
          EXPORTING
            WAIT = 'X'.
        WAIT UP TO 1 SECONDS.
      ENDIF.
    ENDIF.
  ENDIF.

ENDFORM.
