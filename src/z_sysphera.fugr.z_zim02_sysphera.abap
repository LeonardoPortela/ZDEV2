FUNCTION Z_ZIM02_SYSPHERA.
*"--------------------------------------------------------------------
*"*"Interface local:
*"  IMPORTING
*"     REFERENCE(I_ANO) TYPE  GJAHR
*"     REFERENCE(I_MES) TYPE  MONAT
*"     REFERENCE(I_AREA) TYPE  KOKRS
*"  TABLES
*"      RESULTADO STRUCTURE  ZHCME_SYSPHERA_ZIM01
*"      T_CUSTO STRUCTURE  RSPARAMS
*"--------------------------------------------------------------------
  DATA: BEGIN OF T_08 OCCURS 0.
          INCLUDE STRUCTURE ZIM08_REL_INV2.
        DATA: END OF T_08.

  DATA: BEGIN OF T_08_USD OCCURS 0.
          INCLUDE STRUCTURE ZIM08_REL_INV_US.
        DATA: END OF T_08_USD.

  DATA: VDATAI   TYPE SY-DATUM,
        VDATAF   TYPE SY-DATUM,
        WA_ZIM01 TYPE ZHCME_SYSPHERA_ZIM01.

  VDATAI = |{ I_ANO }{ I_MES }01|.
  CALL FUNCTION 'RP_LAST_DAY_OF_MONTHS'
    EXPORTING
      DAY_IN            = VDATAI
    IMPORTING
      LAST_DAY_OF_MONTH = VDATAF.

  SELECT * FROM ZIM08_REL_INV2
         INTO TABLE T_08
         WHERE VISAO  EQ '01'     AND
               AKOSTL IN T_CUSTO  AND
               GJAHR  EQ I_ANO    AND
               AEDAT  BETWEEN VDATAI AND VDATAF.

  SELECT * FROM ZIM08_REL_INV_US
   INTO TABLE T_08_USD
    WHERE VISAO  EQ '01'       AND
            AKOSTL IN T_CUSTO  AND
            GJAHR  EQ I_ANO    AND
            AEDAT  BETWEEN VDATAI AND VDATAF.

  LOOP AT T_08.
    SELECT SINGLE LTEXT FROM CSKT INTO WA_ZIM01-NOME_CENTRO
          WHERE SPRAS EQ SY-LANGU AND
                KOKRS EQ I_AREA   AND
                KOSTL EQ T_08-AKOSTL AND
                DATBI GE SY-DATUM .
    WA_ZIM01-ANO            = T_08-GJAHR.
    WA_ZIM01-MES            = T_08-AEDAT+4(2).
    WA_ZIM01-CENTRO_CUSTO   = T_08-AKOSTL.

    WA_ZIM01-COD_CONTA      = ''.
    WA_ZIM01-NOME_CONTA     = ''.
    WA_ZIM01-COD_ITEM       = T_08-POSNR.
    WA_ZIM01-NOME_ITEM      = 0.
    SELECT SINGLE TXT50 FROM IMAKT
      INTO WA_ZIM01-NOME_ITEM
      WHERE  POSNR = T_08-POSNR
      AND    SPRAS   EQ SY-LANGU.

    WA_ZIM01-COD_COMPRA     = T_08-EBELN.
    WA_ZIM01-ID_SYSPHERA    = 0.
*---> 15/06/2023 - Migração S4 - JS
*    WA_ZIM01-VLR_LOCAL     = T_08-DMBTR.
    WA_ZIM01-VLR_LOCAL = CONV #( T_08-DMBTR ).
*<--- 15/06/2023 - Migração S4 - JS
    WA_ZIM01-VLR_DOLAR      = 0.
    COLLECT WA_ZIM01 INTO RESULTADO.
  ENDLOOP.
  "
  LOOP AT T_08_USD INTO T_08.
    SELECT SINGLE LTEXT FROM CSKT INTO WA_ZIM01-NOME_CENTRO
          WHERE SPRAS EQ SY-LANGU AND
                KOKRS EQ I_AREA   AND
                KOSTL EQ T_08-AKOSTL AND
                DATBI GE SY-DATUM .
    WA_ZIM01-ANO            = T_08-GJAHR.
    WA_ZIM01-MES            = T_08-AEDAT+4(2).
    WA_ZIM01-CENTRO_CUSTO   = T_08-AKOSTL.

    WA_ZIM01-COD_CONTA      = ''.
    WA_ZIM01-NOME_CONTA     = ''.
    WA_ZIM01-COD_ITEM       = T_08-POSNR.
    WA_ZIM01-NOME_ITEM      = 0.
    SELECT SINGLE TXT50 FROM IMAKT
      INTO WA_ZIM01-NOME_ITEM
      WHERE  POSNR = T_08-POSNR
      AND    SPRAS   EQ SY-LANGU.

    WA_ZIM01-COD_COMPRA     = T_08-EBELN.
    WA_ZIM01-ID_SYSPHERA    = 0.
    WA_ZIM01-VLR_LOCAL      = 0.
*---> 15/06/2023 - Migração S4 - JS
*      WA_ZIM01-VLR_DOLAR      = T_08-DMBTR.
    WA_ZIM01-VLR_DOLAR  = CONV #( T_08-DMBTR ).
*<--- 15/06/2023 - Migração S4 - JS
    COLLECT WA_ZIM01 INTO RESULTADO.
  ENDLOOP.

ENDFUNCTION.
