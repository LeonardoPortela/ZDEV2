*&---------------------------------------------------------------------*
*& Report  ZMMR115
*&
*&---------------------------------------------------------------------*
*& Monitor de: Recebimento de XML de NF-e, Pagamento, Escrituração Fiscal,
*& Complemento, Anulação, Substituição
*&---------------------------------------------------------------------*

REPORT ZMMR115 MESSAGE-ID ZNFE_DISTRI.

* Screen data transfer - tables declaration
TABLES: ZIB_NFE_DIST_ITM, ZIB_NFE_DIST_TER, ZFIT0230.

TYPES: BEGIN OF TY_BLOQ.
TYPES:   CHAVE_NFE TYPE ZDE_CHAVE_DOC_E.
TYPES: END OF TY_BLOQ.

TYPES: BEGIN OF TY_TREE,
         NUMERO TYPE I,
         LIFNR  TYPE LIFNR,
         EBELN  TYPE EBELN.
TYPES: END OF TY_TREE.

DATA: MANAGER TYPE REF TO CL_GOS_MANAGER,
      _EBELN  TYPE EBELN,
      _EBELP  TYPE EBELP.

CLASS LCL_ALV_TOOLBAR_LOG DEFINITION.
  PUBLIC SECTION.
*Constructor
    METHODS:
      CONSTRUCTOR         IMPORTING IO_ALV_GRID TYPE REF TO CL_GUI_ALV_GRID,
      ON_TOOLBAR          FOR EVENT TOOLBAR OF CL_GUI_ALV_GRID IMPORTING E_OBJECT,
      HANDLE_USER_COMMAND FOR EVENT USER_COMMAND OF CL_GUI_ALV_GRID IMPORTING E_UCOMM.
ENDCLASS.                    "lcl_alv_toolbar DEFINITION

DATA: CTL_ALV_NFE                 TYPE REF TO CL_GUI_ALV_GRID,
      CTL_ALV_NFE_HIST            TYPE REF TO CL_GUI_ALV_GRID,
      OBG_TOOLBAR_LOG             TYPE REF TO LCL_ALV_TOOLBAR_LOG,
      TOOLBARMANAGER_LOG          TYPE REF TO CL_ALV_GRID_TOOLBAR_MANAGER,
      "CTL_CCCONTAINER             TYPE REF TO CL_GUI_CUSTOM_CONTAINER,
      DG_SPLITTER_P               TYPE REF TO CL_GUI_SPLITTER_CONTAINER,
      DG_SPLITTER                 TYPE REF TO CL_GUI_SPLITTER_CONTAINER,
      CTL_CCCONTAINER_TREE        TYPE REF TO CL_GUI_CONTAINER,
      CTL_CCCONTAINER_NFE_INBOUND TYPE REF TO CL_GUI_CONTAINER,
      CTL_CCCONTAINER2            TYPE REF TO CL_GUI_CONTAINER,
      CTL_CCCONTAINER3            TYPE REF TO CL_GUI_CONTAINER.

DATA: GS_LAYOUT   TYPE LVC_S_LAYO,
      GS_VARIANT  TYPE DISVARIANT,
      GS_VARIANT2 TYPE DISVARIANT,
      GS_LAYOUT2  TYPE LVC_S_LAYO.

DATA: IT_FIELDCATALOG TYPE LVC_T_FCAT,
      WA_FIELDCATALOG TYPE LVC_S_FCAT.

DATA: IT_FIELDCATALOG2 TYPE LVC_T_FCAT,
      WA_FIELDCATALOG2 TYPE LVC_S_FCAT.

DATA: IT_EXCEPT_QINFO TYPE LVC_T_QINF,
      WA_EXCEPT_QINFO TYPE LVC_S_QINF.

DATA: IT_EXCLUDE_FCODE TYPE UI_FUNCTIONS,
      WA_EXCLUDE_FCODE LIKE LINE OF IT_EXCLUDE_FCODE.

DATA: GS_SCROLL_COL TYPE LVC_S_COL,
      GS_SCROLL_ROW TYPE LVC_S_ROID.

DATA: GS_SCROLL_COL2 TYPE LVC_S_COL,
      GS_SCROLL_ROW2 TYPE LVC_S_ROID.

DATA: OBJ_NFE TYPE REF TO ZCL_REPOSITORY_CLASSES.

DATA: NFE_INBOUND_EXCEPTION  TYPE REF TO ZCX_NFE_INBOUND_EXCEPTION.
DATA: NFE_PEDIDO_COMPRA      TYPE REF TO ZCX_PEDIDO_COMPRA_EXCEPTION.
DATA: NFE_CADASTRO_EXCEPTION TYPE REF TO ZCX_CADASTRO.

DATA: CK_LOG_ATIVO           TYPE C LENGTH 1.

************************************************************************
* DATA DEFINITION
************************************************************************
DATA: BEGIN OF WA_NFE_ALV.
        INCLUDE STRUCTURE ZDE_NFE_DIST_ALV.
DATA: END OF WA_NFE_ALV.

DATA: BEGIN OF WA_LOG_ALV,
        IC_MESSAGE TYPE ZDE_ICON_ST,
        IC_TEXTO   TYPE ZDE_ICON_ESTRATEGIA.
        INCLUDE STRUCTURE ZIB_NFE_DIST_LOG.
DATA: END OF WA_LOG_ALV.

DATA: OK_CODE           TYPE SY-UCOMM,
      OK_CODE_0300      TYPE SYST_UCOMM,               "*-CS2025000249-08.04.2025-#173180-JT
      LV_CONF_PED_MASSA TYPE CHAR01,                   "*-CS2025000249-08.04.2025-#173180-JT
      LV_EBELN          TYPE EKPO-EBELN,               "*-CS2025000249-08.04.2025-#173180-JT
      LV_EBELP          TYPE EKPO-EBELP,               "*-CS2025000249-08.04.2025-#173180-JT
      IT_NFE_ALV        LIKE TABLE OF WA_NFE_ALV WITH KEY CHAVE_NFE,
      IT_NFE_SELECT     LIKE TABLE OF WA_NFE_ALV WITH HEADER LINE,
      IT_LOG_ALV        LIKE TABLE OF WA_LOG_ALV WITH KEY CHAVE_NFE DT_ATUALIZACAO HR_ATUALIZACAO NR_SEQUENCIA,
      IT_NFE_SELECTW    TYPE TABLE OF ZDE_NFE_DIST_ALV WITH HEADER LINE,
      WA_NFE_DIST       TYPE ZIB_NFE_DIST_TER,
      WA_ZMMT0149       TYPE ZMMT0149,
      IT_NFE_DIST       TYPE TABLE OF ZIB_NFE_DIST_TER WITH HEADER LINE,
      IT_NFE_ITENS      TYPE TABLE OF ZIB_NFE_DIST_ITM WITH HEADER LINE,
      IT_ZMMT0149       TYPE TABLE OF ZMMT0149 WITH HEADER LINE,
      IT_NFE            TYPE ZIB_NFE_DIST_TER_T,
      IT_TREE           TYPE TABLE OF TY_TREE WITH HEADER LINE.

DATA: IT_SELECTED_ROWS TYPE LVC_T_ROW,
      WA_SELECTED_ROWS TYPE LVC_S_ROW.

DATA: OK_VISAO         TYPE SY-UCOMM.

CONSTANTS:
  OK_REFRESH      TYPE SY-UCOMM VALUE 'REFRESH',
  OK_VISNFE       TYPE SY-UCOMM VALUE 'VISNFE',
  OK_ANEXAR       TYPE SY-UCOMM VALUE 'ANEXAR',
  OK_REINICIAR    TYPE SY-UCOMM VALUE 'REINICIAR',
  OK_ACEITE       TYPE SY-UCOMM VALUE 'ACEITE',
  OK_ACEITE_MASSA TYPE SY-UCOMM VALUE 'ACEITE_MASSA', "*-CS2025000249-08.04.2025-#173180-JT
  OK_FISICO       TYPE SY-UCOMM VALUE 'FISICO',
  OK_PROGRAMAR    TYPE SY-UCOMM VALUE 'PROGRAMAR',
  "OK_ESTORNAR   TYPE SY-UCOMM VALUE 'ESTORNAR',
  OK_BACK         TYPE SY-UCOMM VALUE 'BACK',
  OK_EXIT         TYPE SY-UCOMM VALUE 'EXIT',
  OK_CANCEL       TYPE SY-UCOMM VALUE 'CANCEL',
  OK_VS_NFEIN     TYPE SY-UCOMM VALUE 'VS_NFEIN',   "Visão NF-e InBound
  OK_VS_FORNECE   TYPE SY-UCOMM VALUE 'VS_FORNECE', "Visão Fornecedores
  OK_VS_PEDIDOS   TYPE SY-UCOMM VALUE 'VS_PEDIDOS', "Visão Pedidos de ...
  OK_LOG_APROV    TYPE SY-UCOMM VALUE 'LOG_APROVA',
  OK_ESTRAT       TYPE SY-UCOMM VALUE 'ESTRATEGIA'.

*&--------------------------------------------------------------------&*
*& DATA ESTRATÉGIA                                                    &*
*&--------------------------------------------------------------------&*
DATA: GRID2               TYPE REF TO CL_GUI_ALV_GRID,
      OBG_CONTEINER_ESTRA TYPE REF TO CL_GUI_CUSTOM_CONTAINER,
      G_CC_ESTRA          TYPE SCRFNAME VALUE 'CC_ESTRA',
      T_FIELDCATALOG      TYPE LVC_T_FCAT,
      W_FIELDCATALOG      TYPE LVC_S_FCAT.


DATA: TG_ESTRA  TYPE TABLE OF ZMMT0150, "zmm_estrategia_taxa,
      TG_ESTRA2 TYPE TABLE OF ZMMT0150,
      WG_ESTRA2 TYPE ZMMT0150,
      WG_ESTRA  TYPE ZMMT0150, "zmm_estrategia_taxa,
      T_DOCS    TYPE TABLE OF ZIB_NFE_DIST_TER,
      W_DOCS    TYPE          ZIB_NFE_DIST_TER.

*&--------------------------------------------------------------------&*
*& Classes Locais                                                     &*
*&--------------------------------------------------------------------&*

*---------- Definition -----------------------------------------------*
CLASS LCL_EVENT_HANDLER DEFINITION.
  PUBLIC SECTION.
    METHODS HANDLE_HOTSPOT_CLICK FOR EVENT HOTSPOT_CLICK OF CL_GUI_ALV_GRID IMPORTING E_COLUMN_ID ES_ROW_NO.
    METHODS HANDLE_DOUBLE_CLICK  FOR EVENT DOUBLE_CLICK  OF CL_GUI_ALV_GRID IMPORTING E_ROW E_COLUMN ES_ROW_NO.
ENDCLASS.                    "lcl_event_handler DEFINITION

CLASS LCL_EVENT_HANDLER_LOG DEFINITION.
  PUBLIC SECTION.
    METHODS HANDLE_HOTSPOT_CLICK FOR EVENT HOTSPOT_CLICK OF CL_GUI_ALV_GRID IMPORTING E_COLUMN_ID ES_ROW_NO.
ENDCLASS.                    "lcl_event_handler DEFINITION

DATA: EVENT_HANDLER      TYPE REF TO LCL_EVENT_HANDLER.

DATA: EVENT_HANDLER_LOG  TYPE REF TO LCL_EVENT_HANDLER_LOG.

*---------- Implementation -------------------------------------------*
CLASS LCL_EVENT_HANDLER IMPLEMENTATION.
  METHOD HANDLE_HOTSPOT_CLICK.
    PERFORM HANDLE_HOTSPOT_CLICK USING ES_ROW_NO-ROW_ID E_COLUMN_ID-FIELDNAME.
  ENDMETHOD.                    "handle_hotspot_click

  METHOD HANDLE_DOUBLE_CLICK.
    PERFORM HANDLE_DOUBLE_CLICK USING E_ROW.
  ENDMETHOD.                    "HANDLE_DOUBLE_CLICK

ENDCLASS.                    "lcl_event_handler IMPLEMENTATION

CLASS LCL_EVENT_HANDLER_LOG IMPLEMENTATION.
  METHOD HANDLE_HOTSPOT_CLICK.
    PERFORM HANDLE_HOTSPOT_CLICK_LOG USING ES_ROW_NO-ROW_ID E_COLUMN_ID-FIELDNAME.
  ENDMETHOD.                    "handle_hotspot_click

ENDCLASS.                    "lcl_event_handler IMPLEMENTATION

CLASS LCL_ALV_TOOLBAR_LOG IMPLEMENTATION.

  METHOD CONSTRUCTOR.
*   Create ALV toolbar manager instance
    CREATE OBJECT TOOLBARMANAGER_LOG
      EXPORTING
        IO_ALV_GRID = IO_ALV_GRID.

  ENDMETHOD.                    "constructor

  METHOD ON_TOOLBAR.

    DATA: TY_TOOLBAR   TYPE STB_BUTTON.

    "Separador
    TY_TOOLBAR-BUTN_TYPE = 3.
    APPEND TY_TOOLBAR TO E_OBJECT->MT_TOOLBAR.
    CLEAR TY_TOOLBAR.

    "Marcar Todos os Documentos
    TY_TOOLBAR-ICON      = ICON_CLOSE.
    TY_TOOLBAR-FUNCTION  = 'OCULTAR'.
    TY_TOOLBAR-QUICKINFO = TEXT-013.
    TY_TOOLBAR-BUTN_TYPE = 0.
    TY_TOOLBAR-DISABLED  = ABAP_FALSE.
    APPEND TY_TOOLBAR TO E_OBJECT->MT_TOOLBAR.
    CLEAR TY_TOOLBAR.

    CALL METHOD TOOLBARMANAGER_LOG->REORGANIZE
      EXPORTING
        IO_ALV_TOOLBAR = E_OBJECT.

  ENDMETHOD.                    "on_toolbar

  METHOD HANDLE_USER_COMMAND.
    CASE E_UCOMM.
      WHEN 'OCULTAR'.
        PERFORM OCULTAR_LOG .
    ENDCASE.
  ENDMETHOD. "zm_handle_user_command

ENDCLASS.                    "LCL_ALV_TOOLBAR_N55 IMPLEMENTATION

************************************************************************
* SELECTION CRITERIA**                                                 *
************************************************************************

"Informações de Status de Documentos
SELECTION-SCREEN BEGIN OF BLOCK NFE01 WITH FRAME TITLE TEXT-001.
  SELECT-OPTIONS: STDOC FOR ZIB_NFE_DIST_TER-ST_DOCUMENTO NO INTERVALS,
                  STFIS FOR ZIB_NFE_DIST_TER-ST_FISCAL NO INTERVALS,
                  STFIC FOR ZIB_NFE_DIST_TER-ST_FISICO NO INTERVALS,
                  STARM FOR ZIB_NFE_DIST_TER-ST_ARMAZEM NO INTERVALS.
SELECTION-SCREEN END OF BLOCK NFE01.

**-CS2025000249-02.05.2025-#174115-JT-inicio
SELECTION-SCREEN BEGIN OF BLOCK NFE07 WITH FRAME TITLE TEXT-020.
  PARAMETERS    : PDDETON  RADIOBUTTON GROUP GR1,
                  PDDETOFF RADIOBUTTON GROUP GR1,
                  PDDETALL RADIOBUTTON GROUP GR1 DEFAULT 'X'.
SELECTION-SCREEN END OF BLOCK NFE07.
**-CS2025000249-02.05.2025-#174115-JT-fim

* PARAMETERS: NF-e Data
"Informações do Conhecimento de Transporte
*SELECTION-SCREEN BEGIN OF BLOCK nfe05 WITH FRAME TITLE text-012.
*SELECT-OPTIONS: depart FOR zib_nfe_dist_ter-cd_departamento NO INTERVALS NO-EXTENSION OBLIGATORY.
*SELECTION-SCREEN END OF BLOCK nfe05.

* PARAMETERS: NF-e Data
"Informações do Conhecimento de Transporte
SELECTION-SCREEN BEGIN OF BLOCK NFE03 WITH FRAME TITLE TEXT-007.
  SELECT-OPTIONS: DOCNUM FOR ZIB_NFE_DIST_TER-DOCNUM_NFE,
                  NUMRCT FOR ZIB_NFE_DIST_TER-NUMERO,
                  DTEMIT FOR ZIB_NFE_DIST_TER-DT_EMISSAO, "DEFAULT SY-DATUM,
                  CHAVEN FOR ZFIT0230-CHAVE_ACESSO. "US #172277 - MMSILVA - 28.03.2025
*                  chaven FOR zib_nfe_dist_ter-chave_nfe. "US #172277 - MMSILVA - 28.03.2025 - Comentado devido nova formatação
  PARAMETER: CK_CANC AS CHECKBOX.
SELECTION-SCREEN END OF BLOCK NFE03.

"Informações dos Parceiros
SELECTION-SCREEN BEGIN OF BLOCK NFE04 WITH FRAME TITLE TEXT-008.
  SELECT-OPTIONS: ETOMAD FOR ZIB_NFE_DIST_TER-E_TOMADORA NO INTERVALS NO-EXTENSION OBLIGATORY MEMORY ID BUK,
                  FTOMAD FOR ZIB_NFE_DIST_TER-F_TOMADORA NO INTERVALS NO-EXTENSION OBLIGATORY MEMORY ID GSB,
                  PTOMAD FOR ZIB_NFE_DIST_TER-P_EMISSOR,
                  EMCNPJ FOR ZIB_NFE_DIST_TER-FORNE_CNPJ,
                  EMINSC FOR ZIB_NFE_DIST_TER-FORNE_IE.
SELECTION-SCREEN END OF BLOCK NFE04.

SELECTION-SCREEN BEGIN OF BLOCK NFE06 WITH FRAME TITLE TEXT-014.
  SELECT-OPTIONS: IPRODD FOR ZIB_NFE_DIST_ITM-PROD_DESCRICAO,
                  IPRNCM FOR ZIB_NFE_DIST_ITM-PROD_NCM,
                  IPCFOP FOR ZIB_NFE_DIST_ITM-PROD_CFOP,
                  IPICM  FOR ZIB_NFE_DIST_ITM-ICMS_CST,
                  IPIPI  FOR ZIB_NFE_DIST_ITM-IPI_CST,
                  IPPIS  FOR ZIB_NFE_DIST_ITM-PIS_CST,
                  IPCOF  FOR ZIB_NFE_DIST_ITM-COF_CST.
SELECTION-SCREEN END OF BLOCK NFE06.

DATA:
  GF_AUTHORIZATION_FT_09 TYPE C. "Workflow de Documentos

INCLUDE ZMMR115_0100.
INCLUDE ZMMR115_0300.  "*-CS2025000249-08.04.2025-#173180-JT

INITIALIZATION.

  IF OK_VISAO IS INITIAL.
    OK_VISAO = OK_VS_FORNECE.
  ENDIF.

  GF_AUTHORIZATION_FT_09 = ABAP_FALSE.

  AUTHORITY-CHECK OBJECT 'ZNFE_INB' ID 'ZANFETER'   FIELD '09'
                                    ID 'ZNFETERMEP' FIELD ETOMAD-LOW
                                    ID 'ZNFETERFIL' FIELD FTOMAD-LOW.
*                                    ID 'ZNFETERDEP' FIELD depart-low.
  IF SY-SUBRC IS INITIAL.
    GF_AUTHORIZATION_FT_09 = ABAP_TRUE.
  ENDIF.


AT SELECTION-SCREEN.

  AUTHORITY-CHECK OBJECT 'ZNFE_INB' ID 'ZANFETER'   FIELD '00'
                                    ID 'ZNFETERMEP' FIELD ETOMAD-LOW
                                    ID 'ZNFETERFIL' FIELD FTOMAD-LOW.
*                                    ID 'ZNFETERDEP' FIELD depart-low.
  IF SY-SUBRC IS NOT INITIAL.
    "045  Sem Acesso Obj. ZNFE_IN Campo ZANFETER: &1 ZNFETERMEP: &2 ZNFETERDEP: &3
    MESSAGE E045 WITH '00' ETOMAD-LOW FTOMAD-LOW . "depart-low.
  ENDIF.

* US #172277 - MMSILVA - 28.03.2025 - Inicio
  LOOP AT CHAVEN.
    REPLACE ALL OCCURRENCES OF REGEX '[^\d]' IN CHAVEN-LOW WITH ''.
    CONDENSE CHAVEN-LOW NO-GAPS.
    MODIFY CHAVEN.
  ENDLOOP.
* US #172277 - MMSILVA - 28.03.2025 - Fim

START-OF-SELECTION.

  IF OBJ_NFE IS INITIAL.
    CREATE OBJECT OBJ_NFE.
    OBJ_NFE->NFE_INBOUND( ).
  ENDIF.

  PERFORM PESQUISAR_NOTAS_FISCAIS.

  "PERFORM APRESENTAR_INFORMACAO.

END-OF-SELECTION.

  CALL SCREEN '0100'.
*&---------------------------------------------------------------------*
*& Form refresh_all
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM REFRESH_ALL .
  PERFORM PESQUISAR_NOTAS_FISCAIS.
  IF OK_VISAO EQ OK_VS_NFEIN.
    PERFORM APRESENTAR_INFORMACAO.
    PERFORM ATUALIZA_TELA.
  ELSE.
    PERFORM LIMPAR_CONTROLES_TELA USING ABAP_FALSE.
  ENDIF.
ENDFORM.
